<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Business Dashboard</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
  body{background:#f5f7fa;color:#2c3e50;line-height:1.6;padding-top:120px;} /* Padding for fixed header+nav - will be updated by JS */
  
  .container{max-width:1400px;margin:0 auto;padding:20px;}
  
  /* Fixed Header */
  .header{position:fixed;top:0;left:0;right:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;box-shadow:0 4px 15px rgba(0,0,0,0.2);min-height:70px;}
  .header h1{font-size:1.5rem;font-weight:600;letter-spacing:0.5px;margin:0;}
  .header p{font-size:0.85rem;margin:5px 0 0 0;opacity:0.9;}
  .header button{background:rgba(255,255,255,0.2);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.3s;font-size:0.9rem;white-space:nowrap;}
  .header button:hover{background:rgba(255,255,255,0.3);}
  .header > div{display:flex;flex-direction:column;}
  .header > div:last-child{display:flex;gap:8px;flex-direction:row;align-items:center;}
  
  /* Fixed Navigation */
  nav{position:fixed;top:70px;left:0;right:0;z-index:999;display:flex;gap:8px;background:#fff;padding:8px 20px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow-x:auto;-webkit-overflow-scrolling:touch;min-height:50px;align-items:center;transition:top 0.3s ease;}
  nav::-webkit-scrollbar{height:4px;}
  nav::-webkit-scrollbar-track{background:#f1f1f1;}
  nav::-webkit-scrollbar-thumb{background:#888;border-radius:2px;}
  nav button{flex:1;min-width:120px;padding:10px 16px;background:#ecf0f1;color:#34495e;border:none;border-radius:8px;cursor:pointer;transition:all 0.3s;font-weight:500;font-size:0.9rem;white-space:nowrap;}
  nav button:hover{background:#d5dbdb;transform:translateY(-2px);}
  nav button.active{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.4);}
  
  /* Cards */
  .cards{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:20px;margin-bottom:30px;}
  .card{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.08);text-align:center;transition:all 0.3s;border-top:4px solid;}
  .card:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,0.12);}
  .card:nth-child(1){border-top-color:#1abc9c;}
  .card:nth-child(2){border-top-color:#3498db;}
  .card:nth-child(3){border-top-color:#e67e22;}
  .card:nth-child(4){border-top-color:#9b59b6;}
  .card h2{font-size:2.5rem;font-weight:700;margin:10px 0;color:#2c3e50;}
  .card p{font-size:0.95rem;color:#7f8c8d;font-weight:500;text-transform:uppercase;letter-spacing:1px;}
  
  /* Dashboard Charts Section */
  .dashboard-section{background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.08);margin-bottom:25px;}
  .dashboard-section h2{font-size:1.5rem;color:#2c3e50;margin-bottom:25px;font-weight:600;border-bottom:2px solid #ecf0f1;padding-bottom:10px;}
  .charts-container{display:grid;grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));gap:30px;margin-top:20px;}
  .chart-wrapper{background:#f8f9fa;padding:25px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);min-height:350px;display:flex;flex-direction:column;}
  .chart-wrapper h3{font-size:1.2rem;color:#2c3e50;margin-bottom:8px;font-weight:600;}
  .chart-wrapper p{font-size:0.9rem;color:#7f8c8d;margin-bottom:15px;}
  .chart-wrapper canvas{max-width:100% !important;flex:1;min-height:250px;}
  
  /* Activity Cards */
  .activity-card{background:#f8f9fa;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
  .activity-item{background:#fff;padding:12px;margin-bottom:10px;border-radius:8px;border-left:3px solid #667eea;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s;}
  .activity-item:hover{transform:translateX(5px);box-shadow:0 2px 6px rgba(0,0,0,0.15);}
  .activity-item:last-child{margin-bottom:0;}
  .activity-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
  .activity-item-title{font-weight:600;color:#2c3e50;font-size:0.95rem;}
  .activity-item-date{font-size:0.8rem;color:#7f8c8d;}
  .activity-item-details{font-size:0.85rem;color:#7f8c8d;margin-top:5px;}
  
  /* Date Filters */
  .date-filter-section{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.08);margin-bottom:25px;}
  .date-filter-row{display:flex;gap:15px;align-items:end;flex-wrap:wrap;}
  .date-filter-group{flex:1;min-width:200px;}
  .date-filter-group label{display:block;margin-bottom:8px;font-weight:500;color:#34495e;font-size:0.9rem;}
  .date-filter-group input{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:0.95rem;transition:all 0.3s;}
  .date-filter-group input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);outline:none;}
  .date-filter-actions{display:flex;gap:10px;}
  .date-filter-actions button{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s;}
  .date-filter-actions button.clear-btn{background:#ecf0f1;color:#34495e;}
  .date-filter-actions button.clear-btn:hover{background:#d5dbdb;}
  
  /* Dashboard Date Range */
  .dashboard-date-range input[type="date"]:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);outline:none;}
  .dashboard-date-range button:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15);}
  
  /* Customer Link */
  .customer-link:hover{text-decoration:underline !important;}
  
  /* Tab Content */
  .tab-content{background:#fff;padding:30px;border-radius:12px;min-height:400px;box-shadow:0 4px 15px rgba(0,0,0,0.08);}
  .tab-content h2{font-size:1.5rem;color:#2c3e50;margin-bottom:20px;font-weight:600;}
  .tab-content h3{font-size:1.3rem;color:#34495e;margin:25px 0 15px 0;font-weight:600;}
  
  /* Tables */
  table{width:100%;border-collapse:collapse;margin-top:15px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
  th,td{padding:12px 15px;text-align:left;border-bottom:1px solid #ecf0f1;font-size:0.95rem;}
  th{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;font-weight:600;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;}
  tr:hover{background:#f8f9fa;}
  tr:last-child td{border-bottom:none;}
  
  /* Forms */
  .form-row{display:flex;gap:12px;margin-bottom:15px;flex-wrap:wrap;}
  input, select, textarea{padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:0.95rem;transition:all 0.3s;background:#fff;}
  input:focus, select:focus, textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);}
  button{padding:12px 24px;border:none;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s;box-shadow:0 4px 12px rgba(102,126,234,0.3);}
  button:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(102,126,234,0.4);}
  button:active{transform:translateY(0);}
  
  /* Pagination */
  .pagination{margin-top:20px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
  .pagination button{padding:8px 16px;cursor:pointer;border:none;border-radius:6px;background:#ecf0f1;color:#34495e;font-weight:500;transition:all 0.3s;}
  .pagination button:hover{background:#d5dbdb;}
  .pagination button.active{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.3);}
  
  /* Search Input */
  input[type="text"]{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:0.95rem;margin-bottom:15px;}
  
  /* Messages */
  .error{color:#e74c3c;margin-top:10px;font-size:0.95rem;font-weight:500;padding:12px;background:#fee;border-left:4px solid #e74c3c;border-radius:4px;}
  .success{color:#27ae60;margin-top:10px;font-size:0.95rem;font-weight:500;padding:12px;background:#efe;border-left:4px solid #27ae60;border-radius:4px;}
  
  /* Dark Mode CSS Variables */
  :root {
    --bg-primary: #f5f7fa;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f8f9fa;
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --text-tertiary: #34495e;
    --border-color: #e0e0e0;
    --shadow: rgba(0,0,0,0.08);
    --shadow-hover: rgba(0,0,0,0.12);
  }
  
  [data-theme="dark"] {
    --bg-primary: #1a1a1a;
    --bg-secondary: #2d2d2d;
    --bg-tertiary: #252525;
    --text-primary: #ffd700; /* Golden yellow for primary text */
    --text-secondary: #ffeb3b; /* Bright yellow for secondary text */
    --text-tertiary: #ffc107; /* Amber for tertiary text */
    --text-data: #ffd700; /* Golden yellow for data/numbers */
    --text-label: #ffeb3b; /* Bright yellow for labels */
    --border-color: #555;
    --shadow: rgba(0,0,0,0.3);
    --shadow-hover: rgba(0,0,0,0.5);
  }
  
  [data-theme="dark"] body {
    background: var(--bg-primary);
    color: var(--text-primary);
  }
  
  [data-theme="dark"] .card,
  [data-theme="dark"] .tab-content,
  [data-theme="dark"] .dashboard-section,
  [data-theme="dark"] .date-filter-section,
  [data-theme="dark"] .activity-card,
  [data-theme="dark"] table {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }
  
  [data-theme="dark"] nav {
    background: var(--bg-secondary);
    box-shadow: 0 2px 10px var(--shadow);
  }
  
  [data-theme="dark"] nav button {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }
  
  [data-theme="dark"] input,
  [data-theme="dark"] select,
  [data-theme="dark"] textarea {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: var(--border-color);
  }
  
  [data-theme="dark"] .card h2 {
    color: var(--text-data) !important; /* Golden yellow for numbers */
    font-weight: 700;
  }
  
  [data-theme="dark"] .card p,
  [data-theme="dark"] .dashboard-section h2,
  [data-theme="dark"] .chart-wrapper h3,
  [data-theme="dark"] h1,
  [data-theme="dark"] h2,
  [data-theme="dark"] h3 {
    color: var(--text-label); /* Bright yellow for labels */
  }
  
  [data-theme="dark"] .chart-wrapper,
  [data-theme="dark"] .activity-item {
    background: var(--bg-secondary);
  }
  
  [data-theme="dark"] tr:hover {
    background: var(--bg-tertiary);
  }
  
  [data-theme="dark"] th,
  [data-theme="dark"] td {
    color: var(--text-primary);
  }
  
  [data-theme="dark"] .activity-item-title {
    color: var(--text-label);
  }
  
  [data-theme="dark"] input::placeholder,
  [data-theme="dark"] textarea::placeholder {
    color: var(--text-secondary);
    opacity: 0.7;
  }
  
  /* Toast Notifications */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    min-width: 300px;
    max-width: 500px;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    background: var(--bg-secondary);
    color: var(--text-primary);
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s ease;
  }
  
  .toast.show {
    transform: translateX(0);
    opacity: 1;
  }
  
  .toast-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .toast-icon {
    font-size: 1.2rem;
    font-weight: bold;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
  }
  
  .toast-success .toast-icon {
    background: #d4edda;
    color: #155724;
  }
  
  .toast-error .toast-icon {
    background: #f8d7da;
    color: #721c24;
  }
  
  .toast-warning .toast-icon {
    background: #fff3cd;
    color: #856404;
  }
  
  .toast-info .toast-icon {
    background: #d1ecf1;
    color: #0c5460;
  }
  
  [data-theme="dark"] .toast-success .toast-icon {
    background: #1e4620;
    color: #81c784;
  }
  
  [data-theme="dark"] .toast-error .toast-icon {
    background: #3d1f1f;
    color: #e57373;
  }
  
  .toast-message {
    flex: 1;
    font-size: 0.95rem;
    line-height: 1.4;
  }
  
  .toast-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    flex-shrink: 0;
  }
  
  .toast-close:hover {
    color: var(--text-primary);
  }
  
  /* Keyboard Shortcuts Modal */
  .keyboard-shortcuts-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .keyboard-shortcuts-modal.show {
    opacity: 1;
  }
  
  .keyboard-shortcuts-content {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }
  
  .keyboard-shortcuts-modal.show .keyboard-shortcuts-content {
    transform: scale(1);
  }
  
  .keyboard-shortcuts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .keyboard-shortcuts-header h2 {
    margin: 0;
    color: var(--text-primary);
  }
  
  .keyboard-shortcuts-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .shortcut-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--bg-tertiary);
    border-radius: 6px;
  }
  
  .shortcut-item span {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }
  
  kbd {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.85rem;
    font-family: monospace;
    color: var(--text-primary);
    box-shadow: 0 2px 4px var(--shadow);
    margin: 0 2px;
  }
  
  /* Tables - Mobile Responsive */
  table{width:100%;border-collapse:collapse;margin-top:15px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05);display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;}
  table thead, table tbody, table tr{display:table;width:100%;table-layout:fixed;}
  table thead{position:sticky;top:0;z-index:10;}
  
  /* Responsive Design */
  @media(max-width:768px){
    body{padding-top:160px;} /* More padding for mobile header */
    .container{padding:10px;}
    .header{padding:12px 15px;}
    .header h1{font-size:1.2rem;}
    .header p{font-size:0.75rem;}
    .header button{padding:6px 12px;font-size:0.85rem;}
    .header > div:last-child{flex-direction:column;gap:5px;}
    
    nav{top:60px;padding:6px 10px;gap:6px;}
    nav button{padding:8px 12px;font-size:0.85rem;min-width:100px;}
    
    .cards{grid-template-columns:repeat(2, 1fr);gap:10px;margin-bottom:20px;}
    .card{padding:15px;}
    .card h2{font-size:2rem;}
    .card p{font-size:0.85rem;}
    
    .charts-container{grid-template-columns:1fr;gap:15px;}
    .chart-wrapper{padding:15px;min-height:300px;}
    
    .dashboard-section{padding:20px;margin-bottom:15px;}
    .dashboard-section h2{font-size:1.3rem;}
    
    .form-row{flex-direction:column;gap:10px;}
    input, select, textarea{width:100%;font-size:16px;} /* Prevents zoom on iOS */
    
    .tab-content{padding:15px;}
    .tab-content h2{font-size:1.3rem;}
    
    table{font-size:0.85rem;}
    th,td{padding:8px 10px;}
    
    .date-filter-row{flex-direction:column;gap:10px;}
    .date-filter-group{width:100%;}
    .date-filter-actions{width:100%;}
    .date-filter-actions button{width:100%;}
    
    .pagination{flex-wrap:wrap;gap:5px;}
    .pagination button{padding:6px 12px;font-size:0.85rem;}
  }
  
  @media(max-width:480px){
    body{padding-top:180px;}
    .header{padding:10px 12px;min-height:50px;}
    .header h1{font-size:1rem;}
    .header button{padding:5px 10px;font-size:0.8rem;}
    
    nav{top:50px;padding:5px 8px;min-height:40px;}
    nav button{padding:6px 10px;font-size:0.8rem;min-width:80px;}
    
    .cards{grid-template-columns:1fr;}
    .card h2{font-size:1.8rem;}
    
    .chart-wrapper{padding:10px;min-height:250px;}
    .chart-wrapper h3{font-size:1rem;}
    
    .container{padding:8px;}
    .tab-content{padding:12px;}
    
    table{font-size:0.8rem;}
    th,td{padding:6px 8px;}
    
    button{padding:10px 16px;font-size:0.9rem;}
  }
  
  /* Landscape Mobile */
  @media(max-width:768px) and (orientation:landscape){
    body{padding-top:140px;}
    nav{top:60px;}
  }

  /* New Features Styles */
  /* Modal Styles */
  .feature-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10002;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    padding: 20px;
  }

  .feature-modal.show {
    opacity: 1;
  }

  .feature-modal-content {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 30px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }

  .feature-modal.show .feature-modal-content {
    transform: scale(1);
  }

  .feature-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
  }

  .feature-modal-header h2 {
    margin: 0;
    color: var(--text-primary);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 4px;
    transition: all 0.3s;
  }

  .modal-close:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  /* File Upload Styles */
  .file-upload-area {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: var(--bg-tertiary);
  }

  .file-upload-area:hover {
    border-color: #667eea;
    background: var(--bg-secondary);
  }

  .file-upload-area.dragover {
    border-color: #667eea;
    background: rgba(102,126,234,0.1);
  }

  .file-upload-input {
    display: none;
  }

  /* Progress Bar */
  .progress-container {
    margin-top: 15px;
  }

  .progress-bar {
    width: 100%;
    height: 20px;
    background: var(--bg-tertiary);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 10px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 0.85rem;
    font-weight: 600;
  }

  /* Filter Preset Styles */
  .filter-preset-card {
    background: var(--bg-tertiary);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
  }

  .filter-preset-card:hover {
    background: var(--bg-secondary);
    box-shadow: 0 2px 8px var(--shadow);
  }

  /* Reminder Card Styles */
  .reminder-card {
    background: var(--bg-secondary);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid #667eea;
    transition: all 0.3s;
  }

  .reminder-card:hover {
    box-shadow: 0 2px 8px var(--shadow);
    transform: translateX(5px);
  }

  .reminder-card.high-priority {
    border-left-color: #e74c3c;
  }

  .reminder-card.medium-priority {
    border-left-color: #f39c12;
  }

  .reminder-card.low-priority {
    border-left-color: #3498db;
  }

  /* Search Results */
  .search-results-section {
    margin-top: 20px;
  }

  .search-result-group {
    margin-bottom: 30px;
  }

  .search-result-group h3 {
    color: var(--text-primary);
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color);
  }

  .search-result-item {
    background: var(--bg-tertiary);
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .search-result-item:hover {
    background: var(--bg-secondary);
    box-shadow: 0 2px 6px var(--shadow);
  }

  /* Widget Customization */
  .widget-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }

  .widget-item {
    background: var(--bg-tertiary);
    padding: 15px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
    transition: all 0.3s;
  }

  .widget-item:hover {
    background: var(--bg-secondary);
    box-shadow: 0 2px 8px var(--shadow);
  }

  .widget-item.dragging {
    opacity: 0.5;
  }

  .widget-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Validation Results */
  .validation-result {
    background: var(--bg-tertiary);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 15px;
  }

  .validation-result.success {
    border-left: 4px solid #27ae60;
  }

  .validation-result.warning {
    border-left: 4px solid #f39c12;
  }

  .validation-result.error {
    border-left: 4px solid #e74c3c;
  }

  /* Email Template Preview */
  .email-preview {
    background: var(--bg-tertiary);
    padding: 20px;
    border-radius: 8px;
    margin-top: 15px;
    border: 1px solid var(--border-color);
  }

  /* Report Status */
  .report-status {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    margin-bottom: 10px;
  }

  .report-status.pending {
    border-left: 4px solid #f39c12;
  }

  .report-status.processing {
    border-left: 4px solid #3498db;
  }

  .report-status.completed {
    border-left: 4px solid #27ae60;
  }

  .report-status.failed {
    border-left: 4px solid #e74c3c;
  }

  /* Audit Log Entry */
  .audit-entry {
    background: var(--bg-tertiary);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid #667eea;
  }

  .audit-entry.create {
    border-left-color: #27ae60;
  }

  .audit-entry.update {
    border-left-color: #3498db;
  }

  .audit-entry.delete {
    border-left-color: #e74c3c;
  }

  .audit-changes {
    margin-top: 10px;
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 6px;
    font-size: 0.9rem;
  }

  .change-item {
    display: flex;
    gap: 10px;
    margin-bottom: 5px;
  }

  .change-before {
    color: #e74c3c;
    text-decoration: line-through;
  }

  .change-after {
    color: #27ae60;
    font-weight: 600;
  }

  /* Responsive for new features */
  @media(max-width:768px){
    .feature-modal-content {
      padding: 20px;
      max-height: 95vh;
    }

    .widget-list {
      grid-template-columns: 1fr;
    }

    .file-upload-area {
      padding: 20px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header" id="mainHeader">
    <h1>Business Dashboard</h1>
    <button onclick="logout()">Logout</button>
  </div>

  <nav>
    <button class="tab-link active" data-tab="dashboard">Dashboard</button>
    <button class="tab-link" data-tab="customers">Customers</button>
    <button class="tab-link" data-tab="bills">Bills</button>
    <button class="tab-link" data-tab="payments">Payments</button>
    <button class="tab-link" data-tab="import">üì• Import</button>
    <button class="tab-link" data-tab="reports">üìä Reports</button>
    <button class="tab-link" data-tab="notifications">üìß Emails</button>
    <button class="tab-link" data-tab="audit">üìã Audit Log</button>
    <button class="tab-link" data-tab="reminders">üîî Reminders</button>
    <button class="tab-link" data-tab="search">üîç Search</button>
    <button class="tab-link" data-tab="customize">‚öôÔ∏è Customize</button>
    <button class="tab-link" data-tab="validation">‚úÖ Validation</button>
  </nav>

  <div class="cards">
    <div class="card">
      <h2 id="custCount">0</h2>
      <p>Customers</p>
    </div>
    <div class="card">
      <h2 id="billCount">0</h2>
      <p>Bills</p>
    </div>
    <div class="card">
      <h2 id="payCount">0</h2>
      <p>Payments</p>
    </div>
    <div class="card" id="totalAmountCard" style="display:none;">
      <h2 id="totalAmount">‚Çπ0</h2>
      <p>Total Amount</p>
    </div>
  </div>

  <!-- Business Information Section (Always Visible) -->
  <div class="business-info-section" id="businessInfoSection" style="background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.08);margin-bottom:25px;display:none;">
    <h2 style="color:#2c3e50;margin-bottom:15px;font-size:1.5rem;font-weight:600;">üìã About Our Business</h2>
    <p id="businessInformation" style="color:#7f8c8d;line-height:1.6;font-size:1rem;white-space:pre-wrap;"></p>
  </div>

  <!-- Upgrade Message for Analytics (If Not Available) -->
  <div id="analyticsUpgradeMessage" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.08);margin-bottom:25px;display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
      <div style="flex:1;min-width:250px;">
        <h3 style="margin:0 0 10px 0;font-size:1.3rem;font-weight:600;">üöÄ Upgrade to Access Advanced Analytics</h3>
        <p style="margin:0;opacity:0.9;font-size:1rem;">Unlock powerful insights with revenue trends, customer growth, top customers analysis, and more detailed charts.</p>
      </div>
      <button onclick="alert('Contact your administrator to upgrade your plan')" style="padding:12px 24px;background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem;transition:all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
        Upgrade Now
      </button>
    </div>
  </div>

  <!-- Date Range Filter for Dashboard -->
  <div class="dashboard-date-range" style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.08);margin-bottom:25px;">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
      <div style="flex:1;min-width:250px;">
        <h3 style="margin:0 0 15px 0;color:#2c3e50;font-size:1.2rem;font-weight:600;">üìÖ Filter Analytics by Date Range</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end;">
          <div style="flex:1;min-width:150px;">
            <label style="display:block;margin-bottom:8px;font-weight:500;color:#34495e;font-size:0.9rem;">From Date</label>
            <input type="date" id="dashboardFromDate" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:0.95rem;transition:all 0.3s;" />
          </div>
          <div style="flex:1;min-width:150px;">
            <label style="display:block;margin-bottom:8px;font-weight:500;color:#34495e;font-size:0.9rem;">To Date</label>
            <input type="date" id="dashboardToDate" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:0.95rem;transition:all 0.3s;" />
          </div>
          <div style="display:flex;gap:10px;">
            <button onclick="applyDashboardDateRange()" style="padding:10px 20px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:500;box-shadow:0 4px 12px rgba(102,126,234,0.3);transition:all 0.3s;">
              üîç Apply Filter
            </button>
            <button onclick="clearDashboardDateRange()" style="padding:10px 20px;background:#ecf0f1;color:#34495e;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s;">
              üóëÔ∏è Clear
            </button>
            <button onclick="setQuickDateRange('today')" style="padding:10px 15px;background:#e3f2fd;color:#1976d2;border:none;border-radius:8px;cursor:pointer;font-weight:500;font-size:0.85rem;transition:all 0.3s;" title="Today">
              Today
            </button>
            <button onclick="setQuickDateRange('week')" style="padding:10px 15px;background:#e3f2fd;color:#1976d2;border:none;border-radius:8px;cursor:pointer;font-weight:500;font-size:0.85rem;transition:all 0.3s;" title="Last 7 Days">
              Week
            </button>
            <button onclick="setQuickDateRange('month')" style="padding:10px 15px;background:#e3f2fd;color:#1976d2;border:none;border-radius:8px;cursor:pointer;font-weight:500;font-size:0.85rem;transition:all 0.3s;" title="Last 30 Days">
              Month
            </button>
          </div>
        </div>
        <div id="dashboardDateRangeInfo" style="margin-top:10px;color:#7f8c8d;font-size:0.85rem;"></div>
      </div>
    </div>
  </div>

  <div class="dashboard-section" id="dashboard-charts">
    <h2>Analytics & Insights</h2>
    <div class="charts-container">
      <div class="chart-wrapper">
        <h3>Financial Overview</h3>
        <p style="color:#7f8c8d;font-size:0.9rem;margin-bottom:15px;">Total bills, payments, and pending amounts</p>
        <canvas id="chart-summary" style="max-height:300px;"></canvas>
      </div>
      <div class="chart-wrapper">
        <h3>Bills by Status</h3>
        <p style="color:#7f8c8d;font-size:0.9rem;margin-bottom:15px;">Distribution of bills across different statuses</p>
        <canvas id="chart-trend" style="max-height:300px;"></canvas>
      </div>
      <div class="chart-wrapper">
        <h3>Payment Trends</h3>
        <p style="color:#7f8c8d;font-size:0.9rem;margin-bottom:15px;">Payment collection over time</p>
        <canvas id="chart-payment-trends" style="max-height:300px;"></canvas>
      </div>
      <div class="chart-wrapper">
        <h3>Payment Methods</h3>
        <p style="color:#7f8c8d;font-size:0.9rem;margin-bottom:15px;">Distribution by payment mode</p>
        <canvas id="chart-payment-modes" style="max-height:300px;"></canvas>
      </div>
      <div class="chart-wrapper">
        <h3>Revenue Growth</h3>
        <p style="color:#7f8c8d;font-size:0.9rem;margin-bottom:15px;">Monthly revenue trend</p>
        <canvas id="chart-revenue-growth" style="max-height:300px;"></canvas>
      </div>
      <div class="chart-wrapper">
        <h3>Customer Growth</h3>
        <p style="color:#7f8c8d;font-size:0.9rem;margin-bottom:15px;">New customers over time</p>
        <canvas id="chart-customer-growth" style="max-height:300px;"></canvas>
      </div>
      <div class="chart-wrapper">
        <h3>Top Customers</h3>
        <p style="color:#7f8c8d;font-size:0.9rem;margin-bottom:15px;">Top 5 customers by revenue</p>
        <canvas id="chart-top-customers" style="max-height:300px;"></canvas>
      </div>
      <div class="chart-wrapper">
        <h3>Bill vs Payment</h3>
        <p style="color:#7f8c8d;font-size:0.9rem;margin-bottom:15px;">Comparison of bills and payments</p>
        <canvas id="chart-bill-payment" style="max-height:300px;"></canvas>
      </div>
    </div>
  </div>

  <!-- Outstanding Balance & Payment Progress Cards -->
  <div class="cards" id="financialCards" style="display:none;margin-bottom:30px;">
    <div class="card" style="border-top-color:#e74c3c;">
      <h2 id="outstandingAmount">‚Çπ0</h2>
      <p>Outstanding Balance</p>
    </div>
    <div class="card" style="border-top-color:#27ae60;">
      <h2 id="paymentProgress">0%</h2>
      <p>Payment Progress</p>
      <div style="margin-top:10px;width:100%;height:8px;background:#ecf0f1;border-radius:4px;overflow:hidden;">
        <div id="progressBar" style="height:100%;background:linear-gradient(90deg, #27ae60, #2ecc71);width:0%;transition:width 0.5s;"></div>
      </div>
    </div>
  </div>

  <!-- Recent Activity Section -->
  <div class="dashboard-section" id="recentActivitySection" style="display:none;">
    <h2>Recent Activity</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin-top:20px;">
      <div class="activity-card">
        <h3 style="font-size:1.1rem;color:#2c3e50;margin-bottom:15px;border-bottom:2px solid #ecf0f1;padding-bottom:10px;">Recent Customers</h3>
        <div id="recentCustomers" style="max-height:200px;overflow-y:auto;"></div>
      </div>
      <div class="activity-card">
        <h3 style="font-size:1.1rem;color:#2c3e50;margin-bottom:15px;border-bottom:2px solid #ecf0f1;padding-bottom:10px;">Recent Bills</h3>
        <div id="recentBills" style="max-height:200px;overflow-y:auto;"></div>
      </div>
      <div class="activity-card">
        <h3 style="font-size:1.1rem;color:#2c3e50;margin-bottom:15px;border-bottom:2px solid #ecf0f1;padding-bottom:10px;">Recent Payments</h3>
        <div id="recentPayments" style="max-height:200px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="tab-content">
    <div id="dashboard-content">
      <div style="text-align:center;padding:40px;color:#7f8c8d;">
        <h2 style="color:#2c3e50;margin-bottom:15px;">Welcome to Business Dashboard</h2>
        <p style="font-size:1.1rem;">View your analytics and insights above, or use the tabs to manage Customers, Bills, and Payments.</p>
      </div>
    </div>
  </div>
</div>

<script src="app.js"></script>
<script>
if(!requireAuthRedirect()){}

const API_CUSTOMERS = `${API_BASE}/Customers`;
const API_BILLS = `${API_BASE}/Bills`;
const API_PAYMENTS = `${API_BASE}/Payments`;
const API_DASHBOARD = `${API_BASE}/dashboard`;
const API_DASHBOARD_BASIC = `${API_BASE}/dashboard/basic`;
const API_DASHBOARD_ANALYTICS = `${API_BASE}/dashboard/analytics`;

// New Feature APIs
const API_IMPORT = `${API_BASE}`;
const API_REPORTS = `${API_BASE}/Reports`;
const API_NOTIFICATIONS = `${API_BASE}/Notifications`;
const API_AUDIT = `${API_BASE}/AuditLogs`;
const API_REMINDERS = `${API_BASE}/Reminders`;
const API_SEARCH = `${API_BASE}/Search`;
const API_FILTERS = `${API_BASE}/Filters`;
const API_VALIDATION = `${API_BASE}/Validation`;

function logout(){ logoutAndRedirect(); }

// Update header with organization name and admin panel button
function updateHeader(){
  const header = document.getElementById('mainHeader');
  if(header){
    const orgName = localStorage.getItem('organizationName') || 'Business Management';
    const userType = localStorage.getItem('userType');
    const isAdmin = userType && (userType.toLowerCase() === 'admin' || userType.toLowerCase() === 'superadmin');
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    
    header.innerHTML = `
      <div>
        <h1>Business Dashboard</h1>
        <p style="margin:5px 0 0 0;opacity:0.9;font-size:0.9rem;">${escapeHtml(orgName)}</p>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button onclick="toggleDarkMode();updateHeader();" style="background:rgba(255,255,255,0.2);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:500;font-size:1.2rem;" title="Toggle Dark Mode">${isDark ? '‚òÄÔ∏è' : 'üåô'}</button>
        ${isAdmin ? `<button onclick="window.location.href='admin.html'" style="background:rgba(255,255,255,0.2);color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:500;">Admin Panel</button>` : ''}
        <button onclick="logout()">Logout</button>
      </div>
    `;
    
    // Update nav position based on actual header height
    setTimeout(() => {
      const headerHeight = header.offsetHeight;
      const nav = document.querySelector('nav');
      if(nav){
        nav.style.top = headerHeight + 'px';
      }
      // Update body padding
      document.body.style.paddingTop = (headerHeight + (nav ? nav.offsetHeight : 50)) + 'px';
    }, 100);
  }
}

// Update header on page load
updateHeader();

// Filter navigation tabs based on available features
function filterNavigationByFeatures(){
  const featureMap = {
    'import': 'CSV_IMPORT',
    'reports': 'ADVANCED_REPORTS',
    'notifications': 'EMAIL_NOTIFICATIONS',
    'audit': 'AUDIT_LOG',
    'reminders': 'REMINDERS',
    'search': 'ADVANCED_SEARCH',
    'customize': 'DASHBOARD_CUSTOMIZATION',
    'validation': 'DATA_VALIDATION'
  };
  
  // Always show: dashboard, customers, bills, payments
  // Filter premium features
  const availableFeatures = getAvailableFeatures();
  
  Object.keys(featureMap).forEach(tabName => {
    const tab = document.querySelector(`.tab-link[data-tab="${tabName}"]`);
    if(tab){
      const requiredFeature = featureMap[tabName];
      const hasFeatureAccess = hasFeature(requiredFeature);
      if(!hasFeatureAccess){
        tab.style.display = 'none';
      } else {
        tab.style.display = '';
      }
    }
  });
}

// Filter navigation on page load (after a small delay to ensure localStorage is ready)
setTimeout(() => {
  filterNavigationByFeatures();
}, 100);

// Initialize dark mode and keyboard shortcuts
if(typeof initDarkMode === 'function') initDarkMode();
if(typeof initKeyboardShortcuts === 'function') initKeyboardShortcuts();

// Configure Chart.js for dark mode
function configureChartsForDarkMode() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const textColor = isDark ? '#ffd700' : '#7f8c8d';
  const gridColor = isDark ? 'rgba(255, 215, 0, 0.1)' : 'rgba(0,0,0,0.05)';
  
  // Update all existing charts
  const charts = [chartBar, chartLine, chartPaymentTrends, chartPaymentModes, chartRevenueGrowth, chartCustomerGrowth, chartTopCustomers, chartBillPayment];
  charts.forEach(chart => {
    if(chart && chart.options) {
      if(chart.options.scales) {
        Object.keys(chart.options.scales).forEach(scaleKey => {
          const scale = chart.options.scales[scaleKey];
          if(scale.ticks) {
            scale.ticks.color = textColor;
          }
          if(scale.grid) {
            scale.grid.color = gridColor;
          }
        });
      }
      if(chart.options.plugins && chart.options.plugins.legend) {
        if(chart.options.plugins.legend.labels) {
          chart.options.plugins.legend.labels.color = textColor;
        }
      }
      chart.update();
    }
  });
}

// Watch for dark mode changes
const observer = new MutationObserver(() => {
  configureChartsForDarkMode();
});
observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

// Update nav position on window resize
window.addEventListener('resize', () => {
  const header = document.getElementById('mainHeader');
  const nav = document.querySelector('nav');
  if(header && nav){
    const headerHeight = header.offsetHeight;
    nav.style.top = headerHeight + 'px';
    document.body.style.paddingTop = (headerHeight + nav.offsetHeight) + 'px';
  }
});

// ----- Charts -----
let chartBar=null;
let chartLine=null;
let chartPaymentTrends=null;
let chartPaymentModes=null;
let chartRevenueGrowth=null;
let chartCustomerGrowth=null;
let chartTopCustomers=null;
let chartBillPayment=null;

// Dashboard Date Range Filter
let dashboardDateRange = { from: null, to: null };
let allDashboardData = { customers: [], bills: [], payments: [] };

function applyDashboardDateRange(){
  const fromDate = document.getElementById('dashboardFromDate').value;
  const toDate = document.getElementById('dashboardToDate').value;
  dashboardDateRange = { from: fromDate || null, to: toDate || null };
  
  const infoEl = document.getElementById('dashboardDateRangeInfo');
  if(infoEl){
    if(fromDate && toDate){
      infoEl.innerHTML = `üìä Showing data from <strong>${formatDateOnly(fromDate)}</strong> to <strong>${formatDateOnly(toDate)}</strong>`;
    } else if(fromDate){
      infoEl.innerHTML = `üìä Showing data from <strong>${formatDateOnly(fromDate)}</strong> onwards`;
    } else if(toDate){
      infoEl.innerHTML = `üìä Showing data up to <strong>${formatDateOnly(toDate)}</strong>`;
    } else {
      infoEl.innerHTML = 'üìä Showing all data';
    }
  }
  
  updateDashboardCharts();
}

function clearDashboardDateRange(){
  document.getElementById('dashboardFromDate').value = '';
  document.getElementById('dashboardToDate').value = '';
  dashboardDateRange = { from: null, to: null };
  const infoEl = document.getElementById('dashboardDateRangeInfo');
  if(infoEl) infoEl.innerHTML = 'üìä Showing all data';
  updateDashboardCharts();
}

function setQuickDateRange(range){
  const today = new Date();
  let fromDate, toDate;
  
  switch(range){
    case 'today':
      fromDate = new Date(today);
      toDate = new Date(today);
      break;
    case 'week':
      fromDate = new Date(today);
      fromDate.setDate(today.getDate() - 7);
      toDate = new Date(today);
      break;
    case 'month':
      fromDate = new Date(today);
      fromDate.setDate(today.getDate() - 30);
      toDate = new Date(today);
      break;
    default:
      return;
  }
  
  document.getElementById('dashboardFromDate').value = fromDate.toISOString().split('T')[0];
  document.getElementById('dashboardToDate').value = toDate.toISOString().split('T')[0];
  applyDashboardDateRange();
}

function filterDataByDateRange(data, dateField){
  if(!dashboardDateRange.from && !dashboardDateRange.to) return data;
  
  return data.filter(item => {
    const date = item[dateField];
    if(!date) return false;
    const itemDate = new Date(date);
    
    if(dashboardDateRange.from){
      const fromDate = new Date(dashboardDateRange.from);
      fromDate.setHours(0,0,0,0);
      if(itemDate < fromDate) return false;
    }
    
    if(dashboardDateRange.to){
      const toDate = new Date(dashboardDateRange.to);
      toDate.setHours(23,59,59,999);
      if(itemDate > toDate) return false;
    }
    
    return true;
  });
}

function updateDashboardCharts(){
  // Filter data based on date range
  const filteredBills = filterDataByDateRange(allDashboardData.bills, 'billDate || createdAt');
  const filteredPayments = filterDataByDateRange(allDashboardData.payments, 'paymentDate || createdAt');
  
  // Recalculate totals
  const totalBillAmount = filteredBills.reduce((sum, b) => sum + (parseFloat(b.billAmount) || 0), 0);
  
  // Only count cleared payments (Cleared = true) for outstanding calculation
  // Use allocatedAmount from linkedBills if available, otherwise use direct amount
  const totalPaymentAmount = filteredPayments
    .filter(p => {
      // Filter by cleared status
      const isCleared = p.cleared === true || p.cleared === 'true' || (p.mode !== 'Cheque' && p.cleared !== false);
      return isCleared;
    })
    .reduce((sum, p) => {
      // If linkedBills exist, use allocatedAmount from them (this is the actual amount allocated to bills)
      if(p.linkedBills && Array.isArray(p.linkedBills) && p.linkedBills.length > 0){
        // Sum all allocatedAmount from linkedBills
        return sum + p.linkedBills.reduce((lbSum, lb) => {
          // Use allocatedAmount (the actual amount allocated to this bill)
          const allocated = parseFloat(lb.allocatedAmount) || 0;
          return lbSum + allocated;
        }, 0);
      }
      // Otherwise use direct payment amount
      return sum + (parseFloat(p.amount) || 0);
    }, 0);
  
  const pendingAmount = totalBillAmount - totalPaymentAmount;
  
  // Update financial cards
  const outstandingAmountEl = document.getElementById('outstandingAmount');
  const paymentProgressEl = document.getElementById('paymentProgress');
  const progressBarEl = document.getElementById('progressBar');
  
  if(outstandingAmountEl){
    outstandingAmountEl.innerText = '‚Çπ' + pendingAmount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }
  
  // Calculate payment progress: (Total Paid / Total Billed) * 100, capped at 100%
  const paymentProgressPercent = totalBillAmount > 0 ? Math.min(100, Math.round((totalPaymentAmount / totalBillAmount) * 100)) : 0;
  if(paymentProgressEl) paymentProgressEl.innerText = paymentProgressPercent + '%';
  if(progressBarEl) progressBarEl.style.width = paymentProgressPercent + '%';
  
  // Show financial cards
  const financialCardsEl = document.getElementById('financialCards');
  if(financialCardsEl) financialCardsEl.style.display = 'grid';
  
  // Update Financial Overview Chart
  if(chartBar){
    chartBar.data.datasets[0].data = [
      totalBillAmount.toFixed(2),
      totalPaymentAmount.toFixed(2),
      pendingAmount.toFixed(2)
    ];
    chartBar.update();
  }
  
  // Update Bills by Status Chart
  const billsByStatus = {};
  filteredBills.forEach(b => {
    const status = b.status || 'pending';
    billsByStatus[status] = (billsByStatus[status] || 0) + 1;
  });
  
  const statusLabels = Object.keys(billsByStatus);
  const statusData = Object.values(billsByStatus);
  const statusColors = ['#1abc9c', '#3498db', '#e67e22', '#9b59b6', '#f39c12', '#e74c3c'];
  
  if(chartLine){
    chartLine.data.labels = statusLabels.length > 0 ? statusLabels : ['No Data'];
    chartLine.data.datasets[0].data = statusData.length > 0 ? statusData : [1];
    chartLine.data.datasets[0].backgroundColor = statusColors.slice(0, statusLabels.length || 1);
    chartLine.update();
  }
  
  // Update Payment Trends Chart
  const paymentTrendsData = {};
  filteredPayments.forEach(p => {
    const date = p.paymentDate || p.createdAt;
    if(!date) return;
    const dateKey = new Date(date).toISOString().split('T')[0];
    // Use allocatedAmount from linkedBills if available, otherwise use direct amount
    let paymentAmount = parseFloat(p.amount || 0);
    if(p.linkedBills && Array.isArray(p.linkedBills) && p.linkedBills.length > 0){
      paymentAmount = p.linkedBills.reduce((sum, lb) => sum + (parseFloat(lb.allocatedAmount) || 0), 0);
    }
    paymentTrendsData[dateKey] = (paymentTrendsData[dateKey] || 0) + paymentAmount;
  });
  
  const trendLabels = Object.keys(paymentTrendsData).sort().slice(-15);
  const trendAmounts = trendLabels.map(d => paymentTrendsData[d]);
  
  if(chartPaymentTrends){
    chartPaymentTrends.data.labels = trendLabels.map(d => formatDateOnly(d));
    chartPaymentTrends.data.datasets[0].data = trendAmounts;
    chartPaymentTrends.update();
  }
  
  // Update Payment Methods Chart
  const paymentModes = {};
  filteredPayments.forEach(p => {
    const mode = p.mode || 'Unknown';
    paymentModes[mode] = (paymentModes[mode] || 0) + 1;
  });
  
  if(chartPaymentModes){
    chartPaymentModes.data.labels = Object.keys(paymentModes);
    chartPaymentModes.data.datasets[0].data = Object.values(paymentModes);
    chartPaymentModes.update();
  }
}

async function loadDashboard(){
  try{
    // Show loading on cards
    const custCountEl = document.getElementById("custCount");
    const billCountEl = document.getElementById("billCount");
    const payCountEl = document.getElementById("payCount");
    if(custCountEl) custCountEl.innerHTML = '<span class="loading-spinner"></span>';
    if(billCountEl) billCountEl.innerHTML = '<span class="loading-spinner"></span>';
    if(payCountEl) payCountEl.innerHTML = '<span class="loading-spinner"></span>';
    
    // STEP 1: Load Basic Dashboard (Always Available)
    let basicRes;
    try {
      basicRes = await fetchJson(API_DASHBOARD_BASIC, {headers: authHeader()});
    } catch(err) {
      // Check if it's a CORS error
      if(err.message && (err.message.includes('CORS') || err.message.includes('Failed to fetch'))){
        // Show user-friendly error message
        const errorMsg = document.getElementById('dashboardErrorMsg') || (() => {
          const msgEl = document.createElement('div');
          msgEl.id = 'dashboardErrorMsg';
          msgEl.style.cssText = 'background:#fff3cd;border:2px solid #ffc107;padding:15px;border-radius:8px;margin:20px;color:#856404;';
          msgEl.innerHTML = '<strong>‚ö†Ô∏è CORS Error:</strong> Cannot access dashboard API. Please check backend CORS configuration to allow requests from <code>http://localhost:8000</code>';
          const dashboardContent = document.getElementById('dashboard-content');
          if(dashboardContent) dashboardContent.insertBefore(msgEl, dashboardContent.firstChild);
          return msgEl;
        })();
        basicRes = { ok: false, status: 0, data: null, apiResponse: { status: false, message: 'CORS error - cannot access API' } };
      } else {
        logError('API_DASHBOARD_BASIC', err);
        basicRes = { ok: false, status: 500, data: null, apiResponse: { status: false, message: 'Failed to fetch dashboard' } };
      }
    }
    
    // Display Business Information (from Basic Dashboard or localStorage)
    const businessInfoSection = document.getElementById('businessInfoSection');
    const businessInfoEl = document.getElementById('businessInformation');
    
    // Check multiple possible response structures
    let dashboardBasicData = null;
    if(basicRes.ok && basicRes.data){
      dashboardBasicData = basicRes.data;
      // Check if data is nested in 'body' or directly in 'data'
      if(basicRes.data.body){
        dashboardBasicData = basicRes.data.body;
      }
    }
    
    if(dashboardBasicData && dashboardBasicData.businessInformation){
      const businessInfo = dashboardBasicData.businessInformation;
      if(businessInfoEl) businessInfoEl.textContent = businessInfo;
      if(businessInfoSection && businessInfo) businessInfoSection.style.display = 'block';
    } else {
      // Fallback: Get from localStorage (stored during login)
      const businessInfo = getBusinessInformation();
      if(businessInfoEl) businessInfoEl.textContent = businessInfo || 'Welcome to our business management system. Manage your customers, bills, and payments efficiently.';
      if(businessInfoSection) businessInfoSection.style.display = 'block';
    }
    
    // STEP 2: Load Analytics Dashboard (Only if DASHBOARD_ANALYTICS feature is available)
    const hasAnalytics = hasFeature('DASHBOARD_ANALYTICS');
    const chartsSection = document.getElementById('dashboard-charts');
    const upgradeMessage = document.getElementById('analyticsUpgradeMessage');
    
    let dashboardData = {};
    let overview = {};
    let revenueByMonth = [];
    let topCustomers = [];
    let paymentModeSummary = [];
    let billStatusSummary = [];
    
    // Try to extract overview from basic dashboard response first
    if(dashboardBasicData && dashboardBasicData.overview){
      overview = dashboardBasicData.overview;
    }
    
    if(hasAnalytics){
      // User has analytics feature - load analytics dashboard
      if(upgradeMessage) upgradeMessage.style.display = 'none';
      if(chartsSection) chartsSection.style.display = 'block';
      
      let analyticsRes;
      try {
        analyticsRes = await fetchJson(API_DASHBOARD_ANALYTICS, {headers: authHeader()});
      } catch(err) {
        // Check if it's a CORS error
        if(err.message && err.message.includes('CORS') || err.message && err.message.includes('Failed to fetch')){
          analyticsRes = { ok: false, status: 0, data: null, apiResponse: { status: false, message: 'CORS or network error - analytics endpoint not accessible' } };
        } else {
          logError('API_DASHBOARD_ANALYTICS', err);
          analyticsRes = { ok: false, status: 500, data: null, apiResponse: { status: false, message: 'Failed to fetch analytics' } };
        }
      }
      
      if(analyticsRes.ok && analyticsRes.data){
        // Check if data is nested in 'body'
        let analyticsData = analyticsRes.data;
        if(analyticsRes.data.body){
          analyticsData = analyticsRes.data.body;
        }
        
        dashboardData = analyticsData;
        overview = analyticsData.overview || overview || {};
        revenueByMonth = analyticsData.revenueByMonth || [];
        topCustomers = analyticsData.topCustomers || [];
        paymentModeSummary = analyticsData.paymentModeSummary || [];
        billStatusSummary = analyticsData.billStatusSummary || [];
      }
    } else {
      // User doesn't have analytics feature - show upgrade message
      if(upgradeMessage) upgradeMessage.style.display = 'block';
      if(chartsSection) chartsSection.style.display = 'none';
      
      // Use data from basic dashboard if available
      if(dashboardBasicData){
        dashboardData = dashboardBasicData;
        overview = dashboardBasicData.overview || overview || {};
      }
    }

    // If overview is still empty, try to get it from basicRes directly
    if(!overview || Object.keys(overview).length === 0){
      if(dashboardBasicData){
        // Try different possible structures
        overview = dashboardBasicData.overview || dashboardBasicData.body?.overview || dashboardBasicData || {};
      }
    }
    
    // Update summary cards from API overview
    if(custCountEl) custCountEl.innerText = overview.totalCustomers || 0;
    if(billCountEl) billCountEl.innerText = overview.totalBills || 0;
    if(payCountEl) payCountEl.innerText = overview.totalPayments || 0;

    // Use dashboard API data for calculations, but recalculate from actual data if available for accuracy
    let totalBillAmount = overview.totalRevenue || 0;
    let totalPaymentAmount = overview.paidAmount || 0;
    let pendingAmount = overview.outstandingAmount || 0;
    
    // Load actual bills and payments data if not already loaded
    let billsData = allDashboardData?.bills || [];
    let paymentsData = allDashboardData?.payments || [];
    
    // If allDashboardData is empty, try to load data directly
    if((!billsData || billsData.length === 0) || (!paymentsData || paymentsData.length === 0)){
      try {
        const [billsRes, paymentsRes] = await Promise.all([
          fetchJson(API_BILLS, {headers: authHeader()}),
          fetchJson(API_PAYMENTS, {headers: authHeader()})
        ]);
        
        if(billsRes.ok && billsRes.data){
          billsData = (billsRes.data || []).filter(b => (b.isActive === undefined || b.isActive !== false) && (b.IsActive === undefined || b.IsActive !== false) && (b.is_active === undefined || b.is_active !== false));
          allDashboardData.bills = billsData;
        }
        
        if(paymentsRes.ok && paymentsRes.data){
          paymentsData = (paymentsRes.data || []).filter(p => (p.isActive === undefined || p.isActive !== false) && (p.IsActive === undefined || p.IsActive !== false) && (p.is_active === undefined || p.is_active !== false));
          allDashboardData.payments = paymentsData;
        }
      } catch(err) {
        logError('loadBillsPaymentsForCalculation', err);
      }
    }
    
    // Recalculate from actual bills and payments data if available (more accurate)
    if(billsData && billsData.length > 0 && paymentsData){
      // Recalculate total bill amount from actual bills
      const recalculatedBillAmount = billsData.reduce((sum, b) => sum + (parseFloat(b.billAmount) || 0), 0);
      if(recalculatedBillAmount > 0){
        totalBillAmount = recalculatedBillAmount;
      }
      
      // Recalculate total payment amount from actual payments (only cleared payments)
      const recalculatedPaymentAmount = paymentsData
        .filter(p => {
          const isCleared = p.cleared === true || p.cleared === 'true' || (p.mode !== 'Cheque' && p.cleared !== false);
          return isCleared;
        })
        .reduce((sum, p) => {
          if(p.linkedBills && Array.isArray(p.linkedBills) && p.linkedBills.length > 0){
            return sum + p.linkedBills.reduce((lbSum, lb) => {
              const allocated = parseFloat(lb.allocatedAmount) || 0;
              return lbSum + allocated;
            }, 0);
          }
          return sum + (parseFloat(p.amount) || 0);
        }, 0);
      
      totalPaymentAmount = recalculatedPaymentAmount;
      pendingAmount = totalBillAmount - totalPaymentAmount;
    }
    
    // 2. Outstanding Balance & Payment Progress
    const outstandingAmountEl = document.getElementById('outstandingAmount');
    const paymentProgressEl = document.getElementById('paymentProgress');
    const progressBarEl = document.getElementById('progressBar');
    const financialCardsEl = document.getElementById('financialCards');
    
    if(outstandingAmountEl){
      outstandingAmountEl.innerText = '‚Çπ' + pendingAmount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    // Calculate payment progress: (Total Paid / Total Billed) * 100, capped at 100%
    // Only show progress if we have valid bill amount
    const paymentProgressPercent = totalBillAmount > 0 ? Math.min(100, Math.round((totalPaymentAmount / totalBillAmount) * 100)) : 0;
    if(paymentProgressEl) paymentProgressEl.innerText = paymentProgressPercent + '%';
    if(progressBarEl) progressBarEl.style.width = paymentProgressPercent + '%';
    if(financialCardsEl) financialCardsEl.style.display = 'grid';
    
    // Initialize date range info
    const infoEl = document.getElementById('dashboardDateRangeInfo');
    if(infoEl) infoEl.innerHTML = 'üìä Showing all data';
    
    // Show total amount card
    const totalAmountCard = document.getElementById('totalAmountCard');
    const totalAmountEl = document.getElementById('totalAmount');
    if(totalAmountCard && totalAmountEl && totalBillAmount > 0){
      totalAmountCard.style.display = 'block';
      totalAmountEl.innerText = '‚Çπ' + totalBillAmount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Charts section visibility is already handled above based on hasAnalytics
    
    // Only initialize charts if analytics feature is available
    if(!hasAnalytics){
      // Charts section is already hidden, just return
      return;
    }

    // Use billStatusSummary from dashboard API
    const billsByStatus = {};
    if(billStatusSummary && billStatusSummary.length > 0){
      billStatusSummary.forEach(item => {
        billsByStatus[item.status || 'Unknown'] = item.count || 0;
      });
    }

    // Bar Chart - Summary Overview with meaningful data
    const ctxBar=document.getElementById('chart-summary').getContext('2d');
    if(chartBar) chartBar.destroy();
    chartBar=new Chart(ctxBar,{
      type:'bar',
      data:{
        labels:['Total Bills Amount', 'Total Payments', 'Pending Amount'],
        datasets:[{
          label:'Amount (‚Çπ)',
          data:[totalBillAmount.toFixed(2), totalPaymentAmount.toFixed(2), pendingAmount.toFixed(2)],
          backgroundColor:['#3498db','#27ae60','#e67e22'],
          borderRadius:8,
          borderSkipped:false
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:true,
        plugins:{
          legend:{display:false},
          tooltip:{
            backgroundColor:'rgba(0,0,0,0.8)',
            padding:12,
            titleFont:{size:14,weight:'bold'},
            bodyFont:{size:13},
            cornerRadius:8,
            callbacks:{
              label: function(context) {
                return '‚Çπ' + parseFloat(context.parsed.y).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
              }
            }
          }
        },
        scales:{
          y:{
            beginAtZero:true,
            grid:{color:'rgba(0,0,0,0.05)'},
            ticks:{
              font:{size:12},
              color:'#7f8c8d',
              callback: function(value) {
                return '‚Çπ' + value.toLocaleString('en-IN');
              }
            }
          },
          x:{
            grid:{display:false},
            ticks:{font:{size:12},color:'#7f8c8d',font:{weight:'500'}}
          }
        }
      }
    });

    // Pie Chart - Bills by Status (replace line chart with more meaningful data)
    const statusLabels = Object.keys(billsByStatus);
    const statusData = Object.values(billsByStatus);
    const statusColors = ['#1abc9c', '#3498db', '#e67e22', '#9b59b6', '#f39c12', '#e74c3c'];
    
    const ctxLine=document.getElementById('chart-trend').getContext('2d');
    if(chartLine) chartLine.destroy();
    chartLine=new Chart(ctxLine,{
      type:'doughnut',
      data:{
        labels:statusLabels.length > 0 ? statusLabels : ['No Data'],
        datasets:[{
          data:statusData.length > 0 ? statusData : [1],
          backgroundColor:statusColors.slice(0, statusLabels.length || 1),
          borderWidth:3,
          borderColor:'#fff'
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:true,
        plugins:{
          legend:{
            position:'bottom',
            labels:{
              usePointStyle:true,
              padding:15,
              font:{size:12,weight:'500'},
              color:'#34495e'
            }
          },
          tooltip:{
            backgroundColor:'rgba(0,0,0,0.8)',
            padding:12,
            titleFont:{size:14,weight:'bold'},
            bodyFont:{size:13},
            cornerRadius:8,
            callbacks:{
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });

    // Payment Trends Chart (Line Chart) - use dashboard API data if available, otherwise show empty
    let trendLabels = [];
    let trendAmounts = [];
    
    // Try to get payment trends from dashboard API or calculate from revenueByMonth
    if(revenueByMonth && revenueByMonth.length > 0){
      trendLabels = revenueByMonth.slice(-15).map(m => m.monthName || m.month || '');
      trendAmounts = revenueByMonth.slice(-15).map(m => m.revenue || 0);
    }
    
    const ctxPaymentTrends = document.getElementById('chart-payment-trends');
    if(ctxPaymentTrends){
      const ctx = ctxPaymentTrends.getContext('2d');
      if(chartPaymentTrends) chartPaymentTrends.destroy();
      chartPaymentTrends = new Chart(ctx, {
        type: 'line',
        data: {
          labels: trendLabels.map(d => formatDateOnly(d)),
          datasets: [{
            label: 'Payment Amount',
            data: trendAmounts,
            borderColor: '#27ae60',
            backgroundColor: 'rgba(39,174,96,0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              padding: 12,
              callbacks: {
                label: function(context) {
                  return '‚Çπ' + parseFloat(context.parsed.y).toLocaleString('en-IN', {minimumFractionDigits: 2});
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '‚Çπ' + value.toLocaleString('en-IN');
                }
              }
            }
          }
        }
      });
    }
    
    // Payment Methods Chart (Pie Chart) - use dashboard API data
    const paymentModesLabels = [];
    const paymentModesData = [];
    if(paymentModeSummary && paymentModeSummary.length > 0){
      paymentModeSummary.forEach(item => {
        paymentModesLabels.push(item.mode || 'Unknown');
        paymentModesData.push(item.count || 0);
      });
    }
    
    const ctxPaymentModes = document.getElementById('chart-payment-modes');
    if(ctxPaymentModes){
      const ctx = ctxPaymentModes.getContext('2d');
      if(chartPaymentModes) chartPaymentModes.destroy();
      chartPaymentModes = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: paymentModesLabels.length > 0 ? paymentModesLabels : ['No Data'],
          datasets: [{
            data: paymentModesData.length > 0 ? paymentModesData : [1],
            backgroundColor: ['#3498db', '#27ae60', '#e67e22', '#9b59b6', '#f39c12'],
            borderWidth: 3,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: { size: 12, weight: '500' }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((context.parsed / total) * 100).toFixed(1);
                  return `${context.label}: ${context.parsed} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    // Revenue Growth Chart (Line Chart) - use dashboard API data
    let revenueLabels = [];
    let revenueData = [];
    if(revenueByMonth && revenueByMonth.length > 0){
      revenueLabels = revenueByMonth.map(m => m.monthName || m.month || '');
      revenueData = revenueByMonth.map(m => m.revenue || 0);
    }
    
    const ctxRevenueGrowth = document.getElementById('chart-revenue-growth');
    if(ctxRevenueGrowth){
      const ctx = ctxRevenueGrowth.getContext('2d');
      if(chartRevenueGrowth) chartRevenueGrowth.destroy();
      chartRevenueGrowth = new Chart(ctx, {
        type: 'line',
        data: {
          labels: revenueLabels.map(m => new Date(m + '-01').toLocaleDateString('en-US', {month: 'short', year: 'numeric'})),
          datasets: [{
            label: 'Revenue (‚Çπ)',
            data: revenueData,
            borderColor: '#ffd700',
            backgroundColor: 'rgba(255, 215, 0, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: '#ffd700',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              padding: 12,
              callbacks: {
                label: function(context) {
                  return '‚Çπ' + parseFloat(context.parsed.y).toLocaleString('en-IN', {minimumFractionDigits: 2});
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '‚Çπ' + value.toLocaleString('en-IN');
                }
              }
            }
          }
        }
      });
    }
    
    // Customer Growth Chart (Line Chart) - use revenueByMonth data structure (customer count per month)
    let customerLabels = [];
    let customerCounts = [];
    if(revenueByMonth && revenueByMonth.length > 0){
      customerLabels = revenueByMonth.map(m => m.monthName || m.month || '');
      customerCounts = revenueByMonth.map(m => m.customerCount || 0);
    }
    
    const ctxCustomerGrowth = document.getElementById('chart-customer-growth');
    if(ctxCustomerGrowth){
      const ctx = ctxCustomerGrowth.getContext('2d');
      if(chartCustomerGrowth) chartCustomerGrowth.destroy();
      chartCustomerGrowth = new Chart(ctx, {
        type: 'line',
        data: {
          labels: customerLabels.map(m => new Date(m + '-01').toLocaleDateString('en-US', {month: 'short', year: 'numeric'})),
          datasets: [{
            label: 'New Customers',
            data: customerCounts,
            borderColor: '#ffeb3b',
            backgroundColor: 'rgba(255, 235, 59, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: '#ffeb3b',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              padding: 12
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
    
    // Top Customers Chart (Bar Chart) - use dashboard API data
    const topCustomersData = [];
    if(topCustomers && topCustomers.length > 0){
      topCustomers.forEach(c => {
        topCustomersData.push([c.customerName || `Customer ${c.customerId}`, c.totalBillsAmount || 0]);
      });
    }
    const topCustomersChartData = topCustomersData.slice(0, 5);
    
    const ctxTopCustomers = document.getElementById('chart-top-customers');
    if(ctxTopCustomers){
      const ctx = ctxTopCustomers.getContext('2d');
      if(chartTopCustomers) chartTopCustomers.destroy();
      chartTopCustomers = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: topCustomersChartData.map(c => c[0]),
          datasets: [{
            label: 'Revenue (‚Çπ)',
            data: topCustomersChartData.map(c => c[1]),
            backgroundColor: ['#ffd700', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'],
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              padding: 12,
              callbacks: {
                label: function(context) {
                  return '‚Çπ' + parseFloat(context.parsed.x).toLocaleString('en-IN', {minimumFractionDigits: 2});
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '‚Çπ' + value.toLocaleString('en-IN');
                }
              }
            }
          }
        }
      });
    }
    
    // Bill vs Payment Comparison Chart (Bar Chart)
    const billPaymentData = {
      bills: totalBillAmount,
      payments: totalPaymentAmount,
      outstanding: pendingAmount
    };
    
    const ctxBillPayment = document.getElementById('chart-bill-payment');
    if(ctxBillPayment){
      const ctx = ctxBillPayment.getContext('2d');
      if(chartBillPayment) chartBillPayment.destroy();
      chartBillPayment = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Total Bills', 'Total Payments', 'Outstanding'],
          datasets: [{
            label: 'Amount (‚Çπ)',
            data: [billPaymentData.bills, billPaymentData.payments, billPaymentData.outstanding],
            backgroundColor: ['#3498db', '#27ae60', '#e74c3c'],
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              padding: 12,
              callbacks: {
                label: function(context) {
                  return '‚Çπ' + parseFloat(context.parsed.y).toLocaleString('en-IN', {minimumFractionDigits: 2});
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '‚Çπ' + value.toLocaleString('en-IN');
                }
              }
            }
          }
        }
      });
    }

  }catch(err){
    logError('loadDashboard', err);
    // Don't show error on dashboard load, just log it
  }
}

// ----- Date Filter Utility Function -----
function filterByDate(data, dateField, dateFilter){
  if(!dateFilter.from && !dateFilter.to) return data;
  
  return data.filter(item => {
    if(!item[dateField]) return false;
    const itemDate = new Date(item[dateField]);
    if(dateFilter.from){
      const fromDate = new Date(dateFilter.from);
      fromDate.setHours(0,0,0,0);
      if(itemDate < fromDate) return false;
    }
    if(dateFilter.to){
      const toDate = new Date(dateFilter.to);
      toDate.setHours(23,59,59,999);
      if(itemDate > toDate) return false;
    }
    return true;
  });
}

// ----- Pagination Utility -----
function paginate(array, page=1, pageSize=10){
  const totalPages=Math.ceil(array.length/pageSize);
  const start=(page-1)*pageSize;
  const data=array.slice(start,start+pageSize);
  return {data,totalPages};
}

function createPagination(containerId,totalPages,currentPage,callback){
  const container=document.getElementById(containerId);
  if(!container) return;
  container.innerHTML='';
  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement('button');
    btn.innerText=i;
    if(i===currentPage) btn.classList.add('active');
    btn.addEventListener('click',()=>callback(i));
    container.appendChild(btn);
  }
}

// ----- Tabs -----
const tabs=document.querySelectorAll('.tab-link');
const tabContent=document.getElementById('tab-content');

tabs.forEach(tab => {
  tab.addEventListener('click', async () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    tabContent.innerHTML = '';

            switch(tab.dataset.tab){
              case 'dashboard':
                tabContent.innerHTML = `<div id="dashboard-content">
                  <div style="text-align:center;padding:40px;color:#7f8c8d;">
                    <h2 style="color:#2c3e50;margin-bottom:15px;">Welcome to Business Dashboard</h2>
                    <p style="font-size:1.1rem;">View your analytics and insights above, or use the tabs to manage Customers, Bills, and Payments.</p>
                  </div>
                </div>`;
                loadDashboard();
                break;
      case 'customers':
        await loadCustomersTab(1, '', false);
        break;
      case 'bills':
        await loadBillsTab(1, '', false);
        break;
      case 'payments':
        await loadPaymentsTab(1, '', false);
        break;
      case 'import':
        if(!hasFeature('CSV_IMPORT')){
          tabContent.innerHTML = `<div style="text-align:center;padding:40px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:12px;">
            <h2 style="margin:0 0 15px 0;">üöÄ Upgrade Required</h2>
            <p style="margin:0 0 20px 0;opacity:0.9;">CSV Import feature is not available in your current plan.</p>
            <button onclick="alert('Contact your administrator to upgrade your plan')" style="padding:12px 24px;background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:8px;cursor:pointer;font-weight:600;">Upgrade Now</button>
          </div>`;
          return;
        }
        await loadImportTab();
        break;
      case 'reports':
        if(!hasFeature('ADVANCED_REPORTS')){
          tabContent.innerHTML = `<div style="text-align:center;padding:40px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:12px;">
            <h2 style="margin:0 0 15px 0;">üöÄ Upgrade Required</h2>
            <p style="margin:0 0 20px 0;opacity:0.9;">Advanced Reports feature is not available in your current plan.</p>
            <button onclick="alert('Contact your administrator to upgrade your plan')" style="padding:12px 24px;background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:8px;cursor:pointer;font-weight:600;">Upgrade Now</button>
          </div>`;
          return;
        }
        await loadReportsTab();
        break;
      case 'notifications':
        if(!hasFeature('EMAIL_NOTIFICATIONS')){
          tabContent.innerHTML = `<div style="text-align:center;padding:40px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:12px;">
            <h2 style="margin:0 0 15px 0;">üöÄ Upgrade Required</h2>
            <p style="margin:0 0 20px 0;opacity:0.9;">Email Notifications feature is not available in your current plan.</p>
            <button onclick="alert('Contact your administrator to upgrade your plan')" style="padding:12px 24px;background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:8px;cursor:pointer;font-weight:600;">Upgrade Now</button>
          </div>`;
          return;
        }
        await loadNotificationsTab();
        break;
      case 'audit':
        if(!hasFeature('AUDIT_LOG')){
          tabContent.innerHTML = `<div style="text-align:center;padding:40px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:12px;">
            <h2 style="margin:0 0 15px 0;">üöÄ Upgrade Required</h2>
            <p style="margin:0 0 20px 0;opacity:0.9;">Audit Log feature is not available in your current plan.</p>
            <button onclick="alert('Contact your administrator to upgrade your plan')" style="padding:12px 24px;background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:8px;cursor:pointer;font-weight:600;">Upgrade Now</button>
          </div>`;
          return;
        }
        await loadAuditLogTab();
        break;
      case 'reminders':
        if(!hasFeature('REMINDERS')){
          tabContent.innerHTML = `<div style="text-align:center;padding:40px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:12px;">
            <h2 style="margin:0 0 15px 0;">üöÄ Upgrade Required</h2>
            <p style="margin:0 0 20px 0;opacity:0.9;">Reminders feature is not available in your current plan.</p>
            <button onclick="alert('Contact your administrator to upgrade your plan')" style="padding:12px 24px;background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:8px;cursor:pointer;font-weight:600;">Upgrade Now</button>
          </div>`;
          return;
        }
        await loadRemindersTab();
        break;
      case 'search':
        if(!hasFeature('ADVANCED_SEARCH')){
          tabContent.innerHTML = `<div style="text-align:center;padding:40px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:12px;">
            <h2 style="margin:0 0 15px 0;">üöÄ Upgrade Required</h2>
            <p style="margin:0 0 20px 0;opacity:0.9;">Advanced Search feature is not available in your current plan.</p>
            <button onclick="alert('Contact your administrator to upgrade your plan')" style="padding:12px 24px;background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:8px;cursor:pointer;font-weight:600;">Upgrade Now</button>
          </div>`;
          return;
        }
        await loadSearchTab();
        break;
      case 'customize':
        if(!hasFeature('DASHBOARD_CUSTOMIZATION')){
          tabContent.innerHTML = `<div style="text-align:center;padding:40px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:12px;">
            <h2 style="margin:0 0 15px 0;">üöÄ Upgrade Required</h2>
            <p style="margin:0 0 20px 0;opacity:0.9;">Dashboard Customization feature is not available in your current plan.</p>
            <button onclick="alert('Contact your administrator to upgrade your plan')" style="padding:12px 24px;background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:8px;cursor:pointer;font-weight:600;">Upgrade Now</button>
          </div>`;
          return;
        }
        await loadCustomizeTab();
        break;
      case 'validation':
        if(!hasFeature('DATA_VALIDATION')){
          tabContent.innerHTML = `<div style="text-align:center;padding:40px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:12px;">
            <h2 style="margin:0 0 15px 0;">üöÄ Upgrade Required</h2>
            <p style="margin:0 0 20px 0;opacity:0.9;">Data Validation feature is not available in your current plan.</p>
            <button onclick="alert('Contact your administrator to upgrade your plan')" style="padding:12px 24px;background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:8px;cursor:pointer;font-weight:600;">Upgrade Now</button>
          </div>`;
          return;
        }
        await loadValidationTab();
        break;
    }

    // --- Scroll tab content into view ---
    tabContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
});

// ----- Customers Tab - Edit/Delete Functions -----
let editingCustomerId = null;

async function editCustomer(id, name, phone, email, address, city, state, pincode, gstNumber){
  if(!hasPermission('edit')){
    showError('c_msg', 'You do not have permission to edit customers');
    return;
  }
  
  editingCustomerId = id;
  // Pre-fill form with customer data
  document.getElementById('c_name').value = name || '';
  document.getElementById('c_phone').value = phone || '';
  document.getElementById('c_email').value = email || '';
  document.getElementById('c_address').value = address || '';
  document.getElementById('c_city').value = city || '';
  document.getElementById('c_state').value = state || '';
  document.getElementById('c_pincode').value = pincode || '';
  document.getElementById('c_gstNumber').value = gstNumber || '';
  
  // Change button to "Update" mode
  const btn = document.getElementById('btnAddCustomer');
  btn.innerText = 'Update';
  btn.dataset.mode = 'update';
  
  // Scroll to form
  document.getElementById('c_name').scrollIntoView({behavior:'smooth', block:'center'});
  showSuccess('c_msg', 'Edit mode: Update the fields and click Update');
}

async function updateCustomer(id, name, phone, email, address, city, state, pincode, gstNumber){
  setButtonLoading('btnAddCustomer', 'Updating...');
  showLoading('c_msg', 'Updating customer...');
  const payload = {
    name, 
    phone, 
    email: email || null,
    address, 
    city: city || null,
    state: state || null,
    pincode: pincode || null,
    gstNumber: gstNumber || null
  };
  const r = await fetchJson(`${API_CUSTOMERS}/${id}`, {method:'PUT', headers:authHeader(), body:JSON.stringify(payload)});
  removeButtonLoading('btnAddCustomer');
  if(handleApiError(r, 'c_msg', 'Failed to update customer')) return;
  
  showSuccess('c_msg', 'Customer updated successfully!');
  editingCustomerId = null;
  // Reset form and button
  document.getElementById('c_name').value = '';
  document.getElementById('c_phone').value = '';
  document.getElementById('c_email').value = '';
  document.getElementById('c_address').value = '';
  document.getElementById('c_city').value = '';
  document.getElementById('c_state').value = '';
  document.getElementById('c_pincode').value = '';
  document.getElementById('c_gstNumber').value = '';
  const btn = document.getElementById('btnAddCustomer');
  btn.innerText = 'Add';
  btn.dataset.mode = 'add';
  customersDataLoaded = false;
  loadCustomersTab(1, '', true);
}

async function deleteCustomer(id){
  if(!hasPermission('delete')){
    showError('c_msg', 'You do not have permission to delete customers');
    return;
  }
  
  showLoading('c_msg', 'Deleting customer...');
  showLoadingOverlay();
  const r = await fetchJson(`${API_CUSTOMERS}/${id}`, {method:'DELETE', headers:authHeader()});
  hideLoadingOverlay();
  
  // Handle case where DELETE endpoint might not be implemented yet
  if(r.status === 404 || r.status === 405){
    showError('c_msg', 'Delete endpoint not available yet. Please check API documentation.');
    logError('deleteCustomer', {message: 'DELETE endpoint not implemented', status: r.status});
    return;
  }
  
  if(handleApiError(r, 'c_msg', 'Failed to delete customer')) return;
  
  showSuccess('c_msg', 'Customer deleted successfully!');
  customersDataLoaded = false;
  loadCustomersTab(1, '', true);
}

// ----- Customer Profile/Details View -----
async function viewCustomerProfile(customerId, customerName){
  showLoadingOverlay();
  
  try{
    // Fetch customer details, bills, and payments
    const [customerRes, billsRes, paymentsRes] = await Promise.all([
      fetchJson(`${API_CUSTOMERS}/${customerId}`, {headers:authHeader()}),
      fetchJson(API_BILLS, {headers:authHeader()}),
      fetchJson(API_PAYMENTS, {headers:authHeader()})
    ]);
    
    hideLoadingOverlay();
    
    if(!customerRes.ok){
      showError('c_msg', getErrorMessage(customerRes, 'Failed to load customer details'));
      return;
    }
    
    const customer = customerRes.data;
    const allBills = (billsRes.data || []).filter(b => (b.isActive === undefined || b.isActive !== false) && (b.IsActive === undefined || b.IsActive !== false) && (b.is_active === undefined || b.is_active !== false));
    const allPayments = (paymentsRes.data || []).filter(p => (p.isActive === undefined || p.isActive !== false) && (p.IsActive === undefined || p.IsActive !== false) && (p.is_active === undefined || p.is_active !== false));
    
    // Filter bills and payments for this customer
    const customerBills = allBills.filter(b => b.customerId === customerId);
    const customerPayments = allPayments.filter(p => p.customerId === customerId);
    
    // Calculate totals - Only use cleared payments for outstanding calculation
    const totalBilled = customerBills.reduce((sum, b) => sum + (parseFloat(b.billAmount) || 0), 0);
    // Only count cleared payments (Cleared = true)
    const totalPaid = customerPayments
      .filter(p => {
        // Filter by cleared status
        const isCleared = p.cleared === true || p.cleared === 'true' || (p.mode !== 'Cheque' && p.cleared !== false);
        return isCleared;
      })
      .reduce((sum, p) => {
        // If linkedBills exist, use allocatedAmount from them (this is the actual amount allocated to bills)
        if(p.linkedBills && Array.isArray(p.linkedBills) && p.linkedBills.length > 0){
          // Sum all allocatedAmount from linkedBills
          return sum + p.linkedBills.reduce((lbSum, lb) => {
            // Use allocatedAmount (the actual amount allocated to this bill)
            const allocated = parseFloat(lb.allocatedAmount) || 0;
            return lbSum + allocated;
          }, 0);
        }
        // Otherwise use direct payment amount
        return sum + (parseFloat(p.amount) || 0);
      }, 0);
    const outstanding = totalBilled - totalPaid;
    // Calculate payment progress: (Total Paid / Total Billed) * 100, capped at 100%
    const paymentProgress = totalBilled > 0 ? Math.min(100, Math.round((totalPaid / totalBilled) * 100)) : 0;
    
    // Create profile modal
    const profileHtml = `
      <div id="customerProfileModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;">
        <div style="background:#fff;border-radius:12px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.2);">
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:25px;border-radius:12px 12px 0 0;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div>
                <h2 style="margin:0;font-size:1.8rem;">${escapeHtml(customerName)}</h2>
                <p style="margin:5px 0 0 0;opacity:0.9;">Customer Profile</p>
              </div>
              <button onclick="closeCustomerProfile()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:1.5rem;line-height:1;">√ó</button>
            </div>
          </div>
          
          <div style="padding:25px;">
            <!-- Action Buttons -->
            <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;">
              <button onclick="generatePDFStatementForCustomer(${customerId})" style="padding:10px 20px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;">
                üìÑ PDF Statement
              </button>
              <button onclick="generateCustomerStatement(${customerId}, '${escapeHtml(customerName)}')" style="padding:10px 20px;background:linear-gradient(135deg, #3498db 0%, #2980b9 100%);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;">
                üñ®Ô∏è Print Statement
              </button>
              <button onclick="exportCustomerProfile(${customerId})" style="padding:10px 20px;background:linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;">
                üì• Export CSV
              </button>
            </div>
            
            <!-- Customer Info -->
            <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:25px;">
              <h3 style="margin-top:0;color:#2c3e50;">Customer Information</h3>
              <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;">
                <div>
                  <strong style="color:#7f8c8d;font-size:0.9rem;">Phone:</strong>
                  <p style="margin:5px 0;color:#2c3e50;">${escapeHtml(customer.phone || 'N/A')}</p>
                </div>
                <div>
                  <strong style="color:#7f8c8d;font-size:0.9rem;">Address:</strong>
                  <p style="margin:5px 0;color:#2c3e50;">${escapeHtml(customer.address || 'N/A')}</p>
                </div>
                <div>
                  <strong style="color:#7f8c8d;font-size:0.9rem;">Member Since:</strong>
                  <p style="margin:5px 0;color:#2c3e50;">${customer.createdAt ? formatDateOnly(customer.createdAt) : 'N/A'}</p>
                </div>
              </div>
            </div>
            
            <!-- Financial Summary -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;margin-bottom:25px;">
              <div style="background:#fff;padding:20px;border-radius:8px;border-left:4px solid #3498db;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                <p style="margin:0;color:#7f8c8d;font-size:0.9rem;">Total Billed</p>
                <h3 style="margin:10px 0 0 0;color:#2c3e50;">‚Çπ${totalBilled.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h3>
              </div>
              <div style="background:#fff;padding:20px;border-radius:8px;border-left:4px solid #27ae60;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                <p style="margin:0;color:#7f8c8d;font-size:0.9rem;">Total Paid</p>
                <h3 style="margin:10px 0 0 0;color:#2c3e50;">‚Çπ${totalPaid.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h3>
              </div>
              <div style="background:#fff;padding:20px;border-radius:8px;border-left:4px solid ${outstanding > 0 ? '#e74c3c' : '#27ae60'};box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                <p style="margin:0;color:#7f8c8d;font-size:0.9rem;">Outstanding</p>
                <h3 style="margin:10px 0 0 0;color:#2c3e50;">‚Çπ${outstanding.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h3>
              </div>
              <div style="background:#fff;padding:20px;border-radius:8px;border-left:4px solid #9b59b6;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                <p style="margin:0;color:#7f8c8d;font-size:0.9rem;">Payment Progress</p>
                <h3 style="margin:10px 0 0 0;color:#2c3e50;">${paymentProgress}%</h3>
                <div style="margin-top:10px;width:100%;height:6px;background:#ecf0f1;border-radius:3px;overflow:hidden;">
                  <div style="height:100%;background:linear-gradient(90deg, #27ae60, #2ecc71);width:${paymentProgress}%;transition:width 0.5s;"></div>
                </div>
              </div>
            </div>
            
            <!-- Bills Section -->
            <div style="margin-bottom:25px;">
              <h3 style="color:#2c3e50;margin-bottom:15px;">Bills (${customerBills.length})</h3>
              ${customerBills.length === 0 ? 
                '<p style="color:#7f8c8d;text-align:center;padding:20px;">No bills found</p>' :
                `<table style="width:100%;border-collapse:collapse;">
                  <thead>
                    <tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;">
                      <th style="padding:12px;text-align:left;">ID</th><th>Amount</th><th>Status</th><th>Date</th><th>Notes</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${customerBills.map(b => {
                      const statusColor = (b.status === 'Pending' || b.status === 'pending') ? '#856404' : '#155724';
                      const statusBg = (b.status === 'Pending' || b.status === 'pending') ? '#fff3cd' : '#d4edda';
                      return `<tr style="border-bottom:1px solid #ecf0f1;">
                        <td style="padding:12px;">${escapeHtml(b.id)}</td>
                        <td style="padding:12px;">‚Çπ${parseFloat(b.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                        <td style="padding:12px;"><span style="padding:4px 8px;border-radius:4px;font-size:0.85rem;background:${statusBg};color:${statusColor};">${escapeHtml(b.status || 'N/A')}</span></td>
                        <td style="padding:12px;">${b.billDate ? formatDateOnly(b.billDate) : (b.createdAt ? formatDateOnly(b.createdAt) : 'N/A')}</td>
                        <td style="padding:12px;">${escapeHtml(b.notes || '')}</td>
                      </tr>`;
                    }).join('')}
                  </tbody>
                </table>`
              }
            </div>
            
            <!-- Payments Section -->
            <div>
              <h3 style="color:#2c3e50;margin-bottom:15px;">Payments (${customerPayments.length})</h3>
              ${customerPayments.length === 0 ? 
                '<p style="color:#7f8c8d;text-align:center;padding:20px;">No payments found</p>' :
                `<table style="width:100%;border-collapse:collapse;">
                  <thead>
                    <tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;">
                      <th style="padding:12px;text-align:left;">ID</th><th>Amount</th><th>Mode</th><th>Date</th><th>Cleared</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${customerPayments.map(p => {
                      const clearedStatus = p.cleared ? '‚úì Cleared' : '‚è≥ Pending';
                      const clearedColor = p.cleared ? '#155724' : '#856404';
                      const clearedBg = p.cleared ? '#d4edda' : '#fff3cd';
                      return `<tr style="border-bottom:1px solid #ecf0f1;">
                        <td style="padding:12px;">${escapeHtml(p.id)}</td>
                        <td style="padding:12px;">‚Çπ${parseFloat(p.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                        <td style="padding:12px;"><span style="text-transform:capitalize;">${escapeHtml(p.mode || 'N/A')}</span></td>
                        <td style="padding:12px;">${p.paymentDate ? formatDateOnly(p.paymentDate) : (p.createdAt ? formatDateOnly(p.createdAt) : 'N/A')}</td>
                        <td style="padding:12px;"><span style="padding:4px 8px;border-radius:4px;font-size:0.85rem;background:${clearedBg};color:${clearedColor};">${clearedStatus}</span></td>
                      </tr>`;
                    }).join('')}
                  </tbody>
                </table>`
              }
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', profileHtml);
    
  } catch(err){
    hideLoadingOverlay();
    logError('viewCustomerProfile', err);
    showError('c_msg', 'Failed to load customer profile');
  }
}

function closeCustomerProfile(){
  const modal = document.getElementById('customerProfileModal');
  if(modal) modal.remove();
}

// ----- Bill Details Modal with Share/Download -----
async function showBillDetails(billId){
  showLoadingOverlay();
  
  try{
    const [billRes, customersRes] = await Promise.all([
      fetchJson(`${API_BILLS}/${billId}`, {headers:authHeader()}),
      fetchJson(API_CUSTOMERS, {headers:authHeader()})
    ]);
    
    hideLoadingOverlay();
    
    if(!billRes.ok){
      showError('bill_msg', 'Failed to load bill details');
      return;
    }
    
    const bill = billRes.data;
    const customers = customersRes.data || [];
    const customer = customers.find(c => c.id === bill.customerId);
    
    // Calculate payment status
    const paymentsRes = await fetchJson(API_PAYMENTS, {headers:authHeader()});
    const allPayments = (paymentsRes.data || []).filter(p => p.isActive !== false && p.IsActive !== false && p.is_active !== false);
    
    // Find payments linked to this bill (check both direct billId and linkedBills array)
    const billPayments = allPayments.filter(p => {
      // Check direct billId match
      if(p.billId === billId || p.primaryBillId === billId) return true;
      // Check if billId is in linkedBills array
      if(p.linkedBills && Array.isArray(p.linkedBills)){
        return p.linkedBills.some(lb => lb.billId === billId);
      }
      return false;
    });
    
    // Calculate total paid - only count cleared payments, use allocatedAmount from linkedBills
    const totalPaid = billPayments
      .filter(p => {
        // Only count cleared payments
        const isCleared = p.cleared === true || p.cleared === 'true' || (p.mode !== 'Cheque' && p.cleared !== false);
        return isCleared;
      })
      .reduce((sum, p) => {
        // If linkedBills exist, find the specific bill's allocatedAmount
        if(p.linkedBills && Array.isArray(p.linkedBills)){
          const linkedBill = p.linkedBills.find(lb => lb.billId === billId);
          if(linkedBill){
            // Use allocatedAmount for this specific bill
            return sum + (parseFloat(linkedBill.allocatedAmount) || 0);
          }
        }
        // If no linkedBills or bill not found in linkedBills, use direct amount (for backward compatibility)
        // But only if this payment is directly linked to this bill
        if(p.billId === billId || p.primaryBillId === billId){
          return sum + (parseFloat(p.amount) || 0);
        }
        return sum;
      }, 0);
    
    const billAmount = parseFloat(bill.billAmount || 0);
    const remaining = billAmount - totalPaid;
    // Calculate payment progress: (Total Paid / Bill Amount) * 100, capped at 100%
    const paymentProgress = billAmount > 0 ? Math.min(100, Math.round((totalPaid / billAmount) * 100)) : 0;
    
    // Create bill details modal
    const modalHtml = `
      <div id="billDetailsModal" onclick="if(event.target.id === 'billDetailsModal') closeBillDetailsModal()" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">
        <div style="background:#fff;border-radius:16px;max-width:700px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;position:relative;">
          <button onclick="closeBillDetailsModal()" style="position:absolute;top:15px;right:15px;background:#e74c3c;border:none;color:#fff;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:1.3rem;line-height:1;z-index:10001;box-shadow:0 2px 8px rgba(231,76,60,0.4);transition:all 0.3s;display:flex;align-items:center;justify-content:center;font-weight:bold;" onmouseover="this.style.background='#c0392b';this.style.transform='scale(1.1)'" onmouseout="this.style.background='#e74c3c';this.style.transform='scale(1)'" title="Close">√ó</button>
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;padding:30px;position:relative;">
            <div style="text-align:center;">
              <h2 style="margin:0;font-size:2rem;font-weight:600;">Bill #${escapeHtml(bill.id)}</h2>
              <p style="margin:10px 0 0 0;opacity:0.9;">Invoice Details</p>
            </div>
          </div>
          <div style="padding:30px;">
            <div style="background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:25px;border-left:4px solid #667eea;">
              <h3 style="margin:0 0 15px 0;color:#2c3e50;">Customer Information</h3>
              <p><strong>Name:</strong> ${escapeHtml(customer?.name || 'N/A')}</p>
              <p><strong>Phone:</strong> ${escapeHtml(customer?.phone || 'N/A')}</p>
              <p><strong>Address:</strong> ${escapeHtml(customer?.address || 'N/A')}</p>
            </div>
            <div style="background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:25px;margin-bottom:25px;">
              <h3 style="margin:0 0 20px 0;color:#2c3e50;border-bottom:2px solid #ecf0f1;padding-bottom:10px;">Bill Information</h3>
              <p><strong>Bill Date:</strong> ${bill.billDate ? formatDate(bill.billDate) : (bill.createdAt ? formatDate(bill.createdAt) : 'N/A')}</p>
              <p><strong>Status:</strong> <span style="padding:6px 12px;border-radius:6px;background:${(bill.status === 'Pending' || bill.status === 'pending') ? '#fff3cd' : '#d4edda'};color:${(bill.status === 'Pending' || bill.status === 'pending') ? '#856404' : '#155724'};">${escapeHtml(bill.status || 'Pending')}</span></p>
              ${bill.notes ? `<p><strong>Notes:</strong> ${escapeHtml(bill.notes)}</p>` : ''}
            </div>
            <div style="background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);padding:25px;border-radius:12px;margin-bottom:25px;">
              <h3 style="margin:0 0 20px 0;color:#2c3e50;">Financial Summary</h3>
              <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;margin-bottom:20px;">
                <div style="background:#fff;padding:15px;border-radius:8px;text-align:center;">
                  <p style="margin:0;color:#7f8c8d;font-size:0.85rem;">Bill Amount</p>
                  <h3 style="margin:5px 0 0 0;color:#2c3e50;font-size:1.5rem;">‚Çπ${billAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</h3>
                </div>
                <div style="background:#fff;padding:15px;border-radius:8px;text-align:center;">
                  <p style="margin:0;color:#7f8c8d;font-size:0.85rem;">Paid</p>
                  <h3 style="margin:5px 0 0 0;color:#27ae60;font-size:1.5rem;">‚Çπ${totalPaid.toLocaleString('en-IN', {minimumFractionDigits: 2})}</h3>
                </div>
                <div style="background:#fff;padding:15px;border-radius:8px;text-align:center;">
                  <p style="margin:0;color:#7f8c8d;font-size:0.85rem;">Remaining</p>
                  <h3 style="margin:5px 0 0 0;color:${remaining > 0 ? '#e74c3c' : '#27ae60'};font-size:1.5rem;">‚Çπ${remaining.toLocaleString('en-IN', {minimumFractionDigits: 2})}</h3>
                </div>
              </div>
              <div>
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                  <span>Payment Progress</span>
                  <span>${paymentProgress}%</span>
                </div>
                <div style="width:100%;height:12px;background:#ecf0f1;border-radius:6px;overflow:hidden;">
                  <div style="height:100%;background:linear-gradient(90deg, #27ae60, #2ecc71);width:${paymentProgress}%;border-radius:6px;"></div>
                </div>
              </div>
            </div>
            ${billPayments.length > 0 ? `
              <div style="margin-bottom:25px;">
                <h3 style="margin:0 0 15px 0;color:#2c3e50;">Payment History</h3>
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;max-height:200px;overflow-y:auto;">
                  ${billPayments.map(p => {
                    // Get the allocated amount for this specific bill from linkedBills
                    let paymentAmount = parseFloat(p.amount || 0);
                    if(p.linkedBills && Array.isArray(p.linkedBills)){
                      const linkedBill = p.linkedBills.find(lb => lb.billId === billId);
                      if(linkedBill){
                        paymentAmount = parseFloat(linkedBill.allocatedAmount) || 0;
                      }
                    }
                    return `
                    <div style="display:flex;justify-content:space-between;padding:10px;background:#fff;margin-bottom:8px;border-radius:6px;border-left:3px solid ${p.cleared ? '#27ae60' : '#f39c12'};">
                      <div>
                        <strong>‚Çπ${paymentAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</strong>
                        <span style="color:#7f8c8d;font-size:0.85rem;margin-left:10px;">${p.paymentDate ? formatDateOnly(p.paymentDate) : 'N/A'}</span>
                      </div>
                      <div>
                        <span style="padding:4px 8px;border-radius:4px;font-size:0.8rem;background:#e3f2fd;color:#1976d2;text-transform:capitalize;">${escapeHtml(p.mode || 'N/A')}</span>
                        ${p.cleared ? '<span style="margin-left:8px;padding:4px 8px;border-radius:4px;font-size:0.8rem;background:#d4edda;color:#155724;">‚úì Cleared</span>' : '<span style="margin-left:8px;padding:4px 8px;border-radius:4px;font-size:0.8rem;background:#fff3cd;color:#856404;">‚è≥ Pending</span>'}
                      </div>
                    </div>
                  `;
                  }).join('')}
                </div>
              </div>
            ` : ''}
            <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:30px;padding-top:25px;border-top:2px solid #ecf0f1;">
              <button onclick="downloadBillPDF(${billId})" style="flex:1;min-width:200px;padding:14px 20px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:1rem;box-shadow:0 4px 15px rgba(102,126,234,0.3);transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px rgba(102,126,234,0.3)'">üìÑ Download PDF</button>
              <button onclick="shareBill(${billId})" style="flex:1;min-width:200px;padding:14px 20px;background:linear-gradient(135deg, #3498db 0%, #2980b9 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:1rem;box-shadow:0 4px 15px rgba(52,152,219,0.3);transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(52,152,219,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px rgba(52,152,219,0.3)'">üîó Share Bill</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  } catch(err){
    hideLoadingOverlay();
    logError('showBillDetails', err);
    showError('bill_msg', 'Failed to load bill details');
  }
}

function closeBillDetailsModal(){
  const modal = document.getElementById('billDetailsModal');
  if(modal) modal.remove();
}

async function downloadBillPDF(billId){
  try{
    showLoadingOverlay();
    const [billRes, customersRes] = await Promise.all([
      fetchJson(`${API_BILLS}/${billId}`, {headers:authHeader()}),
      fetchJson(API_CUSTOMERS, {headers:authHeader()})
    ]);
    hideLoadingOverlay();
    if(!billRes.ok){
      showError('bill_msg', 'Failed to load bill data');
      return;
    }
    const bill = billRes.data;
    const customers = customersRes.data || [];
    const customer = customers.find(c => c.id === bill.customerId);
    if(!customer){
      showError('bill_msg', 'Customer not found');
      return;
    }
    const success = generatePDFInvoice(bill, customer);
    if(success){
      showSuccess('bill_msg', 'PDF invoice downloaded successfully!');
      closeBillDetailsModal();
    } else {
      showError('bill_msg', 'Failed to generate PDF invoice');
    }
  } catch(err){
    hideLoadingOverlay();
    logError('downloadBillPDF', err);
    showError('bill_msg', 'Failed to download PDF');
  }
}

async function shareBill(billId){
  try{
    showLoadingOverlay();
    
    // Generate PDF first
    const [billRes, customersRes] = await Promise.all([
      fetchJson(`${API_BILLS}/${billId}`, {headers:authHeader()}),
      fetchJson(API_CUSTOMERS, {headers:authHeader()})
    ]);
    
    hideLoadingOverlay();
    
    if(!billRes.ok){
      showError('bill_msg', 'Failed to load bill data');
      return;
    }
    
    const bill = billRes.data;
    const customers = customersRes.data || [];
    const customer = customers.find(c => c.id === bill.customerId);
    
    if(!customer){
      showError('bill_msg', 'Customer not found');
      return;
    }
    
    // Generate PDF as blob
    if(!window.jspdf) {
      showError('bill_msg', 'PDF library not available');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Use the same PDF generation logic
    const primaryColor = [102, 126, 234];
    const secondaryColor = [118, 75, 162];
    const lightGray = [245, 245, 245];
    const darkGray = [44, 62, 80];
    const successGreen = [39, 174, 96];
    
    // Header
    doc.setFillColor(...primaryColor);
    doc.rect(0, 0, 210, 50, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(28);
    doc.setFont(undefined, 'bold');
    doc.text('INVOICE', 105, 25, { align: 'center' });
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    doc.text('Business Management System', 105, 35, { align: 'center' });
    doc.text('Invoice #' + bill.id, 105, 42, { align: 'center' });
    
    // Invoice Info
    let yPos = 60;
    doc.setTextColor(...darkGray);
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('Invoice Date:', 20, yPos);
    doc.setFont(undefined, 'normal');
    doc.text(bill.billDate ? formatDateOnly(bill.billDate) : formatDateOnly(bill.createdAt), 20, yPos + 6);
    doc.setFont(undefined, 'bold');
    doc.text('Status:', 20, yPos + 14);
    doc.setFont(undefined, 'normal');
    const statusColor = (bill.status === 'Pending' || bill.status === 'pending') ? [255, 193, 7] : successGreen;
    doc.setFillColor(...statusColor);
    doc.roundedRect(20, yPos + 16, 40, 6, 2, 2, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text((bill.status || 'Pending').toUpperCase(), 40, yPos + 20, { align: 'center' });
    
    // Customer Info
    yPos = 60;
    doc.setTextColor(...darkGray);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Bill To:', 120, yPos);
    doc.setFillColor(...lightGray);
    doc.roundedRect(120, yPos + 3, 80, 35, 3, 3, 'F');
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(...darkGray);
    doc.text(customer.name || 'N/A', 125, yPos + 10);
    doc.text(customer.phone || 'N/A', 125, yPos + 17);
    const address = customer.address || 'N/A';
    const addressLines = doc.splitTextToSize(address, 70);
    addressLines.forEach((line, index) => {
      doc.text(line, 125, yPos + 24 + (index * 6));
    });
    
    // Items Table
    yPos = 105;
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(...darkGray);
    doc.text('Item Details', 20, yPos);
    yPos += 8;
    doc.setFillColor(...primaryColor);
    doc.roundedRect(20, yPos, 170, 10, 2, 2, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('Description', 25, yPos + 7);
    doc.text('Quantity', 120, yPos + 7);
    doc.text('Amount', 180, yPos + 7, { align: 'right' });
    yPos += 12;
    doc.setFillColor(...lightGray);
    doc.roundedRect(20, yPos, 170, 12, 2, 2, 'F');
    doc.setTextColor(...darkGray);
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const description = bill.notes || 'Service/Product';
    const descLines = doc.splitTextToSize(description, 80);
    descLines.forEach((line, index) => {
      doc.text(line, 25, yPos + 6 + (index * 5));
    });
    doc.text('1', 120, yPos + 7);
    doc.setFont(undefined, 'bold');
    doc.setFontSize(11);
    doc.text('‚Çπ' + parseFloat(bill.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}), 180, yPos + 7, { align: 'right' });
    
    // Totals
    yPos += 20;
    doc.setFillColor(250, 250, 250);
    doc.roundedRect(120, yPos, 70, 25, 3, 3, 'F');
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.line(120, yPos + 15, 190, yPos + 15);
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(100, 100, 100);
    doc.text('Subtotal:', 125, yPos + 10);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(...darkGray);
    doc.text('‚Çπ' + parseFloat(bill.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}), 185, yPos + 10, { align: 'right' });
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(...primaryColor);
    doc.text('Total Amount:', 125, yPos + 22);
    doc.setFontSize(14);
    doc.text('‚Çπ' + parseFloat(bill.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}), 185, yPos + 22, { align: 'right' });
    
    // Payment Info
    yPos += 35;
    doc.setFillColor(255, 249, 237);
    doc.roundedRect(20, yPos, 170, 20, 3, 3, 'F');
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(...darkGray);
    doc.text('Payment Information', 25, yPos + 7);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(100, 100, 100);
    doc.text('Payment Terms: Due on receipt', 25, yPos + 14);
    doc.text('Payment Methods: Cash, UPI, Cheque', 25, yPos + 20);
    
    // Footer
    yPos = 270;
    doc.setDrawColor(220, 220, 220);
    doc.setLineWidth(0.5);
    doc.line(20, yPos, 190, yPos);
    doc.setFontSize(9);
    doc.setTextColor(150, 150, 150);
    doc.text('Thank you for your business!', 105, yPos + 8, { align: 'center' });
    doc.text('For any queries, please contact us.', 105, yPos + 14, { align: 'center' });
    doc.text('Generated on ' + formatDate(new Date().toISOString()), 105, yPos + 20, { align: 'center' });
    
    // Get PDF as blob
    const pdfBlob = doc.output('blob');
    const filename = `Invoice_${bill.id}_${customer.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    
    // Share the PDF file
    if(navigator.share && navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], filename, { type: 'application/pdf' })] })){
      const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });
      navigator.share({
        title: `Invoice #${bill.id}`,
        text: `Invoice for ${customer.name}`,
        files: [pdfFile]
      }).then(() => {
        showSuccess('bill_msg', 'PDF invoice shared successfully!');
      }).catch((err) => {
        console.log('Share error:', err);
        // Fallback: download the PDF
        doc.save(filename);
        showSuccess('bill_msg', 'PDF invoice downloaded (share not available)');
      });
    } else {
      // Fallback: download the PDF if share is not available
      doc.save(filename);
      showSuccess('bill_msg', 'PDF invoice downloaded (share not available on this device)');
    }
    
  } catch(err){
    hideLoadingOverlay();
    logError('shareBill', err);
    showError('bill_msg', 'Failed to share PDF invoice');
  }
}

// Alerts/Notifications Function
function calculateAlerts(bills, payments){
  const alertsCard = document.getElementById('alertsCard');
  const alertsCountEl = document.getElementById('alertsCount');
  const alertsTextEl = document.getElementById('alertsText');
  
  if(!alertsCard || !alertsCountEl || !alertsTextEl) return;
  
  const alerts = [];
  
  // Check for pending bills older than 30 days
  const now = new Date();
  const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
  
  const overdueBills = bills.filter(b => {
    if(b.status === 'Paid' || b.status === 'paid') return false;
    const billDate = b.billDate || b.createdAt;
    if(!billDate) return false;
    return new Date(billDate) < thirtyDaysAgo;
  });
  
  if(overdueBills.length > 0){
    alerts.push(`${overdueBills.length} overdue bill(s)`);
  }
  
  // Check for pending payments older than 7 days
  const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
  const pendingPayments = payments.filter(p => {
    if(p.cleared) return false;
    const paymentDate = p.paymentDate || p.createdAt;
    if(!paymentDate) return false;
    return new Date(paymentDate) < sevenDaysAgo;
  });
  
  if(pendingPayments.length > 0){
    alerts.push(`${pendingPayments.length} pending payment(s)`);
  }
  
  // Check for high outstanding balance
  if(pendingAmount > totalBillAmount * 0.5 && totalBillAmount > 0){
    alerts.push('High outstanding balance');
  }
  
  if(alerts.length > 0){
    alertsCard.style.display = 'block';
    alertsCountEl.innerText = alerts.length;
    alertsTextEl.innerText = alerts.join(', ');
    alertsCard.style.borderTopColor = '#e74c3c';
  } else {
    alertsCard.style.display = 'none';
  }
}

// Export Functions
function exportCustomersData(){
  if(allCustomers.length === 0){
    showError('c_msg', 'No customers to export');
    return;
  }
  exportCustomersToCSV(allCustomers);
  showSuccess('c_msg', 'Customers exported successfully!');
}

function exportBillsData(){
  if(allBills.length === 0){
    showError('bill_msg', 'No bills to export');
    return;
  }
  const customerMap = {};
  allCustomersForBills.forEach(c => { customerMap[c.id] = c.name; });
  exportBillsToCSV(allBills, customerMap);
  showSuccess('bill_msg', 'Bills exported successfully!');
}

function exportPaymentsData(){
  if(allPayments.length === 0){
    showError('pay_msg', 'No payments to export');
    return;
  }
  exportPaymentsToCSV(allPayments);
  showSuccess('pay_msg', 'Payments exported successfully!');
}

// Print/PDF Reports Functions
function printCustomerStatement(customerId, customerName){
  // This will open print dialog with customer statement
  window.print();
}

function generateCustomerStatement(customerId, customerName){
  // This will be called from the profile modal
  // For now, show a message that full statement is in the profile view
  showSuccess('c_msg', 'Use the Print button in the customer profile for detailed statement');
}

async function generatePDFStatementForCustomer(customerId){
  try{
    showLoadingOverlay();
    const [customerRes, billsRes, paymentsRes] = await Promise.all([
      fetchJson(`${API_CUSTOMERS}/${customerId}`, {headers:authHeader()}),
      fetchJson(API_BILLS, {headers:authHeader()}),
      fetchJson(API_PAYMENTS, {headers:authHeader()})
    ]);
    hideLoadingOverlay();
    
    if(!customerRes.ok){
      showError('c_msg', 'Failed to load customer data');
      return;
    }
    
    const customer = customerRes.data;
    const allBills = (billsRes.data || []).filter(b => (b.isActive === undefined || b.isActive !== false) && (b.IsActive === undefined || b.IsActive !== false) && (b.is_active === undefined || b.is_active !== false));
    const allPayments = (paymentsRes.data || []).filter(p => (p.isActive === undefined || p.isActive !== false) && (p.IsActive === undefined || p.IsActive !== false) && (p.is_active === undefined || p.is_active !== false));
    
    const customerBills = allBills.filter(b => b.customerId === customerId);
    const customerPayments = allPayments.filter(p => p.customerId === customerId);
    
    const success = generatePDFStatement(customer, customerBills, customerPayments);
    if(success){
      showSuccess('c_msg', 'PDF statement generated successfully!');
    } else {
      showError('c_msg', 'Failed to generate PDF statement');
    }
  } catch(err){
    hideLoadingOverlay();
    logError('generatePDFStatementForCustomer', err);
    showError('c_msg', 'Failed to generate PDF statement');
  }
}

async function generatePDFStatementForCustomer(customerId){
  try{
    showLoadingOverlay();
    const [customerRes, billsRes, paymentsRes] = await Promise.all([
      fetchJson(`${API_CUSTOMERS}/${customerId}`, {headers:authHeader()}),
      fetchJson(API_BILLS, {headers:authHeader()}),
      fetchJson(API_PAYMENTS, {headers:authHeader()})
    ]);
    hideLoadingOverlay();
    
    if(!customerRes.ok){
      showError('c_msg', 'Failed to load customer data');
      return;
    }
    
    const customer = customerRes.data;
    const allBills = (billsRes.data || []).filter(b => (b.isActive === undefined || b.isActive !== false) && (b.IsActive === undefined || b.IsActive !== false) && (b.is_active === undefined || b.is_active !== false));
    const allPayments = (paymentsRes.data || []).filter(p => (p.isActive === undefined || p.isActive !== false) && (p.IsActive === undefined || p.IsActive !== false) && (p.is_active === undefined || p.is_active !== false));
    
    const customerBills = allBills.filter(b => b.customerId === customerId);
    const customerPayments = allPayments.filter(p => p.customerId === customerId);
    
    const success = generatePDFStatement(customer, customerBills, customerPayments);
    if(success){
      showSuccess('c_msg', 'PDF statement generated successfully!');
    } else {
      showError('c_msg', 'Failed to generate PDF statement');
    }
  } catch(err){
    hideLoadingOverlay();
    logError('generatePDFStatementForCustomer', err);
    showError('c_msg', 'Failed to generate PDF statement');
  }
}

async function exportCustomerProfile(customerId){
  try{
    const [customerRes, billsRes, paymentsRes] = await Promise.all([
      fetchJson(`${API_CUSTOMERS}/${customerId}`, {headers:authHeader()}),
      fetchJson(API_BILLS, {headers:authHeader()}),
      fetchJson(API_PAYMENTS, {headers:authHeader()})
    ]);
    
    if(!customerRes.ok) return;
    
    const customer = customerRes.data;
    const allBills = (billsRes.data || []).filter(b => (b.isActive === undefined || b.isActive !== false) && (b.IsActive === undefined || b.IsActive !== false) && (b.is_active === undefined || b.is_active !== false));
    const allPayments = (paymentsRes.data || []).filter(p => (p.isActive === undefined || p.isActive !== false) && (p.IsActive === undefined || p.IsActive !== false) && (p.is_active === undefined || p.is_active !== false));
    
    const customerBills = allBills.filter(b => b.customerId === customerId);
    const customerPayments = allPayments.filter(p => p.customerId === customerId);
    
    // Create comprehensive export data
    const exportData = {
      customer: customer,
      bills: customerBills,
      payments: customerPayments,
      summary: {
        totalBilled: customerBills.reduce((sum, b) => sum + (parseFloat(b.billAmount) || 0), 0),
        totalPaid: customerPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0),
        outstanding: 0
      }
    };
    
    // Calculate outstanding using only cleared payments
    const clearedPaymentsTotal = customerPayments
      .filter(p => p.cleared === true || p.cleared === 'true' || (p.mode !== 'Cheque' && p.cleared !== false))
      .reduce((sum, p) => {
        let amount = parseFloat(p.amount) || 0;
        if(p.linkedBills && Array.isArray(p.linkedBills)){
          amount = p.linkedBills.reduce((sum, lb) => sum + (parseFloat(lb.amount) || 0), 0);
        }
        return sum + amount;
      }, 0);
    exportData.summary.outstanding = exportData.summary.totalBilled - clearedPaymentsTotal;
    
    // Convert to CSV format
    const csvContent = `Customer Profile Export\n\nCustomer Information\nID,Name,Phone,Address,Created Date\n${customer.id},"${customer.name}","${customer.phone}","${customer.address}",${customer.createdAt || ''}\n\nBills\nID,Amount,Status,Bill Date,Notes\n${customerBills.map(b => `${b.id},${b.billAmount},"${b.status || ''}",${b.billDate || b.createdAt || ''},"${(b.notes || '').replace(/"/g, '""')}"`).join('\n')}\n\nPayments\nID,Amount,Mode,Payment Date,Cleared\n${customerPayments.map(p => `${p.id},${p.amount},"${p.mode || ''}",${p.paymentDate || p.createdAt || ''},${p.cleared}`).join('\n')}\n\nSummary\nTotal Billed,Total Paid,Outstanding\n${exportData.summary.totalBilled},${exportData.summary.totalPaid},${exportData.summary.outstanding}`;
    
    const filename = `customer_profile_${customer.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    downloadCSV(csvContent, filename);
    showSuccess('c_msg', 'Customer profile exported successfully!');
    
  } catch(err){
    logError('exportCustomerProfile', err);
    showError('c_msg', 'Failed to export customer profile');
  }
}

// Bulk Operations Functions
function toggleSelectAllCustomers(checkbox){
  const checkboxes = document.querySelectorAll('.customer-checkbox');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateBulkDeleteButton();
}

function selectAllCustomers(){
  const checkboxes = document.querySelectorAll('.customer-checkbox');
  checkboxes.forEach(cb => cb.checked = true);
  const selectAll = document.getElementById('selectAllCustomers');
  if(selectAll) selectAll.checked = true;
  updateBulkDeleteButton();
}

function deselectAllCustomers(){
  const checkboxes = document.querySelectorAll('.customer-checkbox');
  checkboxes.forEach(cb => cb.checked = false);
  const selectAll = document.getElementById('selectAllCustomers');
  if(selectAll) selectAll.checked = false;
  updateBulkDeleteButton();
}

function updateBulkDeleteButton(){
  const checked = document.querySelectorAll('.customer-checkbox:checked');
  const btn = document.getElementById('btnBulkDeleteCustomers');
  if(btn){
    if(checked.length > 0){
      btn.style.display = 'inline-block';
      btn.innerText = `Delete Selected (${checked.length})`;
    } else {
      btn.style.display = 'none';
    }
  }
}

async function bulkDeleteCustomers(){
  if(!hasPermission('delete')){
    showError('c_msg', 'You do not have permission to delete customers');
    return;
  }
  
  const checked = document.querySelectorAll('.customer-checkbox:checked');
  if(checked.length === 0){
    showError('c_msg', 'Please select at least one customer to delete');
    return;
  }
  
  const selectedIds = Array.from(checked).map(cb => parseInt(cb.value));
  const count = selectedIds.length;
  
  if(!confirm(`Are you sure you want to delete ${count} customer(s)? This action cannot be undone.`)){
    return;
  }
  
  showLoading('c_msg', `Deleting ${count} customer(s)...`);
  showLoadingOverlay();
  
  try{
    const deletePromises = selectedIds.map(id => 
      fetchJson(`${API_CUSTOMERS}/${id}`, {method:'DELETE', headers:authHeader()})
    );
    
    const results = await Promise.all(deletePromises);
    hideLoadingOverlay();
    
    const failed = results.filter(r => !r.ok && r.status !== 404 && r.status !== 405);
    if(failed.length > 0){
      showError('c_msg', `Failed to delete ${failed.length} customer(s). Please try again.`);
    } else {
      showSuccess('c_msg', `Successfully deleted ${count} customer(s)!`);
      loadCustomersTab();
    }
  } catch(err){
    hideLoadingOverlay();
    logError('bulkDeleteCustomers', err);
    showError('c_msg', 'An error occurred during bulk delete');
  }
}

// ----- Customers Tab -----
let allCustomers = []; // Store all customers for filtering
let customerDateFilter = { from: null, to: null };

function applyCustomerDateFilter(){
  const fromDate = document.getElementById('customerFromDate').value;
  const toDate = document.getElementById('customerToDate').value;
  customerDateFilter = { from: fromDate || null, to: toDate || null };
  loadCustomersTab(1, document.getElementById('searchCustomers')?.value || '');
}

function clearCustomerDateFilter(){
  document.getElementById('customerFromDate').value = '';
  document.getElementById('customerToDate').value = '';
  customerDateFilter = { from: null, to: null };
  loadCustomersTab(1, document.getElementById('searchCustomers')?.value || '');
}

let customersDataLoaded = false;

async function loadCustomersTab(page=1, searchTerm='', forceLoad=false){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  // If data not loaded and not forced, show button to load
  if(!customersDataLoaded && !forceLoad){
    const canEdit = hasPermission('edit');
    const canDelete = hasPermission('delete');
    
    const html = `
      <div id="customers-content">
        <h2>Add Customer</h2>
        <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
          <input id="c_name" placeholder="Name *" style="flex:1;min-width:200px;padding:6px;" required>
          <input id="c_phone" placeholder="Phone *" style="flex:1;min-width:200px;padding:6px;" required>
          <input id="c_email" placeholder="Email" type="email" style="flex:1;min-width:200px;padding:6px;">
        </div>
        <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
          <input id="c_address" placeholder="Address *" style="flex:2;min-width:200px;padding:6px;" required>
          <input id="c_city" placeholder="City" style="flex:1;min-width:150px;padding:6px;">
          <input id="c_state" placeholder="State" style="flex:1;min-width:150px;padding:6px;">
        </div>
        <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
          <input id="c_pincode" placeholder="Pincode" style="flex:1;min-width:150px;padding:6px;">
          <input id="c_gstNumber" placeholder="GST Number" style="flex:1;min-width:200px;padding:6px;">
          <button id="btnAddCustomer" style="flex:0 0 auto;padding:6px 20px;">Add</button>
        </div>
        <div id="c_msg" class="error" style="margin-bottom:10px;"></div>
        <div style="text-align:center;padding:40px;background:var(--bg-secondary);border-radius:12px;border:2px dashed var(--border-color);">
          <h3 style="color:var(--text-primary);margin-bottom:15px;">All Customers</h3>
          <p style="color:var(--text-secondary);margin-bottom:20px;">Click the button below to load customer data</p>
          <button onclick="loadCustomersTab(1, '', true)" style="padding:12px 30px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem;box-shadow:0 4px 15px rgba(102,126,234,0.3);">üìã Load All Customers</button>
        </div>
      </div>
    `;
    tabContent.innerHTML = html;
    
    // Setup add customer form
    document.getElementById('btnAddCustomer').addEventListener('click',async()=>{
      clearMessage('c_msg');
      const name=document.getElementById('c_name').value.trim();
      const phone=document.getElementById('c_phone').value.trim();
      const email=document.getElementById('c_email').value.trim();
      const address=document.getElementById('c_address').value.trim();
      const city=document.getElementById('c_city').value.trim();
      const state=document.getElementById('c_state').value.trim();
      const pincode=document.getElementById('c_pincode').value.trim();
      const gstNumber=document.getElementById('c_gstNumber').value.trim();
      
      if(editingCustomerId){
        const validation = validateCustomerForm({name, phone, address});
        if(!validation.valid){
          showError('c_msg', validation.errors.map(e => e.message).join(', '));
          return;
        }
        await updateCustomer(editingCustomerId, name, phone, email, address, city, state, pincode, gstNumber);
        return;
      }
      
      const validation = validateCustomerForm({name, phone, address});
      if(!validation.valid){
        const errorMsg = validation.errors.map(e => e.message).join(', ');
        showError('c_msg', errorMsg);
        return;
      }
      
      const payload={name, phone, email: email || null, address, city: city || null, state: state || null, pincode: pincode || null, gstNumber: gstNumber || null};
      setButtonLoading('btnAddCustomer', 'Adding...');
      showLoading('c_msg', 'Adding customer...');
      const r=await fetchJson(API_CUSTOMERS,{method:'POST',headers:authHeader(),body:JSON.stringify(payload)});
      removeButtonLoading('btnAddCustomer');
      if(handleApiError(r, 'c_msg', 'Failed to add customer')) return;
      showSuccess('c_msg', 'Customer added successfully!');
      document.getElementById('c_name').value = '';
      document.getElementById('c_phone').value = '';
      document.getElementById('c_email').value = '';
      document.getElementById('c_address').value = '';
      document.getElementById('c_city').value = '';
      document.getElementById('c_state').value = '';
      document.getElementById('c_pincode').value = '';
      document.getElementById('c_gstNumber').value = '';
      // Reload customers list after adding
      customersDataLoaded = false;
      loadCustomersTab(1, '', true);
    });
    return;
  }
  
  // Load data from API
  const res=await fetchJson(API_CUSTOMERS,{headers:authHeader()});
  if(!res.ok){
    logError('loadCustomersTab', res);
    showError('c_msg', getErrorMessage(res, 'Failed to load customers'));
    return;
  }
  allCustomers=(res.data||[]).filter(c => (c.isActive === undefined || c.isActive !== false) && (c.IsActive === undefined || c.IsActive !== false) && (c.is_active === undefined || c.is_active !== false));
  customersDataLoaded = true;
  
  // Apply date filter
  let filtered = filterByDate(allCustomers, 'createdAt', customerDateFilter);
  
  // Apply search filter
  filtered = filterCustomers(filtered, searchTerm);
  
  // Sort by createdAt descending (newest first)
  filtered = filtered.sort((a, b) => {
    const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
    const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
    return dateB - dateA; // Descending order (newest first)
  });
  
  const {data,totalPages}=paginate(filtered,page,10);
  
  // Update count display
  const totalCount = filtered.length;

  const canEdit = hasPermission('edit');
  const canDelete = hasPermission('delete');
  
  let html=`<h2>Add Customer</h2>
    <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
      <input id="c_name" placeholder="Name *" style="flex:1;min-width:200px;padding:6px;" required>
      <input id="c_phone" placeholder="Phone *" style="flex:1;min-width:200px;padding:6px;" required>
      <input id="c_email" placeholder="Email" type="email" style="flex:1;min-width:200px;padding:6px;">
    </div>
    <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
      <input id="c_address" placeholder="Address *" style="flex:2;min-width:200px;padding:6px;" required>
      <input id="c_city" placeholder="City" style="flex:1;min-width:150px;padding:6px;">
      <input id="c_state" placeholder="State" style="flex:1;min-width:150px;padding:6px;">
    </div>
    <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
      <input id="c_pincode" placeholder="Pincode" style="flex:1;min-width:150px;padding:6px;">
      <input id="c_gstNumber" placeholder="GST Number" style="flex:1;min-width:200px;padding:6px;">
      <button id="btnAddCustomer" style="flex:0 0 auto;padding:6px 20px;">Add</button>
    </div>
    <div id="c_msg" class="error" style="margin-bottom:10px;"></div>
    <h3>All Customers</h3>
    <div style="margin-bottom:10px;">
      <input type="text" id="searchCustomers" placeholder="Search by name, phone, address, or ID..." style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:14px;" />
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div id="customerCount" style="color:#666;font-size:14px;">Showing ${data.length} of ${totalCount} customers${searchTerm ? ` (filtered from ${allCustomers.length} total)` : ''}</div>
      ${canEdit || canDelete ? `<div style="display:flex;gap:10px;">
        <button onclick="selectAllCustomers()" style="padding:6px 12px;background:#ecf0f1;color:#34495e;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;">Select All</button>
        <button onclick="deselectAllCustomers()" style="padding:6px 12px;background:#ecf0f1;color:#34495e;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;">Deselect All</button>
        <button onclick="bulkDeleteCustomers()" id="btnBulkDeleteCustomers" style="padding:6px 12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;display:none;">Delete Selected</button>
      </div>` : ''}
    </div>
    <table id="tblCustomers">
      <thead><tr>${canEdit || canDelete ? '<th style="width:40px;"><input type="checkbox" id="selectAllCustomers" onchange="toggleSelectAllCustomers(this)"></th>' : ''}<th>Id</th><th>Name</th><th>Phone</th><th>Email</th><th>Address</th><th>City/State</th><th>Created Date</th><th>Actions</th></tr></thead>
      <tbody>${data.map(c=>`<tr>
        ${canEdit || canDelete ? `<td><input type="checkbox" class="customer-checkbox" value="${escapeHtml(c.id)}" onchange="updateBulkDeleteButton()"></td>` : ''}
        <td>${escapeHtml(c.id)}</td>
        <td><a href="javascript:void(0)" class="customer-link" data-id="${escapeHtml(c.id)}" data-name="${escapeHtml(c.name)}" style="color:#667eea;text-decoration:none;font-weight:500;cursor:pointer;">${escapeHtml(c.name)}</a></td>
        <td>${escapeHtml(c.phone)}</td>
        <td>${escapeHtml(c.email || 'N/A')}</td>
        <td>${escapeHtml(c.address)}</td>
        <td>${escapeHtml((c.city || '') + (c.city && c.state ? ', ' : '') + (c.state || '')) || 'N/A'}</td>
        <td title="${c.createdAt ? formatDate(c.createdAt) : 'N/A'}">${c.createdAt ? formatDateOnly(c.createdAt) : 'N/A'}<br><small style="color:#7f8c8d;">${c.createdAt ? formatRelativeTime(c.createdAt) : ''}</small></td>
        <td style="display:flex;gap:5px;">
          <button class="btn-view-profile" data-id="${escapeHtml(c.id)}" data-name="${escapeHtml(c.name)}" style="padding:4px 8px;background:#9b59b6;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">View</button>
          ${canEdit ? `<button class="btn-edit" data-id="${escapeHtml(c.id)}" data-name="${escapeHtml(c.name)}" data-phone="${escapeHtml(c.phone)}" data-email="${escapeHtml(c.email || '')}" data-address="${escapeHtml(c.address)}" data-city="${escapeHtml(c.city || '')}" data-state="${escapeHtml(c.state || '')}" data-pincode="${escapeHtml(c.pincode || '')}" data-gst="${escapeHtml(c.gstNumber || '')}" style="padding:4px 8px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Edit</button>` : ''}
          ${canDelete ? `<button class="btn-delete" data-id="${escapeHtml(c.id)}" data-name="${escapeHtml(c.name)}" style="padding:4px 8px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Delete</button>` : ''}
        </td>
      </tr>`).join('')}</tbody>
    </table>
    <div id="custPagination" class="pagination"></div>`;
  tabContent.innerHTML=html;

  createPagination('custPagination',totalPages,page,(p)=>loadCustomersTab(p, searchTerm));

  // Search functionality
  const searchInput = document.getElementById('searchCustomers');
  if(searchInput){
    const debouncedSearch = debounce((term) => {
      loadCustomersTab(1, term);
    }, 300);
    
    searchInput.addEventListener('input', (e) => {
      const term = e.target.value;
      debouncedSearch(term);
    });
    
    // Set initial value if search term exists
    if(searchTerm) searchInput.value = searchTerm;
  }

  // Edit/Delete button handlers
  if(canEdit || canDelete){
    document.querySelectorAll('.btn-edit').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.dataset.id;
        const name = btn.dataset.name;
        const phone = btn.dataset.phone;
        const email = btn.dataset.email || '';
        const address = btn.dataset.address;
        const city = btn.dataset.city || '';
        const state = btn.dataset.state || '';
        const pincode = btn.dataset.pincode || '';
        const gstNumber = btn.dataset.gst || '';
        editCustomer(id, name, phone, email, address, city, state, pincode, gstNumber);
      });
    });
    
    document.querySelectorAll('.btn-delete').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.dataset.id;
        const name = btn.dataset.name;
        if(confirm(`Are you sure you want to delete customer "${name}"?`)){
          deleteCustomer(id);
        }
      });
    });
  }

  document.getElementById('btnAddCustomer').addEventListener('click',async()=>{
    clearMessage('c_msg');
    const name=document.getElementById('c_name').value.trim();
    const phone=document.getElementById('c_phone').value.trim();
    const email=document.getElementById('c_email').value.trim();
    const address=document.getElementById('c_address').value.trim();
    const city=document.getElementById('c_city').value.trim();
    const state=document.getElementById('c_state').value.trim();
    const pincode=document.getElementById('c_pincode').value.trim();
    const gstNumber=document.getElementById('c_gstNumber').value.trim();
    
    // Check if in edit mode
    if(editingCustomerId){
      const validation = validateCustomerForm({name, phone, address});
      if(!validation.valid){
        showError('c_msg', validation.errors.map(e => e.message).join(', '));
        return;
      }
      await updateCustomer(editingCustomerId, name, phone, email, address, city, state, pincode, gstNumber);
      return;
    }
    
    // Add new customer
    const validation = validateCustomerForm({name, phone, address});
    if(!validation.valid){
      const errorMsg = validation.errors.map(e => e.message).join(', ');
      showError('c_msg', errorMsg);
      return;
    }
    
    const payload={
      name,
      phone,
      email: email || null,
      address,
      city: city || null,
      state: state || null,
      pincode: pincode || null,
      gstNumber: gstNumber || null
    };
    setButtonLoading('btnAddCustomer', 'Adding...');
    showLoading('c_msg', 'Adding customer...');
    const r=await fetchJson(API_CUSTOMERS,{method:'POST',headers:authHeader(),body:JSON.stringify(payload)});
    removeButtonLoading('btnAddCustomer');
    if(handleApiError(r, 'c_msg', 'Failed to add customer')) return;
      showSuccess('c_msg', 'Customer added successfully!');
      document.getElementById('c_name').value = '';
      document.getElementById('c_phone').value = '';
      document.getElementById('c_email').value = '';
      document.getElementById('c_address').value = '';
      document.getElementById('c_city').value = '';
      document.getElementById('c_state').value = '';
      document.getElementById('c_pincode').value = '';
      document.getElementById('c_gstNumber').value = '';
      customersDataLoaded = false;
      loadCustomersTab(1, '', true);
  });
}

// ----- Bills Tab - Edit/Delete Functions -----
let editingBillId = null;

async function editBill(id, customerId, billNumber, amount, billDate, notes, status){
  if(!hasPermission('edit')){
    showError('bill_msg', 'You do not have permission to edit bills');
    return;
  }
  
  editingBillId = id;
  // Pre-fill form with bill data
  document.getElementById('bill_customer').value = customerId;
  document.getElementById('bill_number').value = billNumber || '';
  document.getElementById('bill_amount').value = amount;
  if(billDate){
    const date = new Date(billDate);
    document.getElementById('bill_date').value = date.toISOString().split('T')[0];
  }
  document.getElementById('bill_notes').value = notes || '';
  document.getElementById('bill_status').value = status || 'Unpaid';
  
  // Change button to "Update" mode
  const btn = document.getElementById('btnAddBill');
  btn.innerText = 'Update';
  btn.dataset.mode = 'update';
  
  // Scroll to form
  document.getElementById('bill_customer').scrollIntoView({behavior:'smooth', block:'center'});
  showSuccess('bill_msg', 'Edit mode: Update the fields and click Update');
}

async function updateBill(id, customerId, billNumber, amount, billDate, notes, status){
  setButtonLoading('btnAddBill', 'Updating...');
  showLoading('bill_msg', 'Updating bill...');
  const payload = {
    customerId, 
    billNumber: billNumber || null,
    billAmount: amount, 
    billDate: billDate || new Date().toISOString(),
    notes: notes || null, 
    status: status || 'Unpaid'
  };
  const r = await fetchJson(`${API_BILLS}/${id}`, {method:'PUT', headers:authHeader(), body:JSON.stringify(payload)});
  removeButtonLoading('btnAddBill');
  if(handleApiError(r, 'bill_msg', 'Failed to update bill')) return;
  
  showSuccess('bill_msg', 'Bill updated successfully!');
  editingBillId = null;
  // Reset form and button
  document.getElementById('bill_customer').value = '';
  document.getElementById('bill_number').value = '';
  document.getElementById('bill_amount').value = '';
  document.getElementById('bill_date').value = '';
  document.getElementById('bill_notes').value = '';
  document.getElementById('bill_status').value = '';
  const btn = document.getElementById('btnAddBill');
  btn.innerText = 'Add';
  btn.dataset.mode = 'add';
  billsDataLoaded = false;
  loadBillsTab(1, '', true);
}

async function deleteBill(id){
  if(!hasPermission('delete')){
    showError('bill_msg', 'You do not have permission to delete bills');
    return;
  }
  
  showLoading('bill_msg', 'Deleting bill...');
  showLoadingOverlay();
  const r = await fetchJson(`${API_BILLS}/${id}`, {method:'DELETE', headers:authHeader()});
  hideLoadingOverlay();
  
  // Handle case where DELETE endpoint might not be implemented yet
  if(r.status === 404 || r.status === 405){
    showError('bill_msg', 'Delete endpoint not available yet. Please check API documentation.');
    logError('deleteBill', {message: 'DELETE endpoint not implemented', status: r.status});
    return;
  }
  
  // Check API response status (even if HTTP status is 200, API might return status: false)
  if(!r.ok || (r.apiResponse && r.apiResponse.status === false)){
    const errorMsg = r.apiResponse?.message || getErrorMessage(r, 'Failed to delete bill');
    showError('bill_msg', errorMsg);
    logError('deleteBill', {response: r, apiResponse: r.apiResponse});
    return;
  }
  
  showSuccess('bill_msg', 'Bill deleted successfully!');
  billsDataLoaded = false;
  loadBillsTab(1, '', true);
}

// ----- Bills Tab -----
let allBills = []; // Store all bills for filtering
let allCustomersForBills = []; // Store customers for bill filtering
let billDateFilter = { from: null, to: null };

function applyBillDateFilter(){
  const fromDate = document.getElementById('billFromDate').value;
  const toDate = document.getElementById('billToDate').value;
  billDateFilter = { from: fromDate || null, to: toDate || null };
  loadBillsTab(1, document.getElementById('searchBills')?.value || '');
}

function clearBillDateFilter(){
  document.getElementById('billFromDate').value = '';
  document.getElementById('billToDate').value = '';
  billDateFilter = { from: null, to: null };
  loadBillsTab(1, document.getElementById('searchBills')?.value || '');
}

let billsDataLoaded = false;

async function loadBillsTab(page=1, searchTerm='', forceLoad=false){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  // If data not loaded and not forced, show button to load
  if(!billsDataLoaded && !forceLoad){
    const canEdit = hasPermission('edit');
    const canDelete = hasPermission('delete');
    
    const html = `
      <div id="bills-content">
        <h2>Add Bill</h2>
        <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
          <select id="bill_customer" style="flex:1;min-width:200px;padding:6px;" required>
            <option value="">Select customer *</option>
          </select>
          <input id="bill_number" placeholder="Bill Number (auto if empty)" style="flex:1;min-width:150px;padding:6px;">
          <input id="bill_amount" placeholder="Amount *" type="number" step="0.01" style="flex:1;min-width:150px;padding:6px;" required>
          <input type="date" id="bill_date" style="flex:1;min-width:150px;padding:6px;">
        </div>
        <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
          <input id="bill_notes" placeholder="Notes" style="flex:2;min-width:200px;padding:6px;">
          <select id="bill_status" style="flex:1;min-width:150px;padding:6px;">
            <option value="">Status (default: Unpaid)</option>
            <option value="Unpaid">Unpaid</option>
            <option value="Partial">Partial</option>
            <option value="Paid">Paid</option>
          </select>
          <button id="btnAddBill" style="flex:0 0 auto;padding:6px 20px;">Add</button>
        </div>
        <div id="bill_msg" class="error" style="margin-bottom:10px;"></div>
        <div style="text-align:center;padding:40px;background:var(--bg-secondary);border-radius:12px;border:2px dashed var(--border-color);">
          <h3 style="color:var(--text-primary);margin-bottom:15px;">All Bills</h3>
          <p style="color:var(--text-secondary);margin-bottom:20px;">Click the button below to load bills data</p>
          <button onclick="loadBillsTab(1, '', true)" style="padding:12px 30px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem;box-shadow:0 4px 15px rgba(102,126,234,0.3);">üìã Load All Bills</button>
        </div>
      </div>
    `;
    tabContent.innerHTML = html;
    
    // Load customers for dropdown (minimal call)
    fetchJson(API_CUSTOMERS,{headers:authHeader()}).then(custRes => {
      if(custRes.ok && custRes.data){
        const customers = (custRes.data||[]).filter(c => (c.isActive === undefined || c.isActive !== false) && (c.IsActive === undefined || c.IsActive !== false) && (c.is_active === undefined || c.is_active !== false));
        const select = document.getElementById('bill_customer');
        if(select){
          select.innerHTML = '<option value="">Select customer *</option>' + customers.map(c=>`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join('');
        }
      }
    }).catch(err => logError('loadCustomersForBills', err));
    
    // Setup add bill form
    document.getElementById('btnAddBill').addEventListener('click',async()=>{
      clearMessage('bill_msg');
      const customerId=parseInt(document.getElementById('bill_customer').value);
      const billNumber=document.getElementById('bill_number').value.trim();
      const amount=parseFloat(document.getElementById('bill_amount').value);
      const billDate=document.getElementById('bill_date').value;
      const notes=document.getElementById('bill_notes').value.trim();
      const status=document.getElementById('bill_status').value||'Unpaid';
      
      if(editingBillId){
        const validation = validateBillForm({customerId, billAmount: amount, notes, status});
        if(!validation.valid){
          showError('bill_msg', validation.errors.map(e => e.message).join(', '));
          return;
        }
        await updateBill(editingBillId, customerId, billNumber, amount, billDate, notes, status);
        return;
      }
      
      const validation = validateBillForm({customerId, billAmount: amount, notes, status});
      if(!validation.valid){
        const errorMsg = validation.errors.map(e => e.message).join(', ');
        showError('bill_msg', errorMsg);
        return;
      }
      
      const payload={customerId, billNumber: billNumber || null, billAmount: amount, billDate: billDate ? new Date(billDate).toISOString() : new Date().toISOString(), notes: notes || null, status: status};
      setButtonLoading('btnAddBill', 'Adding...');
      showLoading('bill_msg', 'Adding bill...');
      const r=await fetchJson(API_BILLS,{method:'POST',headers:authHeader(),body:JSON.stringify(payload)});
      removeButtonLoading('btnAddBill');
      if(handleApiError(r, 'bill_msg', 'Failed to add bill')) return;
      showSuccess('bill_msg', 'Bill added successfully!');
      document.getElementById('bill_customer').value = '';
      document.getElementById('bill_number').value = '';
      document.getElementById('bill_amount').value = '';
      document.getElementById('bill_date').value = '';
      document.getElementById('bill_notes').value = '';
      document.getElementById('bill_status').value = '';
      billsDataLoaded = false;
      loadBillsTab(1, '', true);
    });
    return;
  }
  
  const [custRes,billRes]=await Promise.all([
    fetchJson(API_CUSTOMERS,{headers:authHeader()}),
    fetchJson(API_BILLS,{headers:authHeader()})
  ]);
  billsDataLoaded = true;
  if(!custRes.ok || !billRes.ok){
    logError('loadBillsTab', {custRes, billRes});
    showError('bill_msg', getErrorMessage(custRes.ok ? billRes : custRes, 'Failed to load data'));
    return;
  }
  allCustomersForBills = (custRes.data||[]).filter(c => (c.isActive === undefined || c.isActive !== false) && (c.IsActive === undefined || c.IsActive !== false) && (c.is_active === undefined || c.is_active !== false));
  allBills = (billRes.data||[]).filter(b => (b.isActive === undefined || b.isActive !== false) && (b.IsActive === undefined || b.IsActive !== false) && (b.is_active === undefined || b.is_active !== false));
  
  // Get customer names for display and filtering
  const customerMap = {};
  allCustomersForBills.forEach(c => { customerMap[c.id] = c.name; });
  
  // Apply date filter (use billDate or createdAt)
  let filtered = allBills;
  if(billDateFilter.from || billDateFilter.to){
    filtered = filtered.filter(b => {
      const dateField = b.billDate || b.createdAt;
      if(!dateField) return false;
      const itemDate = new Date(dateField);
      if(billDateFilter.from){
        const fromDate = new Date(billDateFilter.from);
        fromDate.setHours(0,0,0,0);
        if(itemDate < fromDate) return false;
      }
      if(billDateFilter.to){
        const toDate = new Date(billDateFilter.to);
        toDate.setHours(23,59,59,999);
        if(itemDate > toDate) return false;
      }
      return true;
    });
  }
  
  // Apply search filter
  filtered = filterBills(filtered, searchTerm, customerMap);
  
  // Sort by billDate or createdAt descending (newest first)
  filtered = filtered.sort((a, b) => {
    const dateA = a.billDate ? new Date(a.billDate) : (a.createdAt ? new Date(a.createdAt) : new Date(0));
    const dateB = b.billDate ? new Date(b.billDate) : (b.createdAt ? new Date(b.createdAt) : new Date(0));
    return dateB - dateA; // Descending order (newest first)
  });
  
  const {data,totalPages}=paginate(filtered,page,10);

  const canEdit = hasPermission('edit');
  const canDelete = hasPermission('delete');

  let html=`<h2>Add Bill</h2>
    <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
      <select id="bill_customer" style="flex:1;min-width:200px;padding:6px;" required>
        <option value="">Select customer *</option>
        ${allCustomersForBills.map(c=>`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join('')}
      </select>
      <input id="bill_number" placeholder="Bill Number (auto if empty)" style="flex:1;min-width:150px;padding:6px;">
      <input id="bill_amount" placeholder="Amount *" type="number" step="0.01" style="flex:1;min-width:150px;padding:6px;" required>
      <input type="date" id="bill_date" style="flex:1;min-width:150px;padding:6px;">
    </div>
    <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
      <input id="bill_notes" placeholder="Notes" style="flex:2;min-width:200px;padding:6px;">
      <select id="bill_status" style="flex:1;min-width:150px;padding:6px;">
        <option value="">Status (default: Unpaid)</option>
        <option value="Unpaid">Unpaid</option>
        <option value="Partial">Partial</option>
        <option value="Paid">Paid</option>
      </select>
      <button id="btnAddBill" style="flex:0 0 auto;padding:6px 20px;">Add</button>
    </div>
    <div id="bill_msg" class="error" style="margin-bottom:10px;"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
      <h3 style="margin:0;">All Bills</h3>
      <button onclick="exportBillsData()" style="padding:8px 16px;background:linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;box-shadow:0 2px 8px rgba(39,174,96,0.3);">
        üì• Export CSV
      </button>
    </div>
    <!-- Date Filter Section -->
    <div class="date-filter-section" style="margin-bottom:15px;">
      <div class="date-filter-row">
        <div class="date-filter-group">
          <label>From Date</label>
          <input type="date" id="billFromDate" />
        </div>
        <div class="date-filter-group">
          <label>To Date</label>
          <input type="date" id="billToDate" />
        </div>
        <div class="date-filter-actions">
          <button onclick="applyBillDateFilter()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;">Apply Filter</button>
          <button onclick="clearBillDateFilter()" class="clear-btn">Clear</button>
        </div>
      </div>
    </div>
    <div style="margin-bottom:10px;">
      <input type="text" id="searchBills" placeholder="Search by ID, customer, amount, status, or notes..." style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:14px;" />
    </div>
    <div id="billCount" style="margin-bottom:5px;color:#666;font-size:14px;">Showing ${data.length} of ${filtered.length} bills${searchTerm ? ` (filtered from ${allBills.length} total)` : ''}</div>
    <table id="tblBills">
      <thead><tr>${canEdit || canDelete ? '<th style="width:40px;"><input type="checkbox" id="selectAllBills" onchange="toggleSelectAllBills(this)"></th>' : ''}<th>Id</th><th>Bill #</th><th>Customer</th><th>Amount</th><th>Status</th><th>Bill Date</th><th>Notes</th>${canEdit || canDelete ? '<th>Actions</th>' : ''}</tr></thead>
      <tbody>${data.map(b=>`<tr>
        ${canEdit || canDelete ? `<td><input type="checkbox" class="bill-checkbox" value="${escapeHtml(b.id)}" onchange="updateBulkDeleteBillsButton()"></td>` : ''}
        <td>${escapeHtml(b.id)}</td>
        <td><a href="javascript:void(0)" class="bill-link" data-bill-id="${escapeHtml(b.id)}" style="color:#667eea;text-decoration:none;font-weight:500;cursor:pointer;">${escapeHtml(b.billNumber || 'N/A')}</a></td>
        <td><a href="javascript:void(0)" class="bill-link" data-bill-id="${escapeHtml(b.id)}" style="color:#667eea;text-decoration:none;font-weight:500;cursor:pointer;">${escapeHtml(customerMap[b.customerId] || b.customerId)}</a></td>
        <td><a href="javascript:void(0)" class="bill-link" data-bill-id="${escapeHtml(b.id)}" style="color:#667eea;text-decoration:none;font-weight:500;cursor:pointer;">‚Çπ${parseFloat(b.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</a></td>
        <td><span style="padding:4px 8px;border-radius:4px;font-size:0.85rem;font-weight:500;background:${b.status === 'Pending' || b.status === 'pending' ? '#fff3cd' : b.status === 'Paid' || b.status === 'paid' ? '#d4edda' : '#e2e3e5'};color:${b.status === 'Pending' || b.status === 'pending' ? '#856404' : b.status === 'Paid' || b.status === 'paid' ? '#155724' : '#383d41'};">${escapeHtml(b.status || 'N/A')}</span></td>
        <td title="${b.billDate ? formatDate(b.billDate) : 'N/A'}">${b.billDate ? formatDateOnly(b.billDate) : 'N/A'}<br><small style="color:#7f8c8d;">${b.billDate ? formatRelativeTime(b.billDate) : ''}</small></td>
        <td>${escapeHtml(b.notes||'')}</td>
        ${canEdit || canDelete ? `<td style="display:flex;gap:5px;">
          ${canEdit ? `<button class="btn-edit-bill" data-id="${escapeHtml(b.id)}" data-customer="${escapeHtml(b.customerId)}" data-billnumber="${escapeHtml(b.billNumber||'')}" data-amount="${escapeHtml(b.billAmount)}" data-billdate="${escapeHtml(b.billDate||'')}" data-notes="${escapeHtml(b.notes||'')}" data-status="${escapeHtml(b.status)}" style="padding:4px 8px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Edit</button>` : ''}
          ${canDelete ? `<button class="btn-delete-bill" data-id="${escapeHtml(b.id)}" data-amount="${escapeHtml(b.billAmount)}" style="padding:4px 8px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Delete</button>` : ''}
        </td>` : ''}
      </tr>`).join('')}</tbody>
    </table>
    <div id="billPagination" class="pagination"></div>`;
  tabContent.innerHTML=html;

  createPagination('billPagination',totalPages,page,(p)=>loadBillsTab(p, searchTerm));

  // Search functionality
  const searchInput = document.getElementById('searchBills');
  if(searchInput){
    const debouncedSearch = debounce((term) => {
      loadBillsTab(1, term);
    }, 300);
    
    searchInput.addEventListener('input', (e) => {
      const term = e.target.value;
      debouncedSearch(term);
    });
    
    // Set initial value if search term exists
    if(searchTerm) searchInput.value = searchTerm;
  }

  // Bill link click handlers (open bill details)
  document.querySelectorAll('.bill-link').forEach(link=>{
    link.addEventListener('click',()=>{
      const billId = parseInt(link.dataset.billId);
      showBillDetails(billId);
    });
  });

  // Edit/Delete button handlers
  if(canEdit || canDelete){
    document.querySelectorAll('.btn-edit-bill').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.dataset.id;
        const customerId = parseInt(btn.dataset.customer);
        const billNumber = btn.dataset.billnumber || '';
        const amount = parseFloat(btn.dataset.amount);
        const billDate = btn.dataset.billdate || '';
        const notes = btn.dataset.notes;
        const status = btn.dataset.status;
        editBill(id, customerId, billNumber, amount, billDate, notes, status);
      });
    });
    
    document.querySelectorAll('.btn-delete-bill').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.dataset.id;
        const amount = btn.dataset.amount;
        if(confirm(`Are you sure you want to delete bill #${id} (Amount: ${amount})?`)){
          deleteBill(id);
        }
      });
    });
  }

  document.getElementById('btnAddBill').addEventListener('click',async()=>{
    clearMessage('bill_msg');
    const customerId=parseInt(document.getElementById('bill_customer').value);
    const billNumber=document.getElementById('bill_number').value.trim();
    const amount=parseFloat(document.getElementById('bill_amount').value);
    const billDate=document.getElementById('bill_date').value;
    const notes=document.getElementById('bill_notes').value.trim();
    const status=document.getElementById('bill_status').value||'Unpaid';
    
    // Check if in edit mode
    if(editingBillId){
      const validation = validateBillForm({customerId, billAmount: amount, notes, status});
      if(!validation.valid){
        showError('bill_msg', validation.errors.map(e => e.message).join(', '));
        return;
      }
      await updateBill(editingBillId, customerId, billNumber, amount, billDate, notes, status);
      return;
    }
    
    // Add new bill
    const validation = validateBillForm({customerId, billAmount: amount, notes, status});
    if(!validation.valid){
      const errorMsg = validation.errors.map(e => e.message).join(', ');
      showError('bill_msg', errorMsg);
      return;
    }
    
    const payload={
      customerId,
      billNumber: billNumber || null,
      billAmount: amount,
      billDate: billDate ? new Date(billDate).toISOString() : new Date().toISOString(),
      notes: notes || null,
      status: status
    };
    setButtonLoading('btnAddBill', 'Adding...');
    showLoading('bill_msg', 'Adding bill...');
    const r=await fetchJson(API_BILLS,{method:'POST',headers:authHeader(),body:JSON.stringify(payload)});
    removeButtonLoading('btnAddBill');
    if(handleApiError(r, 'bill_msg', 'Failed to add bill')) return;
    showSuccess('bill_msg', 'Bill added successfully!');
    document.getElementById('bill_customer').value = '';
    document.getElementById('bill_number').value = '';
    document.getElementById('bill_amount').value = '';
    document.getElementById('bill_date').value = '';
    document.getElementById('bill_notes').value = '';
    document.getElementById('bill_status').value = '';
    billsDataLoaded = false;
    loadBillsTab(1, '', true);
  });
}

// ----- Payments Tab - Edit/Delete Functions -----
let editingPaymentId = null;

async function editPayment(id, customerId, billId, amount, mode, cheque){
  if(!hasPermission('edit')){
    showError('pay_msg', 'You do not have permission to edit payments');
    return;
  }
  
  editingPaymentId = id;
  // Pre-fill form with payment data
  document.getElementById('pay_customer').value = customerId;
  // Trigger change to load bills
  document.getElementById('pay_customer').dispatchEvent(new Event('change'));
  setTimeout(() => {
    document.getElementById('pay_bill').value = billId;
    document.getElementById('pay_amount').value = amount;
    document.getElementById('pay_mode').value = mode;
    document.getElementById('pay_cheque').value = cheque || '';
  }, 100);
  
  // Change button to "Update" mode
  const btn = document.getElementById('btnAddPayment');
  btn.innerText = 'Update';
  btn.dataset.mode = 'update';
  
  // Scroll to form
  document.getElementById('pay_customer').scrollIntoView({behavior:'smooth', block:'center'});
  showSuccess('pay_msg', 'Edit mode: Update the fields and click Update');
}

async function updatePayment(id, customerId, billId, amount, mode, cheque){
  setButtonLoading('btnAddPayment', 'Updating...');
  showLoading('pay_msg', 'Updating payment...');
  const payload = {customerId, billId, amount, mode, chequeNumber: cheque, cleared: false};
  const r = await fetchJson(`${API_PAYMENTS}/${id}`, {method:'PUT', headers:authHeader(), body:JSON.stringify(payload)});
  removeButtonLoading('btnAddPayment');
  if(handleApiError(r, 'pay_msg', 'Failed to update payment')) return;
  
  showSuccess('pay_msg', 'Payment updated successfully!');
  editingPaymentId = null;
  // Reset form and button
  document.getElementById('pay_amount').value = '';
  document.getElementById('pay_cheque').value = '';
  const btn = document.getElementById('btnAddPayment');
  btn.innerText = 'Save';
  btn.dataset.mode = 'add';
  paymentsDataLoaded = false;
  loadPaymentsTab(1, '', true);
}

async function deletePayment(id){
  if(!hasPermission('delete')){
    showError('pay_msg', 'You do not have permission to delete payments');
    return;
  }
  
  showLoading('pay_msg', 'Deleting payment...');
  showLoadingOverlay();
  const r = await fetchJson(`${API_PAYMENTS}/${id}`, {method:'DELETE', headers:authHeader()});
  hideLoadingOverlay();
  
  // Handle case where DELETE endpoint might not be implemented yet
  if(r.status === 404 || r.status === 405){
    showError('pay_msg', 'Delete endpoint not available yet. Please check API documentation.');
    logError('deletePayment', {message: 'DELETE endpoint not implemented', status: r.status});
    return;
  }
  
  if(handleApiError(r, 'pay_msg', 'Failed to delete payment')) return;
  
  showSuccess('pay_msg', 'Payment deleted successfully!');
  paymentsDataLoaded = false;
  loadPaymentsTab(1, '', true);
}

// ----- Payments Tab -----
let allPayments = []; // Store all payments for filtering
let paymentDateFilter = { from: null, to: null };
let selectedBillsForPayment = []; // Store selected bills for multi-bill payment

function toggleMultiBillMode(){
  const enableMultiBill = document.getElementById('enableMultiBill').checked;
  const multiBillSection = document.getElementById('multiBillSection');
  const payBill = document.getElementById('pay_bill');
  
  if(enableMultiBill){
    multiBillSection.style.display = 'block';
    payBill.disabled = true;
    payBill.style.opacity = '0.5';
    loadBillsForMultiPayment();
  } else {
    multiBillSection.style.display = 'none';
    payBill.disabled = false;
    payBill.style.opacity = '1';
    selectedBillsForPayment = [];
    updateTotalBillAmount();
  }
}

async function loadBillsForMultiPayment(){
  const customerId = parseInt(document.getElementById('pay_customer').value);
  if(!customerId) {
    document.getElementById('billsCheckboxList').innerHTML = '<p style="color:#7f8c8d;padding:10px;">Please select a customer first</p>';
    return;
  }
  
  try {
    const billsRes = await fetchJson(`${API_BILLS}/customer/${customerId}`, {headers:authHeader()});
    if(!billsRes.ok || !billsRes.data){
      document.getElementById('billsCheckboxList').innerHTML = '<p style="color:#e74c3c;padding:10px;">Failed to load bills</p>';
      return;
    }
    
    const bills = billsRes.data || [];
    const unpaidBills = bills.filter(b => b.status !== 'Paid' && b.status !== 'paid');
    
    if(unpaidBills.length === 0){
      document.getElementById('billsCheckboxList').innerHTML = '<p style="color:#7f8c8d;padding:10px;">No unpaid bills for this customer</p>';
      return;
    }
    
    const html = unpaidBills.map(bill => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px;background:#fff;border-radius:6px;margin-bottom:8px;border:1px solid #e0e0e0;">
        <input type="checkbox" class="bill-checkbox-payment" data-bill-id="${bill.id}" data-bill-amount="${bill.billAmount}" data-bill-number="${escapeHtml(bill.billNumber || bill.id)}" onchange="updateBillSelection()" style="width:18px;height:18px;">
        <div style="flex:1;">
          <strong>Bill #${escapeHtml(bill.billNumber || bill.id)}</strong> - ‚Çπ${parseFloat(bill.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}
          <div style="font-size:0.85rem;color:#7f8c8d;">Status: ${escapeHtml(bill.status || 'Unpaid')}</div>
        </div>
        <input type="number" step="0.01" class="bill-amount-input" data-bill-id="${bill.id}" placeholder="Amount" value="${bill.billAmount}" max="${bill.billAmount}" min="0.01" onchange="updateBillSelection()" style="width:120px;padding:6px;border:1px solid #ddd;border-radius:4px;">
      </div>
    `).join('');
    
    document.getElementById('billsCheckboxList').innerHTML = html;
    updateTotalBillAmount();
  } catch(err){
    logError('loadBillsForMultiPayment', err);
    document.getElementById('billsCheckboxList').innerHTML = '<p style="color:#e74c3c;padding:10px;">Error loading bills</p>';
  }
}

function updateBillSelection(){
  const checkboxes = document.querySelectorAll('.bill-checkbox-payment:checked');
  selectedBillsForPayment = [];
  
  checkboxes.forEach(checkbox => {
    const billId = parseInt(checkbox.dataset.billId);
    const billAmount = parseFloat(checkbox.dataset.billAmount);
    const billNumber = checkbox.dataset.billNumber;
    const amountInput = document.querySelector(`.bill-amount-input[data-bill-id="${billId}"]`);
    const amount = parseFloat(amountInput.value) || billAmount;
    
    if(amount > 0 && amount <= billAmount){
      selectedBillsForPayment.push({
        billId: billId,
        amount: amount,
        billNumber: billNumber
      });
    }
  });
  
  updateTotalBillAmount();
  // Auto-update payment amount field
  const total = selectedBillsForPayment.reduce((sum, b) => sum + b.amount, 0);
  document.getElementById('pay_amount').value = total.toFixed(2);
}

function updateTotalBillAmount(){
  const total = selectedBillsForPayment.reduce((sum, b) => sum + b.amount, 0);
  document.getElementById('totalBillAmount').textContent = total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function clearMultiBillSelection(){
  document.querySelectorAll('.bill-checkbox-payment').forEach(cb => cb.checked = false);
  document.querySelectorAll('.bill-amount-input').forEach(input => {
    const billAmount = parseFloat(input.dataset.billAmount || input.max);
    input.value = billAmount;
  });
  selectedBillsForPayment = [];
  updateTotalBillAmount();
  document.getElementById('pay_amount').value = '';
}

function applyPaymentDateFilter(){
  const fromDate = document.getElementById('paymentFromDate').value;
  const toDate = document.getElementById('paymentToDate').value;
  paymentDateFilter = { from: fromDate || null, to: toDate || null };
  loadPaymentsTab(1, document.getElementById('searchPayments')?.value || '');
}

function clearPaymentDateFilter(){
  document.getElementById('paymentFromDate').value = '';
  document.getElementById('paymentToDate').value = '';
  paymentDateFilter = { from: null, to: null };
  loadPaymentsTab(1, document.getElementById('searchPayments')?.value || '');
}

let paymentsDataLoaded = false;

async function loadPaymentsTab(page=1, searchTerm='', forceLoad=false){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  // If data not loaded and not forced, show button to load
  if(!paymentsDataLoaded && !forceLoad){
    const html = `
      <div id="payments-content">
        <h2>Record Payment</h2>
        <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
          <select id="pay_customer" style="flex:1;min-width:200px;padding:6px;" required>
            <option value="">Select Customer *</option>
          </select>
          <input type="date" id="pay_date" style="flex:1;min-width:150px;padding:6px;" value="${new Date().toISOString().split('T')[0]}">
          <select id="pay_mode" style="flex:1;min-width:120px;padding:6px;" required>
            <option value="">Payment Mode *</option>
            <option value="Cash">Cash</option>
            <option value="UPI">UPI</option>
            <option value="Cheque">Cheque</option>
            <option value="Card">Card</option>
          </select>
          <input id="pay_reference" placeholder="Payment Reference" style="flex:1;min-width:150px;padding:6px;">
        </div>
        <div id="pay_msg" class="error" style="margin-bottom:10px;"></div>
        <div style="text-align:center;padding:40px;background:var(--bg-secondary);border-radius:12px;border:2px dashed var(--border-color);">
          <h3 style="color:var(--text-primary);margin-bottom:15px;">All Payments</h3>
          <p style="color:var(--text-secondary);margin-bottom:20px;">Click the button below to load payments data</p>
          <button onclick="loadPaymentsTab(1, '', true)" style="padding:12px 30px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem;box-shadow:0 4px 15px rgba(102,126,234,0.3);">üìã Load All Payments</button>
        </div>
      </div>
    `;
    tabContent.innerHTML = html;
    
    // Load customers for dropdown (minimal call)
    fetchJson(API_CUSTOMERS,{headers:authHeader()}).then(custRes => {
      if(custRes.ok && custRes.data){
        const customers = (custRes.data||[]).filter(c => (c.isActive === undefined || c.isActive !== false) && (c.IsActive === undefined || c.IsActive !== false) && (c.is_active === undefined || c.is_active !== false));
        const select = document.getElementById('pay_customer');
        if(select){
          select.innerHTML = '<option value="">Select Customer *</option>' + customers.map(c=>`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join('');
        }
      }
    }).catch(err => logError('loadCustomersForPayments', err));
    return;
  }
  
  try {
    const [custRes,billRes,payRes]=await Promise.all([
      fetchJson(API_CUSTOMERS,{headers:authHeader()}),
      fetchJson(API_BILLS,{headers:authHeader()}),
      fetchJson(API_PAYMENTS,{headers:authHeader()})
    ]);
    paymentsDataLoaded = true;
    
    if(!custRes.ok || !billRes.ok || !payRes.ok){
      logError('loadPaymentsTab', {custRes, billRes, payRes});
      
      // Show specific error for each failed API
      const errors = [];
      if(!custRes.ok) errors.push(`Customers: ${getErrorMessage(custRes, 'Failed to load customers')}`);
      if(!billRes.ok) errors.push(`Bills: ${getErrorMessage(billRes, 'Failed to load bills')}`);
      if(!payRes.ok) errors.push(`Payments: ${getErrorMessage(payRes, 'Failed to load payments')}`);
      
      showError('pay_msg', errors.join(' | '));
      
      // If authentication failed, redirect to login
      if((custRes.status === 401) || (billRes.status === 401) || (payRes.status === 401)){
        setTimeout(() => {
          logoutAndRedirect();
        }, 2000);
      }
      return;
    }
    const customers=(custRes.data||[]).filter(c => (c.isActive === undefined || c.isActive !== false) && (c.IsActive === undefined || c.IsActive !== false) && (c.is_active === undefined || c.is_active !== false));
    const bills=(billRes.data||[]).filter(b => (b.isActive === undefined || b.isActive !== false) && (b.IsActive === undefined || b.IsActive !== false) && (b.is_active === undefined || b.is_active !== false));
    allPayments=(payRes.data||[]).filter(p => (p.isActive === undefined || p.isActive !== false) && (p.IsActive === undefined || p.IsActive !== false) && (p.is_active === undefined || p.is_active !== false));
    
    // Apply date filter (use paymentDate or createdAt)
    let filtered = allPayments;
    if(paymentDateFilter.from || paymentDateFilter.to){
      filtered = filtered.filter(p => {
        const dateField = p.paymentDate || p.createdAt;
        if(!dateField) return false;
        const itemDate = new Date(dateField);
        if(paymentDateFilter.from){
          const fromDate = new Date(paymentDateFilter.from);
          fromDate.setHours(0,0,0,0);
          if(itemDate < fromDate) return false;
        }
        if(paymentDateFilter.to){
          const toDate = new Date(paymentDateFilter.to);
          toDate.setHours(23,59,59,999);
          if(itemDate > toDate) return false;
        }
        return true;
      });
    }
    
    // Apply search filter
    filtered = filterPayments(filtered, searchTerm);
    
    // Sort by paymentDate or createdAt descending (newest first)
    filtered = filtered.sort((a, b) => {
      const dateA = a.paymentDate ? new Date(a.paymentDate) : (a.createdAt ? new Date(a.createdAt) : new Date(0));
      const dateB = b.paymentDate ? new Date(b.paymentDate) : (b.createdAt ? new Date(b.createdAt) : new Date(0));
      return dateB - dateA; // Descending order (newest first)
    });
    
    const {data,totalPages}=paginate(filtered,page,10);
    
    // Update count display
    const totalPaymentCount = filtered.length;

    const canEdit = hasPermission('edit');
    const canDelete = hasPermission('delete');

    let html=`<h2>Record Payment</h2>
    <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
      <select id="pay_customer" style="flex:1;min-width:200px;padding:6px;" required>
        <option value="">Select Customer *</option>
        ${customers.map(c=>`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join('')}
      </select>
      <input type="date" id="pay_date" style="flex:1;min-width:150px;padding:6px;" value="${new Date().toISOString().split('T')[0]}">
      <select id="pay_mode" style="flex:1;min-width:120px;padding:6px;" required>
        <option value="">Payment Mode *</option>
        <option value="Cash">Cash</option>
        <option value="UPI">UPI</option>
        <option value="Cheque">Cheque</option>
        <option value="Card">Card</option>
      </select>
      <input id="pay_reference" placeholder="Payment Reference" style="flex:1;min-width:150px;padding:6px;">
    </div>
    <div id="multiBillSection" style="margin-bottom:15px;padding:15px;background:#f8f9fa;border-radius:8px;display:none;">
      <h4 style="margin:0 0 10px 0;color:#2c3e50;">Select Bills to Pay (Multi-Bill Payment)</h4>
      <div id="billsCheckboxList" style="max-height:200px;overflow-y:auto;margin-bottom:10px;"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Total Amount: ‚Çπ<span id="totalBillAmount">0.00</span></strong>
        <button type="button" onclick="clearMultiBillSelection()" style="padding:6px 12px;background:#ecf0f1;color:#34495e;border:none;border-radius:6px;cursor:pointer;">Clear Selection</button>
      </div>
    </div>
    <div class="form-row" style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
      <select id="pay_bill" style="flex:1;min-width:200px;padding:6px;">
        <option value="">Select Primary Bill (or use multi-bill above)</option>
        ${bills.map(b => {
          const customerName = customers.find(c => c.id === b.customerId)?.name || `Customer ${b.customerId}`;
          return `<option value="${escapeHtml(b.id)}" data-customer-id="${escapeHtml(b.customerId)}">${escapeHtml(b.billNumber || `Bill #${b.id}`)} - ${escapeHtml(customerName)} - ‚Çπ${parseFloat(b.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</option>`;
        }).join('')}
      </select>
      <input id="pay_amount" placeholder="Amount *" type="number" step="0.01" style="flex:1;min-width:150px;padding:6px;" required>
      <div id="chequeFields" style="display:none;flex:1;gap:10px;flex-wrap:wrap;">
        <input id="pay_cheque" placeholder="Cheque Number *" style="flex:1;min-width:150px;padding:6px;">
        <input type="date" id="pay_cheque_date" placeholder="Cheque Clear Date" style="flex:1;min-width:150px;padding:6px;">
      </div>
      <input id="pay_notes" placeholder="Notes" style="flex:1;min-width:200px;padding:6px;">
      <button id="btnAddPayment" style="flex:0 0 auto;padding:6px 20px;">Save</button>
    </div>
    <div style="margin-bottom:10px;">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="enableMultiBill" onchange="toggleMultiBillMode()" style="width:18px;height:18px;">
        <span>Enable Multi-Bill Payment (pay multiple bills at once)</span>
      </label>
    </div>
    <div id="pay_msg" class="error" style="margin-bottom:10px;"></div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
      <h3 style="margin:0;">All Payments</h3>
      <button onclick="exportPaymentsData()" style="padding:8px 16px;background:linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;box-shadow:0 2px 8px rgba(39,174,96,0.3);">
        üì• Export CSV
      </button>
    </div>
    <!-- Date Filter Section -->
    <div class="date-filter-section" style="margin-bottom:15px;">
      <div class="date-filter-row">
        <div class="date-filter-group">
          <label>From Date</label>
          <input type="date" id="paymentFromDate" />
        </div>
        <div class="date-filter-group">
          <label>To Date</label>
          <input type="date" id="paymentToDate" />
        </div>
        <div class="date-filter-actions">
          <button onclick="applyPaymentDateFilter()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;">Apply Filter</button>
          <button onclick="clearPaymentDateFilter()" class="clear-btn">Clear</button>
        </div>
      </div>
    </div>
    <div style="margin-bottom:10px;">
      <input type="text" id="searchPayments" placeholder="Search by ID, customer, bill, amount, mode, or cheque number..." style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:14px;" />
    </div>
    <div id="paymentCount" style="margin-bottom:5px;color:#666;font-size:14px;">Showing ${data.length} of ${totalPaymentCount} payments${searchTerm ? ` (filtered from ${allPayments.length} total)` : ''}</div>
    <table id="tblPayments">
      <thead>
        <tr><th>Id</th><th>Cust</th><th>Bill</th><th>Amount</th><th>Mode</th><th>Payment Date</th><th>Cleared</th><th>Action</th></tr>
      </thead>
      <tbody>${data.map(p=>`
        <tr>
          <td>${escapeHtml(p.id)}</td>
          <td>${escapeHtml(p.customerId)}</td>
          <td>${escapeHtml(p.billId)}</td>
          <td>‚Çπ${parseFloat(p.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
          <td><span style="padding:4px 8px;border-radius:4px;font-size:0.85rem;font-weight:500;background:#e3f2fd;color:#1976d2;text-transform:capitalize;">${escapeHtml(p.mode || 'N/A')}</span></td>
          <td title="${p.paymentDate ? formatDate(p.paymentDate) : 'N/A'}">${p.paymentDate ? formatDateOnly(p.paymentDate) : 'N/A'}<br><small style="color:#7f8c8d;">${p.paymentDate ? formatRelativeTime(p.paymentDate) : ''}</small></td>
          <td><span style="padding:4px 8px;border-radius:4px;font-size:0.85rem;font-weight:500;background:${p.cleared ? '#d4edda' : '#fff3cd'};color:${p.cleared ? '#155724' : '#856404'};">${p.cleared ? '‚úì Cleared' : '‚è≥ Pending'}</span></td>
          <td style="display:flex;gap:5px;flex-wrap:wrap;">
            <button class="toggle-clear" data-id="${escapeHtml(p.id)}" data-newstate="${!p.cleared}" style="padding:4px 8px;background:#f39c12;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Mark ${p.cleared?'Uncleared':'Cleared'}</button>
            ${canEdit ? `<button class="btn-edit-payment" data-id="${escapeHtml(p.id)}" data-customer="${escapeHtml(p.customerId)}" data-bill="${escapeHtml(p.billId)}" data-amount="${escapeHtml(p.amount)}" data-mode="${escapeHtml(p.mode)}" data-cheque="${escapeHtml(p.chequeNumber||'')}" style="padding:4px 8px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Edit</button>` : ''}
            ${canDelete ? `<button class="btn-delete-payment" data-id="${escapeHtml(p.id)}" data-amount="${escapeHtml(p.amount)}" style="padding:4px 8px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Delete</button>` : ''}
          </td>
        </tr>`).join('')}
      </tbody>
    </table>
    <div id="payPagination" class="pagination"></div>`;
    tabContent.innerHTML=html;

    createPagination('payPagination',totalPages,page,(p)=>loadPaymentsTab(p, searchTerm));

    // Search functionality
    const searchInput = document.getElementById('searchPayments');
    if(searchInput){
      const debouncedSearch = debounce((term) => {
        loadPaymentsTab(1, term);
      }, 300);
      
      searchInput.addEventListener('input', (e) => {
        const term = e.target.value;
        debouncedSearch(term);
      });
      
      // Set initial value if search term exists
      if(searchTerm) searchInput.value = searchTerm;
    }

    // Edit/Delete button handlers
    if(canEdit || canDelete){
      document.querySelectorAll('.btn-edit-payment').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.dataset.id;
        const customerId = parseInt(btn.dataset.customer);
        const billId = parseInt(btn.dataset.bill);
        const amount = parseFloat(btn.dataset.amount);
        const mode = btn.dataset.mode;
        const cheque = btn.dataset.cheque;
        editPayment(id, customerId, billId, amount, mode, cheque);
      });
      });
      
      document.querySelectorAll('.btn-delete-payment').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.dataset.id;
        const amount = btn.dataset.amount;
        if(confirm(`Are you sure you want to delete payment #${id} (Amount: ${amount})?`)){
        deletePayment(id);
        }
      });
      });
    }

    const payCustomer=document.getElementById('pay_customer');
    const payBill=document.getElementById('pay_bill');
    const payMode=document.getElementById('pay_mode');
    const chequeFields=document.getElementById('chequeFields');

    // Show/hide cheque fields based on payment mode
    payMode.addEventListener('change',()=>{
      if(payMode.value === 'Cheque'){
        chequeFields.style.display = 'flex';
        document.getElementById('pay_cheque').required = true;
      } else {
        chequeFields.style.display = 'none';
        document.getElementById('pay_cheque').required = false;
      }
    });

    // Populate bill dropdown initially with all bills
    payBill.innerHTML='<option value="">Select Primary Bill (or use multi-bill above)</option>' + bills.map(b => {
      const customerName = customers.find(c => c.id === b.customerId)?.name || `Customer ${b.customerId}`;
      return `<option value="${escapeHtml(b.id)}" data-customer-id="${escapeHtml(b.customerId)}">${escapeHtml(b.billNumber || `Bill #${b.id}`)} - ${escapeHtml(customerName)} - ‚Çπ${parseFloat(b.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})} (${escapeHtml(b.status || 'Unpaid')})</option>`;
    }).join('');
    
    payCustomer.addEventListener('change',()=>{
      const cid=parseInt(payCustomer.value);
      if(cid){
        // Filter bills by selected customer
        const filtered=bills.filter(b=>b.customerId===cid);
        payBill.innerHTML='<option value="">Select Primary Bill (or use multi-bill above)</option>' + filtered.map(b=>{
          const customerName = customers.find(c => c.id === b.customerId)?.name || `Customer ${b.customerId}`;
          return `<option value="${escapeHtml(b.id)}" data-customer-id="${escapeHtml(b.customerId)}">${escapeHtml(b.billNumber || `Bill #${b.id}`)} - ${escapeHtml(customerName)} - ‚Çπ${parseFloat(b.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})} (${escapeHtml(b.status || 'Unpaid')})</option>`;
        }).join('');
      } else {
        // Show all bills if no customer selected
        payBill.innerHTML='<option value="">Select Primary Bill (or use multi-bill above)</option>' + bills.map(b => {
          const customerName = customers.find(c => c.id === b.customerId)?.name || `Customer ${b.customerId}`;
          return `<option value="${escapeHtml(b.id)}" data-customer-id="${escapeHtml(b.customerId)}">${escapeHtml(b.billNumber || `Bill #${b.id}`)} - ${escapeHtml(customerName)} - ‚Çπ${parseFloat(b.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})} (${escapeHtml(b.status || 'Unpaid')})</option>`;
        }).join('');
      }
      
      // Load bills for multi-bill payment if enabled
      if(document.getElementById('enableMultiBill')?.checked){
        loadBillsForMultiPayment();
      }
    });

    // Attach event listener for Add Payment button (after HTML is inserted)
    const btnAddPayment = document.getElementById('btnAddPayment');
    if(btnAddPayment){
      btnAddPayment.addEventListener('click',async()=>{
        clearMessage('pay_msg');
        const customerId=parseInt(payCustomer.value);
        const enableMultiBill = document.getElementById('enableMultiBill')?.checked;
        let billId = parseInt(payBill.value);
        const amount=parseFloat(document.getElementById('pay_amount').value);
        const mode=document.getElementById('pay_mode').value;
        const paymentDate=document.getElementById('pay_date').value;
        const paymentReference=document.getElementById('pay_reference').value.trim();
        const cheque=document.getElementById('pay_cheque').value.trim();
        const chequeClearDate=document.getElementById('pay_cheque_date').value;
        const notes=document.getElementById('pay_notes').value.trim();
        
        // Multi-bill payment validation
        let linkedBills = [];
        if(enableMultiBill && selectedBillsForPayment.length > 0){
          if(selectedBillsForPayment.length === 0){
            showError('pay_msg', 'Please select at least one bill for multi-bill payment');
            return;
          }
          const totalSelected = selectedBillsForPayment.reduce((sum, b) => sum + b.amount, 0);
          if(Math.abs(totalSelected - amount) > 0.01){
            showError('pay_msg', `Total selected bills (‚Çπ${totalSelected.toFixed(2)}) must equal payment amount (‚Çπ${amount.toFixed(2)})`);
            return;
          }
          billId = selectedBillsForPayment[0].billId; // Primary bill
          linkedBills = selectedBillsForPayment.map(b => ({ billId: b.billId, amount: b.amount }));
        } else {
          // Single bill payment
          if(!billId){
            showError('pay_msg', 'Please select a bill');
            return;
          }
          linkedBills = [{ billId: billId, amount: amount }];
        }
        
        // Validation
        if(!customerId || !amount || !mode){
          showError('pay_msg', 'Please fill all required fields');
          return;
        }
        
        if(mode === 'Cheque' && !cheque){
          showError('pay_msg', 'Cheque number is required for Cheque payments');
          return;
        }
        
        // Check if in edit mode
        if(editingPaymentId){
          const validation = validatePaymentForm({customerId, billId, amount, mode});
          if(!validation.valid){
            showError('pay_msg', validation.errors.map(e => e.message).join(', '));
            return;
          }
          await updatePayment(editingPaymentId, customerId, billId, amount, mode, cheque);
          return;
        }
        
        // Add new payment
        const payload={
          customerId,
          billId: billId || selectedBillsForPayment[0]?.billId,
          amount,
          paymentDate: paymentDate ? new Date(paymentDate).toISOString() : new Date().toISOString(),
          mode,
          paymentReference: paymentReference || null,
          chequeNumber: mode === 'Cheque' ? cheque : null,
          chequeClearDate: mode === 'Cheque' && chequeClearDate ? new Date(chequeClearDate).toISOString() : null,
          notes: notes || null,
          cleared: mode === 'Cheque' ? false : true,
          linkedBills: linkedBills
        };
        
        setButtonLoading('btnAddPayment', 'Saving...');
        showLoading('pay_msg', 'Saving payment...');
        const r=await fetchJson(API_PAYMENTS,{method:'POST',headers:authHeader(),body:JSON.stringify(payload)});
        removeButtonLoading('btnAddPayment');
        if(handleApiError(r, 'pay_msg', 'Failed to save payment')) return;
        showSuccess('pay_msg', 'Payment saved successfully!');
        
        // Reset form
        document.getElementById('pay_customer').value = '';
        document.getElementById('pay_bill').innerHTML = '<option value="">Select Primary Bill (or use multi-bill above)</option>';
        document.getElementById('pay_amount').value = '';
        document.getElementById('pay_mode').value = '';
        document.getElementById('pay_reference').value = '';
        document.getElementById('pay_cheque').value = '';
        document.getElementById('pay_cheque_date').value = '';
        document.getElementById('pay_notes').value = '';
        document.getElementById('pay_date').value = new Date().toISOString().split('T')[0];
        document.getElementById('enableMultiBill').checked = false;
        toggleMultiBillMode();
        selectedBillsForPayment = [];
        
        loadPaymentsTab();
        document.getElementById('tblPayments').scrollIntoView({behavior:"smooth"});
      });
    }

    // Toggle clear
    document.querySelectorAll(".toggle-clear").forEach(btn=>{
      btn.addEventListener("click", async()=>{
        const paymentId=parseInt(btn.dataset.id);
        const newState = btn.dataset.newstate==="true";
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span>Updating...';
        const r = await fetch(`${API_PAYMENTS}/${paymentId}/cleared`,{
          method:"PUT",
          headers:{...authHeader(), "Content-Type":"application/json"},
          body:JSON.stringify({paymentId, cleared:newState})
        });
        const rJson = await r.json().catch(() => ({ ok: r.ok, status: r.status, data: null }));
        btn.disabled = false;
        btn.innerText = `Mark ${newState ? 'Uncleared' : 'Cleared'}`;
        if(handleApiError({ok: r.ok, status: r.status, data: rJson}, 'pay_msg', 'Failed to update payment status')) return;
        showSuccess('pay_msg', 'Payment status updated successfully!');
        loadPaymentsTab();
        document.getElementById('tblPayments').scrollIntoView({behavior:"smooth"});
      });
    });

  } catch(err){
    logError('loadPaymentsTab', err);
    showError('pay_msg', `Failed to load payments: ${err.message || 'Unknown error'}`);
    return;
  }
}

// 1. Recent Activity Function
function loadRecentActivity(customers, bills, payments){
  const recentActivitySection = document.getElementById('recentActivitySection');
  if(!recentActivitySection) return;
  
  // Recent Customers (last 5)
  const recentCustomers = [...customers]
    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))
    .slice(0, 5);
  
  const recentCustomersEl = document.getElementById('recentCustomers');
  if(recentCustomersEl){
    if(recentCustomers.length === 0){
      recentCustomersEl.innerHTML = '<p style="color:#7f8c8d;text-align:center;padding:20px;">No customers yet</p>';
    } else {
      recentCustomersEl.innerHTML = recentCustomers.map(c => `
        <div class="activity-item">
          <div class="activity-item-header">
            <span class="activity-item-title">${escapeHtml(c.name)}</span>
            <span class="activity-item-date">${c.createdAt ? formatRelativeTime(c.createdAt) : 'N/A'}</span>
          </div>
          <div class="activity-item-details">${escapeHtml(c.phone)} ‚Ä¢ ${escapeHtml(c.address || 'No address')}</div>
        </div>
      `).join('');
    }
  }
  
  // Recent Bills (last 5)
  const recentBills = [...bills]
    .sort((a, b) => new Date(b.billDate || b.createdAt || 0) - new Date(a.billDate || a.createdAt || 0))
    .slice(0, 5);
  
  const recentBillsEl = document.getElementById('recentBills');
  if(recentBillsEl){
    if(recentBills.length === 0){
      recentBillsEl.innerHTML = '<p style="color:#7f8c8d;text-align:center;padding:20px;">No bills yet</p>';
    } else {
      recentBillsEl.innerHTML = recentBills.map(b => {
        const statusColor = (b.status === 'Pending' || b.status === 'pending') ? '#856404' : '#155724';
        const statusBg = (b.status === 'Pending' || b.status === 'pending') ? '#fff3cd' : '#d4edda';
        return `
        <div class="activity-item">
          <div class="activity-item-header">
            <span class="activity-item-title">Bill #${escapeHtml(b.id)}</span>
            <span class="activity-item-date">${b.billDate ? formatRelativeTime(b.billDate) : (b.createdAt ? formatRelativeTime(b.createdAt) : 'N/A')}</span>
          </div>
          <div class="activity-item-details">
            ‚Çπ${parseFloat(b.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})} ‚Ä¢ 
            <span style="padding:2px 6px;border-radius:3px;font-size:0.8rem;background:${statusBg};color:${statusColor};">${escapeHtml(b.status || 'N/A')}</span>
          </div>
        </div>
      `;
      }).join('');
    }
  }
  
  // Recent Payments (last 5)
  const recentPayments = [...payments]
    .sort((a, b) => new Date(b.paymentDate || b.createdAt || 0) - new Date(a.paymentDate || a.createdAt || 0))
    .slice(0, 5);
  
  const recentPaymentsEl = document.getElementById('recentPayments');
  if(recentPaymentsEl){
    if(recentPayments.length === 0){
      recentPaymentsEl.innerHTML = '<p style="color:#7f8c8d;text-align:center;padding:20px;">No payments yet</p>';
    } else {
      recentPaymentsEl.innerHTML = recentPayments.map(p => {
        const clearedStatus = p.cleared ? '‚úì Cleared' : '‚è≥ Pending';
        const clearedColor = p.cleared ? '#155724' : '#856404';
        const clearedBg = p.cleared ? '#d4edda' : '#fff3cd';
        return `
        <div class="activity-item">
          <div class="activity-item-header">
            <span class="activity-item-title">Payment #${escapeHtml(p.id)}</span>
            <span class="activity-item-date">${p.paymentDate ? formatRelativeTime(p.paymentDate) : (p.createdAt ? formatRelativeTime(p.createdAt) : 'N/A')}</span>
          </div>
          <div class="activity-item-details">
            ‚Çπ${parseFloat(p.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})} ‚Ä¢ 
            <span style="text-transform:capitalize;">${escapeHtml(p.mode || 'N/A')}</span> ‚Ä¢ 
            <span style="padding:2px 6px;border-radius:3px;font-size:0.8rem;background:${clearedBg};color:${clearedColor};">${clearedStatus}</span>
          </div>
        </div>
      `;
      }).join('');
    }
  }
  
  if(recentActivitySection && (recentCustomers.length > 0 || recentBills.length > 0 || recentPayments.length > 0)){
    recentActivitySection.style.display = 'block';
  }
}

// ===== NEW FEATURES IMPLEMENTATION =====

// ----- Step 1: CSV Import Tab -----
async function loadImportTab(){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  const html = `
    <div id="import-content">
      <h2>üì• Bulk Import Data</h2>
      <p style="color:#7f8c8d;margin-bottom:20px;">Import customers, bills, or payments from CSV files. Download templates to ensure correct format.</p>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin-bottom:30px;">
        <!-- Customers Import -->
        <div class="import-section" style="background:var(--bg-secondary);padding:20px;border-radius:12px;border:2px solid var(--border-color);">
          <h3 style="margin-top:0;color:var(--text-primary);">Import Customers</h3>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:15px;">Upload a CSV file with customer data</p>
          <div class="file-upload-area" id="customerUploadArea" onclick="document.getElementById('customerFileInput').click()">
            <input type="file" id="customerFileInput" accept=".csv" class="file-upload-input" onchange="handleFileSelect('customers', this.files[0])">
            <p style="margin:0;color:var(--text-secondary);">üìÅ Click to select CSV file</p>
            <p style="margin:5px 0 0 0;font-size:0.85rem;color:var(--text-tertiary);">or drag and drop</p>
          </div>
          <div style="margin-top:15px;display:flex;gap:10px;">
            <button onclick="downloadTemplate('customers')" style="flex:1;padding:10px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;">üì• Download Template</button>
          </div>
          <div id="customerImportProgress" class="progress-container" style="display:none;margin-top:15px;">
            <div class="progress-bar">
              <div class="progress-fill" id="customerProgressFill" style="width:0%;">0%</div>
            </div>
          </div>
          <div id="customerImportResults" style="margin-top:15px;"></div>
        </div>
        
        <!-- Bills Import -->
        <div class="import-section" style="background:var(--bg-secondary);padding:20px;border-radius:12px;border:2px solid var(--border-color);">
          <h3 style="margin-top:0;color:var(--text-primary);">Import Bills</h3>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:15px;">Upload a CSV file with bill data</p>
          <div class="file-upload-area" id="billUploadArea" onclick="document.getElementById('billFileInput').click()">
            <input type="file" id="billFileInput" accept=".csv" class="file-upload-input" onchange="handleFileSelect('bills', this.files[0])">
            <p style="margin:0;color:var(--text-secondary);">üìÅ Click to select CSV file</p>
            <p style="margin:5px 0 0 0;font-size:0.85rem;color:var(--text-tertiary);">or drag and drop</p>
          </div>
          <div style="margin-top:15px;display:flex;gap:10px;">
            <button onclick="downloadTemplate('bills')" style="flex:1;padding:10px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;">üì• Download Template</button>
          </div>
          <div id="billImportProgress" class="progress-container" style="display:none;margin-top:15px;">
            <div class="progress-bar">
              <div class="progress-fill" id="billProgressFill" style="width:0%;">0%</div>
            </div>
          </div>
          <div id="billImportResults" style="margin-top:15px;"></div>
        </div>
        
        <!-- Payments Import -->
        <div class="import-section" style="background:var(--bg-secondary);padding:20px;border-radius:12px;border:2px solid var(--border-color);">
          <h3 style="margin-top:0;color:var(--text-primary);">Import Payments</h3>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:15px;">Upload a CSV file with payment data</p>
          <div class="file-upload-area" id="paymentUploadArea" onclick="document.getElementById('paymentFileInput').click()">
            <input type="file" id="paymentFileInput" accept=".csv" class="file-upload-input" onchange="handleFileSelect('payments', this.files[0])">
            <p style="margin:0;color:var(--text-secondary);">üìÅ Click to select CSV file</p>
            <p style="margin:5px 0 0 0;font-size:0.85rem;color:var(--text-tertiary);">or drag and drop</p>
          </div>
          <div style="margin-top:15px;display:flex;gap:10px;">
            <button onclick="downloadTemplate('payments')" style="flex:1;padding:10px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;">üì• Download Template</button>
          </div>
          <div id="paymentImportProgress" class="progress-container" style="display:none;margin-top:15px;">
            <div class="progress-bar">
              <div class="progress-fill" id="paymentProgressFill" style="width:0%;">0%</div>
            </div>
          </div>
          <div id="paymentImportResults" style="margin-top:15px;"></div>
        </div>
      </div>
    </div>
  `;
  
  tabContent.innerHTML = html;
  
  // Setup drag and drop
  setupDragAndDrop('customerUploadArea', 'customerFileInput', 'customers');
  setupDragAndDrop('billUploadArea', 'billFileInput', 'bills');
  setupDragAndDrop('paymentUploadArea', 'paymentFileInput', 'payments');
}

function setupDragAndDrop(areaId, inputId, entityType){
  const area = document.getElementById(areaId);
  if(!area) return;
  
  area.addEventListener('dragover', (e) => {
    e.preventDefault();
    area.classList.add('dragover');
  });
  
  area.addEventListener('dragleave', () => {
    area.classList.remove('dragover');
  });
  
  area.addEventListener('drop', (e) => {
    e.preventDefault();
    area.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if(files.length > 0 && files[0].name.endsWith('.csv')){
      handleFileSelect(entityType, files[0]);
    } else {
      showError('import_msg', 'Please select a CSV file');
    }
  });
}

function handleFileSelect(entityType, file){
  if(!file){
    showError('import_msg', 'No file selected');
    return;
  }
  
  if(!file.name.endsWith('.csv')){
    showError('import_msg', 'Please select a CSV file');
    return;
  }
  
  if(file.size > 10 * 1024 * 1024){ // 10MB limit
    showError('import_msg', 'File size should be less than 10MB');
    return;
  }
  
  uploadFile(entityType, file);
}

async function uploadFile(entityType, file){
  const progressContainer = document.getElementById(`${entityType}ImportProgress`);
  const progressFill = document.getElementById(`${entityType}ProgressFill`);
  const resultsDiv = document.getElementById(`${entityType}ImportResults`);
  
  if(progressContainer) progressContainer.style.display = 'block';
  if(progressFill) progressFill.style.width = '0%';
  if(resultsDiv) resultsDiv.innerHTML = '';
  
  try{
    const formData = new FormData();
    formData.append('file', file);
    
    // Show loading
    showLoadingOverlay();
    
    const response = await fetch(`${API_IMPORT}/Import/${entityType}/bulk-import`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: formData
    });
    
    hideLoadingOverlay();
    
    const result = await response.json();
    
    // Simulate progress (since we can't track actual upload progress easily)
    if(progressFill){
      for(let i = 0; i <= 100; i += 10){
        await new Promise(resolve => setTimeout(resolve, 50));
        progressFill.style.width = i + '%';
        progressFill.textContent = i + '%';
      }
    }
    
    // Always display the API response to the user
    if(result.status === true){
      // Success case - show detailed results
      const responseData = result.body || result;
      displayImportResults(entityType, responseData, result);
      
      if(responseData.successful > 0){
        showSuccess('import_msg', result.message || `${entityType} imported successfully! ${responseData.successful} record(s) imported.`);
      } else {
        showError('import_msg', result.message || `No records were imported. Please check the errors below.`);
      }
      
      // Refresh relevant tab if open
      if(entityType === 'customers' && document.querySelector('.tab-link[data-tab="customers"]')?.classList.contains('active')){
        customersDataLoaded = false;
        loadCustomersTab(1, '', true);
      } else if(entityType === 'bills' && document.querySelector('.tab-link[data-tab="bills"]')?.classList.contains('active')){
        billsDataLoaded = false;
        loadBillsTab(1, '', true);
      } else if(entityType === 'payments' && document.querySelector('.tab-link[data-tab="payments"]')?.classList.contains('active')){
        paymentsDataLoaded = false;
        loadPaymentsTab(1, '', true);
      }
    } else {
      // Error case - show full error details
      const errorData = result.body || result;
      displayImportResults(entityType, errorData, result, true);
      showError('import_msg', result.message || `Failed to import ${entityType}. Please check the details below.`);
    }
  } catch(err){
    hideLoadingOverlay();
    logError('uploadFile', err);
    
    // Display error details to user
    const resultsDiv = document.getElementById(`${entityType}ImportResults`);
    if(resultsDiv){
      const errorResponse = {
        status: false,
        message: `Failed to upload file: ${err.message}`,
        error: err.message,
        stack: err.stack
      };
      displayImportResults(entityType, {totalRows: 0, successful: 0, failed: 0, errors: []}, errorResponse, true);
    }
    
    showError('import_msg', `Failed to upload file: ${err.message}`);
    if(progressFill) progressFill.style.width = '0%';
  } finally {
    // Keep progress container visible longer so user can see results
    if(progressContainer) setTimeout(() => { progressContainer.style.display = 'none'; }, 5000);
  }
}

function displayImportResults(entityType, results, fullResponse, isError = false){
  const resultsDiv = document.getElementById(`${entityType}ImportResults`);
  if(!resultsDiv) return;
  
  // Extract data from response
  const totalRows = results.totalRows || results.total || 0;
  const successful = results.successful || results.success || 0;
  const failed = results.failed || results.failure || 0;
  const errors = results.errors || [];
  const message = fullResponse?.message || '';
  
  // Determine status color
  const bgColor = isError ? '#fee' : (failed > 0 ? '#fff3cd' : '#d4edda');
  const borderColor = isError ? '#e74c3c' : (failed > 0 ? '#f39c12' : '#27ae60');
  
  resultsDiv.innerHTML = `
    <div style="padding:20px;background:${bgColor};border-radius:8px;border-left:4px solid ${borderColor};box-shadow:0 2px 8px rgba(0,0,0,0.1);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
        <strong style="color:var(--text-primary);font-size:1.1rem;">üìä Import Results</strong>
        <span style="font-size:0.9rem;color:var(--text-secondary);padding:4px 8px;background:rgba(255,255,255,0.7);border-radius:4px;">
          ${successful}/${totalRows} successful
        </span>
      </div>
      
      ${message ? `
        <div style="margin-bottom:15px;padding:10px;background:rgba(255,255,255,0.8);border-radius:6px;">
          <strong style="color:var(--text-primary);font-size:0.9rem;">üìù API Message:</strong>
          <p style="margin:5px 0 0 0;color:var(--text-secondary);font-size:0.9rem;">${escapeHtml(message)}</p>
        </div>
      ` : ''}
      
      <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;margin-bottom:${errors && errors.length > 0 ? '15px' : '0'};">
        <div style="padding:12px;background:rgba(255,255,255,0.8);border-radius:6px;text-align:center;">
          <strong style="color:var(--text-secondary);font-size:0.85rem;display:block;margin-bottom:5px;">Total Rows</strong>
          <p style="margin:0;font-size:1.5rem;font-weight:bold;color:var(--text-primary);">${totalRows}</p>
        </div>
        <div style="padding:12px;background:rgba(255,255,255,0.8);border-radius:6px;text-align:center;">
          <strong style="color:#27ae60;font-size:0.85rem;display:block;margin-bottom:5px;">‚úÖ Successful</strong>
          <p style="margin:0;font-size:1.5rem;font-weight:bold;color:#27ae60;">${successful}</p>
        </div>
        <div style="padding:12px;background:rgba(255,255,255,0.8);border-radius:6px;text-align:center;">
          <strong style="color:#e74c3c;font-size:0.85rem;display:block;margin-bottom:5px;">‚ùå Failed</strong>
          <p style="margin:0;font-size:1.5rem;font-weight:bold;color:#e74c3c;">${failed}</p>
        </div>
      </div>
      
      ${errors && errors.length > 0 ? `
        <div style="margin-top:15px;padding:15px;background:#fff;border-radius:6px;border:1px solid #ddd;max-height:300px;overflow-y:auto;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <strong style="color:#e74c3c;font-size:0.95rem;">‚ö†Ô∏è Error Details (${errors.length} error(s)):</strong>
            <span style="font-size:0.8rem;color:var(--text-secondary);">Scroll to see all</span>
          </div>
          <ul style="margin:0;padding-left:20px;font-size:0.85rem;color:#c33;list-style-type:decimal;">
            ${errors.map(e => {
              const rowNum = e.row || e.rowNumber || 'N/A';
              const errorMsg = e.error || e.message || e.errorMessage || 'Unknown error';
              return `<li style="margin-bottom:8px;padding:5px;background:#fee;border-radius:4px;">
                <strong>Row ${rowNum}:</strong> ${escapeHtml(errorMsg)}
                ${e.field ? ` <span style="color:#999;">(Field: ${escapeHtml(e.field)})</span>` : ''}
              </li>`;
            }).join('')}
          </ul>
        </div>
      ` : successful > 0 ? `
        <div style="margin-top:15px;padding:12px;background:rgba(39, 174, 96, 0.1);border-radius:6px;border:1px solid #27ae60;">
          <p style="margin:0;color:#27ae60;font-size:0.9rem;font-weight:500;">‚úÖ All records imported successfully!</p>
        </div>
      ` : ''}
      
      ${fullResponse && Object.keys(fullResponse).length > 0 ? `
        <details style="margin-top:15px;">
          <summary style="cursor:pointer;padding:10px;background:rgba(255,255,255,0.8);border-radius:6px;color:var(--text-secondary);font-size:0.85rem;user-select:none;">
            üîç View Full API Response
          </summary>
          <div style="margin-top:10px;padding:15px;background:#f8f9fa;border-radius:6px;border:1px solid #ddd;max-height:400px;overflow-y:auto;">
            <pre style="margin:0;font-size:0.8rem;color:#333;white-space:pre-wrap;word-wrap:break-word;">${escapeHtml(JSON.stringify(fullResponse, null, 2))}</pre>
          </div>
        </details>
      ` : ''}
    </div>
  `;
  
  // Ensure results div is visible
  if(resultsDiv) resultsDiv.style.display = 'block';
}

async function downloadTemplate(entityType){
  try{
    showLoadingOverlay();
    const response = await fetch(`${API_IMPORT}/Import/${entityType}/import-template`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });
    
    hideLoadingOverlay();
    
    if(response.ok){
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${entityType}_template.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      showSuccess('import_msg', 'Template downloaded successfully!');
    } else {
      // Fallback to hardcoded template if API fails
      const templates = {
        customers: 'name,phone,email,address,city,state,pincode,gstNumber\nJohn Doe,9876543210,john@example.com,123 Main St,New York,NY,10001,GST123456',
        bills: 'customerId,billAmount,billDate,notes,status\n1,1000.00,2025-01-01,Monthly subscription,Unpaid',
        payments: 'customerId,billId,amount,paymentDate,mode,chequeNumber,cleared,notes\n1,1,500.00,2025-01-15,Cash,,true,Partial payment'
      };
      
      const csvContent = templates[entityType] || '';
      if(csvContent){
        const blob = new Blob([csvContent], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${entityType}_template.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        showSuccess('import_msg', 'Template downloaded successfully!');
      } else {
        showError('import_msg', 'Template not available');
      }
    }
  } catch(err){
    hideLoadingOverlay();
    logError('downloadTemplate', err);
    // Fallback to hardcoded template
    const templates = {
      customers: 'name,phone,email,address,city,state,pincode,gstNumber\nJohn Doe,9876543210,john@example.com,123 Main St,New York,NY,10001,GST123456',
      bills: 'customerId,billAmount,billDate,notes,status\n1,1000.00,2025-01-01,Monthly subscription,Unpaid',
      payments: 'customerId,billId,amount,paymentDate,mode,chequeNumber,cleared,notes\n1,1,500.00,2025-01-15,Cash,,true,Partial payment'
    };
    
    const csvContent = templates[entityType] || '';
    if(csvContent){
      const blob = new Blob([csvContent], {type: 'text/csv'});
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${entityType}_template.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      showSuccess('import_msg', 'Template downloaded successfully!');
    } else {
      showError('import_msg', 'Failed to download template: ' + err.message);
    }
  }
}

// ----- Step 2: Advanced Reports Tab -----
async function loadReportsTab(){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  const html = `
    <div id="reports-content">
      <h2>üìä Advanced Reports</h2>
      <p style="color:#7f8c8d;margin-bottom:20px;">Generate comprehensive reports in various formats</p>
      
      <div style="background:var(--bg-secondary);padding:25px;border-radius:12px;margin-bottom:30px;border:2px solid var(--border-color);">
        <h3 style="margin-top:0;color:var(--text-primary);">Generate New Report</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:15px;margin-bottom:20px;">
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Report Type *</label>
            <select id="reportType" style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
              <option value="">Select Report Type</option>
              <option value="Financial">Financial Report</option>
              <option value="CustomerStatement">Customer Statement</option>
              <option value="TaxReport">Tax Report</option>
              <option value="PaymentSummary">Payment Summary</option>
            </select>
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">From Date</label>
            <input type="date" id="reportFromDate" style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">To Date</label>
            <input type="date" id="reportToDate" style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Format *</label>
            <select id="reportFormat" style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
              <option value="PDF">PDF</option>
              <option value="Excel">Excel</option>
              <option value="CSV">CSV</option>
            </select>
          </div>
        </div>
        <div style="margin-bottom:15px;">
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
            <input type="checkbox" id="reportIncludeFilters" style="width:18px;height:18px;">
            <span style="color:var(--text-secondary);">Apply additional filters</span>
          </label>
        </div>
        <button onclick="generateReport()" style="padding:12px 24px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem;">üöÄ Generate Report</button>
        <div id="report_msg" style="margin-top:15px;"></div>
      </div>
      
      <div>
        <h3 style="color:var(--text-primary);margin-bottom:15px;">Report History</h3>
        <div id="reportHistory" style="display:grid;gap:10px;">
          <p style="color:var(--text-secondary);text-align:center;padding:20px;">Loading reports...</p>
        </div>
      </div>
    </div>
  `;
  
  tabContent.innerHTML = html;
  loadReportHistory();
}

async function generateReport(){
  const reportType = document.getElementById('reportType')?.value;
  const fromDate = document.getElementById('reportFromDate')?.value;
  const toDate = document.getElementById('reportToDate')?.value;
  const format = document.getElementById('reportFormat')?.value;
  const includeFilters = document.getElementById('reportIncludeFilters')?.checked;
  
  if(!reportType || !format){
    showError('report_msg', 'Please select report type and format');
    return;
  }
  
  showLoading('report_msg', 'Generating report...');
  showLoadingOverlay();
  
  try{
    const payload = {
      reportType,
      fromDate: fromDate || null,
      toDate: toDate || null,
      format,
      includeFilters: includeFilters || false
    };
    
    const r = await fetchJson(`${API_REPORTS}/generate`, {
      method: 'POST',
      headers: authHeader(),
      body: JSON.stringify(payload)
    });
    
    hideLoadingOverlay();
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const reportId = r.apiResponse.body?.reportId || r.data?.reportId;
      if(reportId){
        showSuccess('report_msg', 'Report generation started! Checking status...');
        checkReportStatus(reportId);
        setTimeout(() => loadReportHistory(), 2000);
      } else {
        showSuccess('report_msg', 'Report generated successfully!');
        loadReportHistory();
      }
    } else {
      handleApiError(r, 'report_msg', 'Failed to generate report');
    }
  } catch(err){
    hideLoadingOverlay();
    logError('generateReport', err);
    showError('report_msg', 'Failed to generate report: ' + err.message);
  }
}

async function checkReportStatus(reportId){
  if(!reportId) return;
  
  try{
    const r = await fetchJson(`${API_REPORTS}/${reportId}/status`, {
      headers: authHeader()
    });
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const status = r.apiResponse.body?.status || r.data?.status;
      
      if(status === 'completed'){
        showSuccess('report_msg', 'Report ready for download!');
        loadReportHistory();
      } else if(status === 'processing' || status === 'pending'){
        showLoading('report_msg', 'Report is being generated...');
        setTimeout(() => checkReportStatus(reportId), 5000); // Check again in 5 seconds
      } else if(status === 'failed'){
        showError('report_msg', 'Report generation failed');
        loadReportHistory();
      }
    }
  } catch(err){
    logError('checkReportStatus', err);
  }
}

async function loadReportHistory(){
  const historyDiv = document.getElementById('reportHistory');
  if(!historyDiv) return;
  
  try{
    console.log('Loading report history from:', `${API_REPORTS}/history`);
    const r = await fetchJson(`${API_REPORTS}/history`, {
      headers: authHeader()
    });
    
    console.log('Report history response:', r);
    
    if(r.status === 404){
      historyDiv.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:5px;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_REPORTS}/history</code> is not available yet.</p>
          <p style="color:var(--text-tertiary);font-size:0.85rem;">Please check Swagger documentation at <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
      return;
    }
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const reports = r.apiResponse.body || r.data || [];
      
      if(reports.length === 0){
        historyDiv.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:20px;">No reports generated yet</p>';
        return;
      }
      
      historyDiv.innerHTML = reports.map(report => {
        const statusClass = report.status === 'completed' ? 'completed' : 
                           report.status === 'processing' ? 'processing' : 
                           report.status === 'failed' ? 'failed' : 'pending';
        
        return `
          <div class="report-status ${statusClass}">
            <div style="flex:1;">
              <strong style="color:var(--text-primary);">${escapeHtml(report.reportType || 'Unknown')}</strong>
              <p style="margin:5px 0;color:var(--text-secondary);font-size:0.9rem;">
                Format: ${escapeHtml(report.format || 'N/A')} | 
                ${report.fromDate ? `From: ${formatDateOnly(report.fromDate)}` : ''} 
                ${report.toDate ? `To: ${formatDateOnly(report.toDate)}` : ''}
              </p>
              <p style="margin:5px 0;color:var(--text-tertiary);font-size:0.85rem;">
                Generated: ${report.createdAt ? formatDate(report.createdAt) : 'N/A'}
              </p>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
              <span style="padding:6px 12px;border-radius:6px;font-size:0.85rem;font-weight:500;background:${statusClass === 'completed' ? '#d4edda' : statusClass === 'processing' ? '#d1ecf1' : statusClass === 'failed' ? '#f8d7da' : '#fff3cd'};color:${statusClass === 'completed' ? '#155724' : statusClass === 'processing' ? '#0c5460' : statusClass === 'failed' ? '#721c24' : '#856404'};">
                ${report.status || 'Pending'}
              </span>
              ${report.status === 'completed' && report.downloadUrl ? `
                <button onclick="downloadReport('${report.reportId || report.id}')" style="padding:8px 16px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;">üì• Download</button>
              ` : report.status === 'processing' ? `
                <button onclick="checkReportStatus('${report.reportId || report.id}')" style="padding:8px 16px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;">üîÑ Refresh</button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    } else {
      const errorMsg = r.apiResponse?.message || r.message || 'Failed to load report history';
      historyDiv.innerHTML = `<p style="color:#e74c3c;text-align:center;padding:20px;">${escapeHtml(errorMsg)}</p>`;
    }
  } catch(err){
    logError('loadReportHistory', err);
    if(err.message && err.message.includes('404')){
      historyDiv.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_REPORTS}/history</code> is not available yet.</p>
          <p style="color:var(--text-tertiary);font-size:0.85rem;margin-top:10px;">Check Swagger: <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
    } else {
      historyDiv.innerHTML = `<p style="color:#e74c3c;text-align:center;padding:20px;">Error loading reports: ${escapeHtml(err.message || 'Unknown error')}</p>`;
    }
  }
}

async function downloadReport(reportId){
  try{
    showLoadingOverlay();
    const r = await fetchJson(`${API_REPORTS}/${reportId}/download`, {
      headers: authHeader()
    });
    
    hideLoadingOverlay();
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const downloadUrl = r.apiResponse.body?.downloadUrl || r.data?.downloadUrl;
      if(downloadUrl){
        window.open(downloadUrl, '_blank');
        showSuccess('report_msg', 'Report download started!');
      } else {
        showError('report_msg', 'Download URL not available');
      }
    } else {
      handleApiError(r, 'report_msg', 'Failed to download report');
    }
  } catch(err){
    hideLoadingOverlay();
    logError('downloadReport', err);
    showError('report_msg', 'Failed to download report: ' + err.message);
  }
}

// ----- Step 3: Email Notifications Tab -----
async function loadNotificationsTab(){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  const html = `
    <div id="notifications-content">
      <h2>üìß Email Notifications</h2>
      <p style="color:#7f8c8d;margin-bottom:20px;">Send emails to customers or users</p>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));gap:20px;">
        <!-- Send Email Form -->
        <div style="background:var(--bg-secondary);padding:25px;border-radius:12px;border:2px solid var(--border-color);">
          <h3 style="margin-top:0;color:var(--text-primary);">Send Email</h3>
          
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Email Template *</label>
            <select id="emailTemplate" style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);" onchange="loadEmailTemplate(this.value)">
              <option value="">Select Template</option>
            </select>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Recipient(s) *</label>
            <input type="text" id="emailRecipients" placeholder="email@example.com or comma-separated list" style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
            <small style="color:var(--text-tertiary);font-size:0.85rem;">For bulk emails, use comma-separated list</small>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Subject</label>
            <input type="text" id="emailSubject" placeholder="Email subject" style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
              <input type="checkbox" id="emailBulkMode" style="width:18px;height:18px;">
              <span style="color:var(--text-secondary);">Bulk email mode</span>
            </label>
          </div>
          
          <button onclick="sendEmail()" style="width:100%;padding:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem;margin-bottom:15px;">üìß Send Email</button>
          
          <div id="emailPreview" class="email-preview" style="display:none;">
            <h4 style="margin-top:0;color:var(--text-primary);">Template Preview</h4>
            <div id="emailPreviewContent" style="color:var(--text-secondary);"></div>
          </div>
          
          <div id="email_msg" style="margin-top:15px;"></div>
        </div>
        
        <!-- Email History -->
        <div style="background:var(--bg-secondary);padding:25px;border-radius:12px;border:2px solid var(--border-color);">
          <h3 style="margin-top:0;color:var(--text-primary);">Email History</h3>
          <div id="emailHistory" style="max-height:500px;overflow-y:auto;">
            <p style="color:var(--text-secondary);text-align:center;padding:20px;">Loading email history...</p>
          </div>
        </div>
      </div>
    </div>
  `;
  
  tabContent.innerHTML = html;
  loadEmailTemplates();
  loadEmailHistory();
}

async function loadEmailTemplates(){
  try{
    console.log('Loading email templates from:', `${API_NOTIFICATIONS}/templates`);
    const r = await fetchJson(`${API_NOTIFICATIONS}/templates`, {
      headers: authHeader()
    });
    
    console.log('Email templates response:', r);
    
    const templateSelect = document.getElementById('emailTemplate');
    if(!templateSelect) return;
    
    if(r.status === 404){
      templateSelect.innerHTML = '<option value="">‚ö†Ô∏è API endpoint not implemented yet</option>';
      return;
    }
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const templates = r.apiResponse.body || r.data || [];
      templateSelect.innerHTML = '<option value="">Select Template</option>' + 
        templates.map(t => `<option value="${escapeHtml(t.templateId || t.id)}">${escapeHtml(t.name || 'Unnamed Template')}</option>`).join('');
    } else {
      templateSelect.innerHTML = '<option value="">No templates available</option>';
    }
  } catch(err){
    logError('loadEmailTemplates', err);
    const templateSelect = document.getElementById('emailTemplate');
    if(templateSelect){
      if(err.message && err.message.includes('404')){
        templateSelect.innerHTML = '<option value="">‚ö†Ô∏è API endpoint not implemented yet</option>';
      } else {
        templateSelect.innerHTML = '<option value="">Error loading templates</option>';
      }
    }
  }
}

async function loadEmailTemplate(templateId){
  if(!templateId) return;
  
  try{
    const r = await fetchJson(`${API_NOTIFICATIONS}/templates/${templateId}`, {
      headers: authHeader()
    });
    
    const previewDiv = document.getElementById('emailPreview');
    const previewContent = document.getElementById('emailPreviewContent');
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const template = r.apiResponse.body || r.data;
      if(template && previewDiv && previewContent){
        previewDiv.style.display = 'block';
        previewContent.innerHTML = `
          <p><strong>Subject:</strong> ${escapeHtml(template.subject || 'N/A')}</p>
          <div style="margin-top:10px;padding:10px;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-color);">
            ${template.body || 'No preview available'}
          </div>
        `;
      }
    }
  } catch(err){
    logError('loadEmailTemplate', err);
  }
}

async function sendEmail(){
  const templateId = document.getElementById('emailTemplate')?.value;
  const recipients = document.getElementById('emailRecipients')?.value.trim();
  const subject = document.getElementById('emailSubject')?.value.trim();
  const bulkMode = document.getElementById('emailBulkMode')?.checked;
  
  if(!templateId || !recipients){
    showError('email_msg', 'Please select template and enter recipient(s)');
    return;
  }
  
  const recipientList = recipients.split(',').map(r => r.trim()).filter(r => r);
  if(recipientList.length === 0){
    showError('email_msg', 'Please enter at least one valid email address');
    return;
  }
  
  showLoading('email_msg', 'Sending email...');
  showLoadingOverlay();
  
  try{
    const payload = {
      templateId,
      recipients: bulkMode ? recipientList : [recipientList[0]],
      subject: subject || null,
      bulkMode: bulkMode || false
    };
    
    const r = await fetchJson(`${API_NOTIFICATIONS}/send-email`, {
      method: 'POST',
      headers: authHeader(),
      body: JSON.stringify(payload)
    });
    
    hideLoadingOverlay();
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      showSuccess('email_msg', 'Email sent successfully!');
      document.getElementById('emailRecipients').value = '';
      document.getElementById('emailSubject').value = '';
      loadEmailHistory();
    } else {
      handleApiError(r, 'email_msg', 'Failed to send email');
    }
  } catch(err){
    hideLoadingOverlay();
    logError('sendEmail', err);
    showError('email_msg', 'Failed to send email: ' + err.message);
  }
}

async function loadEmailHistory(){
  const historyDiv = document.getElementById('emailHistory');
  if(!historyDiv) return;
  
  try{
    console.log('Loading email history from:', `${API_NOTIFICATIONS}/email-history`);
    const r = await fetchJson(`${API_NOTIFICATIONS}/email-history`, {
      headers: authHeader()
    });
    
    console.log('Email history response:', r);
    
    if(r.status === 404){
      historyDiv.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:5px;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_NOTIFICATIONS}/email-history</code> is not available yet.</p>
          <p style="color:var(--text-tertiary);font-size:0.85rem;">Please check Swagger documentation or contact backend team.</p>
        </div>
      `;
      return;
    }
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const emails = r.apiResponse.body || r.data || [];
      
      if(emails.length === 0){
        historyDiv.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:20px;">No emails sent yet</p>';
        return;
      }
      
      historyDiv.innerHTML = emails.map(email => `
        <div style="padding:15px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:10px;border-left:4px solid ${email.status === 'sent' ? '#27ae60' : email.status === 'failed' ? '#e74c3c' : '#f39c12'};">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
            <div style="flex:1;">
              <strong style="color:var(--text-primary);">${escapeHtml(email.subject || 'No Subject')}</strong>
              <p style="margin:5px 0;color:var(--text-secondary);font-size:0.9rem;">To: ${escapeHtml(email.recipient || email.recipients?.join(', ') || 'N/A')}</p>
            </div>
            <span style="padding:4px 8px;border-radius:4px;font-size:0.85rem;background:${email.status === 'sent' ? '#d4edda' : email.status === 'failed' ? '#f8d7da' : '#fff3cd'};color:${email.status === 'sent' ? '#155724' : email.status === 'failed' ? '#721c24' : '#856404'};">
              ${email.status || 'Pending'}
            </span>
          </div>
          <p style="margin:0;color:var(--text-tertiary);font-size:0.85rem;">Sent: ${email.sentAt ? formatDate(email.sentAt) : 'N/A'}</p>
        </div>
      `).join('');
    } else {
      const errorMsg = r.apiResponse?.message || r.message || 'Failed to load email history';
      historyDiv.innerHTML = `<p style="color:#e74c3c;text-align:center;padding:20px;">${escapeHtml(errorMsg)}</p>`;
    }
  } catch(err){
    logError('loadEmailHistory', err);
    if(err.message && err.message.includes('404')){
      historyDiv.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_NOTIFICATIONS}/email-history</code> is not available yet.</p>
        </div>
      `;
    } else {
      historyDiv.innerHTML = `<p style="color:#e74c3c;text-align:center;padding:20px;">Error loading emails: ${escapeHtml(err.message || 'Unknown error')}</p>`;
    }
  }
}

// ----- Step 4: Audit Log Tab -----
async function loadAuditLogTab(page = 1){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  const html = `
    <div id="audit-content">
      <h2>üìã Audit Log</h2>
      <p style="color:#7f8c8d;margin-bottom:20px;">Track all changes and activities in the system</p>
      
      <div style="background:var(--bg-secondary);padding:20px;border-radius:12px;margin-bottom:20px;border:2px solid var(--border-color);">
        <h3 style="margin-top:0;color:var(--text-primary);">Filters</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;margin-bottom:15px;">
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Entity Type</label>
            <select id="auditEntityType" style="width:100%;padding:8px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
              <option value="">All Types</option>
              <option value="Customer">Customer</option>
              <option value="Bill">Bill</option>
              <option value="Payment">Payment</option>
            </select>
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Action</label>
            <select id="auditAction" style="width:100%;padding:8px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
              <option value="">All Actions</option>
              <option value="Create">Create</option>
              <option value="Update">Update</option>
              <option value="Delete">Delete</option>
            </select>
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">From Date</label>
            <input type="date" id="auditFromDate" style="width:100%;padding:8px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">To Date</label>
            <input type="date" id="auditToDate" style="width:100%;padding:8px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
          </div>
        </div>
        <button onclick="applyAuditFilters()" style="padding:10px 20px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;">üîç Apply Filters</button>
        <button onclick="clearAuditFilters()" style="padding:10px 20px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;font-weight:500;margin-left:10px;">üóëÔ∏è Clear</button>
      </div>
      
      <div id="auditLogList" style="display:grid;gap:10px;">
        <p style="color:var(--text-secondary);text-align:center;padding:20px;">Loading audit logs...</p>
      </div>
      
      <div id="auditPagination" class="pagination" style="margin-top:20px;"></div>
    </div>
  `;
  
  tabContent.innerHTML = html;
  await loadAuditLogs(page);
}

let auditFilters = { entityType: '', action: '', fromDate: null, toDate: null };

async function applyAuditFilters(){
  auditFilters = {
    entityType: document.getElementById('auditEntityType')?.value || '',
    action: document.getElementById('auditAction')?.value || '',
    fromDate: document.getElementById('auditFromDate')?.value || null,
    toDate: document.getElementById('auditToDate')?.value || null
  };
  await loadAuditLogs(1);
}

function clearAuditFilters(){
  document.getElementById('auditEntityType').value = '';
  document.getElementById('auditAction').value = '';
  document.getElementById('auditFromDate').value = '';
  document.getElementById('auditToDate').value = '';
  auditFilters = { entityType: '', action: '', fromDate: null, toDate: null };
  loadAuditLogs(1);
}

async function loadAuditLogs(page = 1){
  const logList = document.getElementById('auditLogList');
  if(!logList) return;
  
  try{
    const params = new URLSearchParams({
      page: page.toString(),
      limit: '50'
    });
    
    if(auditFilters.entityType) params.append('entityType', auditFilters.entityType);
    if(auditFilters.action) params.append('action', auditFilters.action);
    if(auditFilters.fromDate) params.append('fromDate', auditFilters.fromDate);
    if(auditFilters.toDate) params.append('toDate', auditFilters.toDate);
    
    const url = `${API_AUDIT}?${params.toString()}`;
    console.log('Loading audit logs from:', url);
    const r = await fetchJson(url, {
      headers: authHeader()
    });
    
    console.log('Audit logs response:', r);
    
    if(r.status === 404){
      logList.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:5px;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_AUDIT}</code> is not available yet.</p>
          <p style="color:var(--text-tertiary);font-size:0.85rem;">Please check Swagger documentation at <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
      return;
    }
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const data = r.apiResponse.body || r.data || {};
      const logs = data.logs || data || [];
      const totalPages = data.totalPages || Math.ceil((data.total || logs.length) / 10);
      
      if(logs.length === 0){
        logList.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:20px;">No audit logs found</p>';
        return;
      }
      
      logList.innerHTML = logs.map(log => {
        const actionClass = log.action?.toLowerCase() || 'unknown';
        return `
          <div class="audit-entry ${actionClass}">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
              <div style="flex:1;">
                <strong style="color:var(--text-primary);">${escapeHtml(log.action || 'Unknown')} ${escapeHtml(log.entityType || 'Entity')}</strong>
                <p style="margin:5px 0;color:var(--text-secondary);font-size:0.9rem;">
                  Entity ID: ${escapeHtml(log.entityId || 'N/A')} | 
                  User: ${escapeHtml(log.userName || log.userId || 'System')}
                </p>
              </div>
              <span style="color:var(--text-tertiary);font-size:0.85rem;">${log.timestamp ? formatDate(log.timestamp) : 'N/A'}</span>
            </div>
            ${log.changes && Object.keys(log.changes).length > 0 ? `
              <div class="audit-changes">
                <strong style="color:var(--text-primary);font-size:0.9rem;">Changes:</strong>
                ${Object.entries(log.changes).map(([key, change]) => `
                  <div class="change-item">
                    <span style="color:var(--text-secondary);">${escapeHtml(key)}:</span>
                    <span class="change-before">${escapeHtml(change.before || 'N/A')}</span>
                    <span>‚Üí</span>
                    <span class="change-after">${escapeHtml(change.after || 'N/A')}</span>
                  </div>
                `).join('')}
              </div>
            ` : ''}
            ${log.entityId ? `
              <button onclick="viewEntityHistory('${log.entityType}', ${log.entityId})" style="margin-top:10px;padding:6px 12px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:4px;cursor:pointer;font-size:0.85rem;">View Full History</button>
            ` : ''}
          </div>
        `;
      }).join('');
      
      const paginationDiv = document.getElementById('auditPagination');
      if(paginationDiv){
        createPagination('auditPagination', totalPages, page, (p) => loadAuditLogs(p));
      }
    } else {
      const errorMsg = r.apiResponse?.message || r.message || 'Failed to load audit logs';
      logList.innerHTML = `<p style="color:#e74c3c;text-align:center;padding:20px;">${escapeHtml(errorMsg)}</p>`;
    }
  } catch(err){
    logError('loadAuditLogs', err);
    if(err.message && err.message.includes('404')){
      logList.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_AUDIT}</code> is not available yet.</p>
          <p style="color:var(--text-tertiary);font-size:0.85rem;margin-top:10px;">Check Swagger: <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
    } else {
      logList.innerHTML = `<p style="color:#e74c3c;text-align:center;padding:20px;">Error loading audit logs: ${escapeHtml(err.message || 'Unknown error')}</p>`;
    }
  }
}

async function viewEntityHistory(entityType, entityId){
  try{
    showLoadingOverlay();
    const r = await fetchJson(`${API_AUDIT}/entity/${entityType}/${entityId}`, {
      headers: authHeader()
    });
    
    hideLoadingOverlay();
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const history = r.apiResponse.body || r.data || [];
      
      const modalHtml = `
        <div class="feature-modal show" id="entityHistoryModal" onclick="if(event.target.id === 'entityHistoryModal') closeEntityHistoryModal()">
          <div class="feature-modal-content">
            <div class="feature-modal-header">
              <h2>History for ${escapeHtml(entityType)} #${entityId}</h2>
              <button class="modal-close" onclick="closeEntityHistoryModal()">√ó</button>
            </div>
            <div style="max-height:500px;overflow-y:auto;">
              ${history.length === 0 ? '<p style="color:var(--text-secondary);text-align:center;padding:20px;">No history found</p>' : history.map(log => `
                <div class="audit-entry ${log.action?.toLowerCase() || 'unknown'}" style="margin-bottom:10px;">
                  <div style="display:flex;justify-content:space-between;align-items:start;">
                    <div style="flex:1;">
                      <strong style="color:var(--text-primary);">${escapeHtml(log.action || 'Unknown')}</strong>
                      <p style="margin:5px 0;color:var(--text-secondary);font-size:0.9rem;">
                        By: ${escapeHtml(log.userName || log.userId || 'System')} | 
                        ${log.timestamp ? formatDate(log.timestamp) : 'N/A'}
                      </p>
                    </div>
                  </div>
                  ${log.changes && Object.keys(log.changes).length > 0 ? `
                    <div class="audit-changes" style="margin-top:10px;">
                      ${Object.entries(log.changes).map(([key, change]) => `
                        <div class="change-item">
                          <span style="color:var(--text-secondary);">${escapeHtml(key)}:</span>
                          <span class="change-before">${escapeHtml(change.before || 'N/A')}</span>
                          <span>‚Üí</span>
                          <span class="change-after">${escapeHtml(change.after || 'N/A')}</span>
                        </div>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    } else {
      handleApiError(r, 'audit_msg', 'Failed to load entity history');
    }
  } catch(err){
    hideLoadingOverlay();
    logError('viewEntityHistory', err);
    showError('audit_msg', 'Failed to load entity history: ' + err.message);
  }
}

function closeEntityHistoryModal(){
  const modal = document.getElementById('entityHistoryModal');
  if(modal) modal.remove();
}

// ----- Step 5: Reminders Tab -----
async function loadRemindersTab(){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  const html = `
    <div id="reminders-content">
      <h2>üîî Reminders</h2>
      <p style="color:#7f8c8d;margin-bottom:20px;">Manage reminders for overdue bills, pending payments, and custom alerts</p>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:15px;margin-bottom:20px;">
        <button onclick="loadReminders('overdue', 'all')" class="reminder-type-btn" style="padding:15px;background:var(--bg-secondary);border:2px solid #e74c3c;border-radius:8px;cursor:pointer;text-align:center;">
          <strong style="color:var(--text-primary);display:block;margin-bottom:5px;">Overdue Bills</strong>
          <span style="color:var(--text-secondary);font-size:0.9rem;">Bills past due date</span>
        </button>
        <button onclick="loadReminders('upcoming', 'all')" class="reminder-type-btn" style="padding:15px;background:var(--bg-secondary);border:2px solid #f39c12;border-radius:8px;cursor:pointer;text-align:center;">
          <strong style="color:var(--text-primary);display:block;margin-bottom:5px;">Upcoming Payments</strong>
          <span style="color:var(--text-secondary);font-size:0.9rem;">Payments due soon</span>
        </button>
        <button onclick="loadReminders('cheques', 'all')" class="reminder-type-btn" style="padding:15px;background:var(--bg-secondary);border:2px solid #3498db;border-radius:8px;cursor:pointer;text-align:center;">
          <strong style="color:var(--text-primary);display:block;margin-bottom:5px;">Pending Cheques</strong>
          <span style="color:var(--text-secondary);font-size:0.9rem;">Uncleared cheques</span>
        </button>
        <button onclick="loadReminders('custom', 'all')" class="reminder-type-btn" style="padding:15px;background:var(--bg-secondary);border:2px solid #9b59b6;border-radius:8px;cursor:pointer;text-align:center;">
          <strong style="color:var(--text-primary);display:block;margin-bottom:5px;">Custom Reminders</strong>
          <span style="color:var(--text-secondary);font-size:0.9rem;">User-created reminders</span>
        </button>
      </div>
      
      <div style="background:var(--bg-secondary);padding:20px;border-radius:12px;margin-bottom:20px;border:2px solid var(--border-color);">
        <h3 style="margin-top:0;color:var(--text-primary);">Create Custom Reminder</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;margin-bottom:15px;">
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Title *</label>
            <input type="text" id="reminderTitle" placeholder="Reminder title" style="width:100%;padding:8px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Due Date *</label>
            <input type="datetime-local" id="reminderDueDate" style="width:100%;padding:8px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Priority</label>
            <select id="reminderPriority" style="width:100%;padding:8px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
              <option value="Low">Low</option>
              <option value="Medium" selected>Medium</option>
              <option value="High">High</option>
            </select>
          </div>
        </div>
        <div style="margin-bottom:15px;">
          <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Description</label>
          <textarea id="reminderDescription" placeholder="Reminder description" rows="3" style="width:100%;padding:8px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);resize:vertical;"></textarea>
        </div>
        <button onclick="createCustomReminder()" style="padding:10px 20px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;">‚ûï Create Reminder</button>
        <div id="reminder_msg" style="margin-top:15px;"></div>
      </div>
      
      <div>
        <h3 style="color:var(--text-primary);margin-bottom:15px;">Reminders</h3>
        <div id="remindersList" style="display:grid;gap:10px;">
          <p style="color:var(--text-secondary);text-align:center;padding:20px;">Select a reminder type above</p>
        </div>
      </div>
    </div>
  `;
  
  tabContent.innerHTML = html;
  loadReminders('overdue', 'all');
}

let currentReminderType = 'overdue';
let currentReminderStatus = 'all';

async function loadReminders(type, status){
  currentReminderType = type;
  currentReminderStatus = status;
  
  const remindersList = document.getElementById('remindersList');
  if(!remindersList) return;
  
  try{
    const params = new URLSearchParams({
      type: type,
      status: status
    });
    
    const url = `${API_REMINDERS}?${params.toString()}`;
    console.log('Loading reminders from:', url);
    const r = await fetchJson(url, {
      headers: authHeader()
    });
    
    console.log('Reminders response:', r);
    
    if(r.status === 404){
      remindersList.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:5px;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_REMINDERS}</code> is not available yet.</p>
          <p style="color:var(--text-tertiary);font-size:0.85rem;">Please check Swagger documentation at <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
      return;
    }
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const reminders = r.apiResponse.body || r.data || [];
      
      if(reminders.length === 0){
        remindersList.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:20px;">No reminders found</p>';
        return;
      }
      
      remindersList.innerHTML = reminders.map(reminder => {
        const priorityClass = reminder.priority?.toLowerCase() || 'medium';
        const isOverdue = reminder.dueDate && new Date(reminder.dueDate) < new Date();
        
        return `
          <div class="reminder-card ${priorityClass}-priority" style="${isOverdue ? 'border-left-color:#e74c3c;' : ''}">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
              <div style="flex:1;">
                <strong style="color:var(--text-primary);display:block;margin-bottom:5px;">${escapeHtml(reminder.title || 'Untitled')}</strong>
                <p style="margin:5px 0;color:var(--text-secondary);font-size:0.9rem;">${escapeHtml(reminder.description || 'No description')}</p>
                <p style="margin:5px 0;color:var(--text-tertiary);font-size:0.85rem;">
                  Due: ${reminder.dueDate ? formatDate(reminder.dueDate) : 'N/A'}
                  ${isOverdue ? ' <span style="color:#e74c3c;font-weight:600;">(OVERDUE)</span>' : ''}
                </p>
              </div>
              <span style="padding:4px 8px;border-radius:4px;font-size:0.85rem;background:${priorityClass === 'high' ? '#fee' : priorityClass === 'medium' ? '#fff3cd' : '#e3f2fd'};color:${priorityClass === 'high' ? '#c33' : priorityClass === 'medium' ? '#856404' : '#1976d2'};">
                ${reminder.priority || 'Medium'}
              </span>
            </div>
            <div style="display:flex;gap:10px;margin-top:10px;">
              ${reminder.status !== 'dismissed' ? `
                <button onclick="dismissReminder(${reminder.reminderId || reminder.id})" style="padding:6px 12px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:4px;cursor:pointer;font-size:0.85rem;">‚úì Dismiss</button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    } else {
      const errorMsg = r.apiResponse?.message || r.message || 'Failed to load reminders';
      remindersList.innerHTML = `<p style="color:#e74c3c;text-align:center;padding:20px;">${escapeHtml(errorMsg)}</p>`;
    }
  } catch(err){
    logError('loadReminders', err);
    if(err.message && err.message.includes('404')){
      remindersList.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_REMINDERS}</code> is not available yet.</p>
          <p style="color:var(--text-tertiary);font-size:0.85rem;margin-top:10px;">Check Swagger: <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
    } else {
      remindersList.innerHTML = `<p style="color:#e74c3c;text-align:center;padding:20px;">Error loading reminders: ${escapeHtml(err.message || 'Unknown error')}</p>`;
    }
  }
}

async function createCustomReminder(){
  const title = document.getElementById('reminderTitle')?.value.trim();
  const dueDate = document.getElementById('reminderDueDate')?.value;
  const priority = document.getElementById('reminderPriority')?.value;
  const description = document.getElementById('reminderDescription')?.value.trim();
  
  if(!title || !dueDate){
    showError('reminder_msg', 'Please enter title and due date');
    return;
  }
  
  showLoading('reminder_msg', 'Creating reminder...');
  
  try{
    const payload = {
      title,
      dueDate: new Date(dueDate).toISOString(),
      priority: priority || 'Medium',
      description: description || null,
      type: 'Custom'
    };
    
    const r = await fetchJson(API_REMINDERS, {
      method: 'POST',
      headers: authHeader(),
      body: JSON.stringify(payload)
    });
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      showSuccess('reminder_msg', 'Reminder created successfully!');
      document.getElementById('reminderTitle').value = '';
      document.getElementById('reminderDueDate').value = '';
      document.getElementById('reminderPriority').value = 'Medium';
      document.getElementById('reminderDescription').value = '';
      loadReminders('custom', 'all');
    } else {
      handleApiError(r, 'reminder_msg', 'Failed to create reminder');
    }
  } catch(err){
    logError('createCustomReminder', err);
    showError('reminder_msg', 'Failed to create reminder: ' + err.message);
  }
}

async function dismissReminder(reminderId){
  if(!confirm('Are you sure you want to dismiss this reminder?')) return;
  
  try{
    const r = await fetchJson(`${API_REMINDERS}/${reminderId}/dismiss`, {
      method: 'PUT',
      headers: authHeader()
    });
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      showSuccess('reminder_msg', 'Reminder dismissed');
      loadReminders(currentReminderType, currentReminderStatus);
    } else {
      handleApiError(r, 'reminder_msg', 'Failed to dismiss reminder');
    }
  } catch(err){
    logError('dismissReminder', err);
    showError('reminder_msg', 'Failed to dismiss reminder: ' + err.message);
  }
}

// ----- Step 6: Advanced Search Tab -----
async function loadSearchTab(){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  const html = `
    <div id="search-content">
      <h2>üîç Advanced Search</h2>
      <p style="color:#7f8c8d;margin-bottom:20px;">Search across all entities with advanced filters</p>
      
      <div style="background:var(--bg-secondary);padding:25px;border-radius:12px;margin-bottom:20px;border:2px solid var(--border-color);">
        <div style="margin-bottom:15px;">
          <input type="text" id="globalSearchInput" placeholder="Search across customers, bills, payments..." style="width:100%;padding:12px;border:2px solid var(--border-color);border-radius:8px;background:var(--bg-primary);color:var(--text-primary);font-size:1rem;" onkeyup="performGlobalSearchDebounced()">
        </div>
        <div style="display:flex;gap:15px;flex-wrap:wrap;margin-bottom:15px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="searchCustomers" checked style="width:18px;height:18px;">
            <span style="color:var(--text-secondary);">Customers</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="searchBills" checked style="width:18px;height:18px;">
            <span style="color:var(--text-secondary);">Bills</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="searchPayments" checked style="width:18px;height:18px;">
            <span style="color:var(--text-secondary);">Payments</span>
          </label>
        </div>
        <div style="display:flex;gap:10px;">
          <button onclick="saveFilterPreset()" style="padding:8px 16px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;font-weight:500;">üíæ Save Preset</button>
          <button onclick="loadSavedPresets()" style="padding:8px 16px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;font-weight:500;">üìã Load Presets</button>
        </div>
      </div>
      
      <div id="searchResults" style="display:grid;gap:20px;">
        <p style="color:var(--text-secondary);text-align:center;padding:40px;">Enter a search term to begin</p>
      </div>
      
      <div id="savedPresets" style="margin-top:30px;display:none;">
        <h3 style="color:var(--text-primary);margin-bottom:15px;">Saved Presets</h3>
        <div id="presetsList" style="display:grid;gap:10px;"></div>
      </div>
    </div>
  `;
  
  tabContent.innerHTML = html;
  loadSavedPresets();
}

let searchDebounceTimer = null;

function performGlobalSearchDebounced(){
  clearTimeout(searchDebounceTimer);
  searchDebounceTimer = setTimeout(() => {
    performGlobalSearch();
  }, 300);
}

async function performGlobalSearch(){
  const query = document.getElementById('globalSearchInput')?.value.trim();
  const searchCustomers = document.getElementById('searchCustomers')?.checked;
  const searchBills = document.getElementById('searchBills')?.checked;
  const searchPayments = document.getElementById('searchPayments')?.checked;
  
  const resultsDiv = document.getElementById('searchResults');
  if(!resultsDiv) return;
  
  if(!query || query.length < 2){
    resultsDiv.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:40px;">Enter at least 2 characters to search</p>';
    return;
  }
  
  const entityTypes = [];
  if(searchCustomers) entityTypes.push('Customer');
  if(searchBills) entityTypes.push('Bill');
  if(searchPayments) entityTypes.push('Payment');
  
  if(entityTypes.length === 0){
    resultsDiv.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:40px;">Please select at least one entity type</p>';
    return;
  }
  
  resultsDiv.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:40px;">Searching...</p>';
  
  try{
    // Build query parameters for GET request
    const queryParams = new URLSearchParams({
      q: query,
      limit: '10'
    });
    
    if(entityTypes.length > 0){
      queryParams.append('types', entityTypes.join(','));
    }
    
    const searchUrl = `${API_SEARCH}?${queryParams.toString()}`;
    console.log('Performing global search:', searchUrl);
    const r = await fetchJson(searchUrl, {
      method: 'GET',
      headers: authHeader()
    });
    
    console.log('Search response:', r);
    
    if(r.status === 404){
      resultsDiv.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:5px;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_SEARCH}</code> is not available yet.</p>
          <p style="color:var(--text-tertiary);font-size:0.85rem;">Please check Swagger documentation at <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
      return;
    }
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const results = r.apiResponse.body || r.data || {};
      
      let html = '';
      
      if(results.customers && results.customers.length > 0){
        html += `
          <div class="search-result-group">
            <h3>Customers (${results.customers.length})</h3>
            ${results.customers.map(c => `
              <div class="search-result-item" onclick="navigateToEntity('Customer', ${c.id})">
                <strong style="color:var(--text-primary);">${escapeHtml(c.name || 'N/A')}</strong>
                <p style="margin:5px 0;color:var(--text-secondary);font-size:0.9rem;">
                  Phone: ${escapeHtml(c.phone || 'N/A')} | 
                  Address: ${escapeHtml(c.address || 'N/A')}
                </p>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      if(results.bills && results.bills.length > 0){
        html += `
          <div class="search-result-group">
            <h3>Bills (${results.bills.length})</h3>
            ${results.bills.map(b => `
              <div class="search-result-item" onclick="navigateToEntity('Bill', ${b.id})">
                <strong style="color:var(--text-primary);">Bill #${escapeHtml(b.billNumber || b.id)}</strong>
                <p style="margin:5px 0;color:var(--text-secondary);font-size:0.9rem;">
                  Amount: ‚Çπ${parseFloat(b.billAmount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})} | 
                  Status: ${escapeHtml(b.status || 'N/A')}
                </p>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      if(results.payments && results.payments.length > 0){
        html += `
          <div class="search-result-group">
            <h3>Payments (${results.payments.length})</h3>
            ${results.payments.map(p => `
              <div class="search-result-item" onclick="navigateToEntity('Payment', ${p.id})">
                <strong style="color:var(--text-primary);">Payment #${p.id}</strong>
                <p style="margin:5px 0;color:var(--text-secondary);font-size:0.9rem;">
                  Amount: ‚Çπ${parseFloat(p.amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})} | 
                  Mode: ${escapeHtml(p.mode || 'N/A')}
                </p>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      if(!html){
        html = '<p style="color:var(--text-secondary);text-align:center;padding:40px;">No results found</p>';
      }
      
      resultsDiv.innerHTML = html;
    } else {
      const errorMsg = r.apiResponse?.message || r.message || 'Search failed';
      resultsDiv.innerHTML = `<p style="color:#e74c3c;text-align:center;padding:40px;">${escapeHtml(errorMsg)}</p>`;
    }
  } catch(err){
    logError('performGlobalSearch', err);
    if(err.message && err.message.includes('404')){
      resultsDiv.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_SEARCH}</code> is not available yet.</p>
          <p style="color:var(--text-tertiary);font-size:0.85rem;margin-top:10px;">Check Swagger: <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
    } else {
      resultsDiv.innerHTML = `<p style="color:#e74c3c;text-align:center;padding:40px;">Error performing search: ${escapeHtml(err.message || 'Unknown error')}</p>`;
    }
  }
}

function navigateToEntity(entityType, entityId){
  if(entityType === 'Customer'){
    document.querySelector('.tab-link[data-tab="customers"]')?.click();
    setTimeout(() => {
      const customerLink = document.querySelector(`.customer-link[data-id="${entityId}"]`);
      if(customerLink) customerLink.scrollIntoView({behavior: 'smooth', block: 'center'});
    }, 500);
  } else if(entityType === 'Bill'){
    document.querySelector('.tab-link[data-tab="bills"]')?.click();
    setTimeout(() => {
      const billLink = document.querySelector(`.bill-link[data-bill-id="${entityId}"]`);
      if(billLink) billLink.scrollIntoView({behavior: 'smooth', block: 'center'});
    }, 500);
  } else if(entityType === 'Payment'){
    document.querySelector('.tab-link[data-tab="payments"]')?.click();
  }
}

async function saveFilterPreset(){
  const query = document.getElementById('globalSearchInput')?.value.trim();
  const searchCustomers = document.getElementById('searchCustomers')?.checked;
  const searchBills = document.getElementById('searchBills')?.checked;
  const searchPayments = document.getElementById('searchPayments')?.checked;
  
  const presetName = prompt('Enter a name for this preset:');
  if(!presetName) return;
  
  try{
    const payload = {
      name: presetName,
      query: query || '',
      entityTypes: {
        customers: searchCustomers,
        bills: searchBills,
        payments: searchPayments
      }
    };
    
    const r = await fetchJson(`${API_FILTERS}/presets`, {
      method: 'POST',
      headers: authHeader(),
      body: JSON.stringify(payload)
    });
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      showSuccess('search_msg', 'Preset saved successfully!');
      loadSavedPresets();
    } else {
      handleApiError(r, 'search_msg', 'Failed to save preset');
    }
  } catch(err){
    logError('saveFilterPreset', err);
    showError('search_msg', 'Failed to save preset: ' + err.message);
  }
}

async function loadSavedPresets(){
  const presetsDiv = document.getElementById('presetsList');
  const savedPresetsDiv = document.getElementById('savedPresets');
  if(!presetsDiv || !savedPresetsDiv) return;
  
  try{
    console.log('Loading saved presets from:', `${API_FILTERS}/presets`);
    const r = await fetchJson(`${API_FILTERS}/presets`, {
      headers: authHeader()
    });
    
    console.log('Presets response:', r);
    
    if(r.status === 404){
      savedPresetsDiv.style.display = 'none';
      return;
    }
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const presets = r.apiResponse.body || r.data || [];
      
      if(presets.length === 0){
        savedPresetsDiv.style.display = 'none';
        return;
      }
      
      savedPresetsDiv.style.display = 'block';
      presetsDiv.innerHTML = presets.map(preset => `
        <div class="filter-preset-card">
          <div style="flex:1;">
            <strong style="color:var(--text-primary);">${escapeHtml(preset.name || 'Unnamed')}</strong>
            <p style="margin:5px 0;color:var(--text-secondary);font-size:0.9rem;">${escapeHtml(preset.query || 'No query')}</p>
          </div>
          <div style="display:flex;gap:10px;">
            <button onclick="applyPreset(${preset.presetId || preset.id})" style="padding:6px 12px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.85rem;">Apply</button>
            <button onclick="deletePreset(${preset.presetId || preset.id})" style="padding:6px 12px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.85rem;">Delete</button>
          </div>
        </div>
      `).join('');
    }
  } catch(err){
    logError('loadSavedPresets', err);
    // Silently fail - presets are optional
  }
}

async function applyPreset(presetId){
  try{
    const r = await fetchJson(`${API_FILTERS}/presets/${presetId}`, {
      headers: authHeader()
    });
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const preset = r.apiResponse.body || r.data;
      
      if(preset.query) document.getElementById('globalSearchInput').value = preset.query;
      if(preset.entityTypes){
        document.getElementById('searchCustomers').checked = preset.entityTypes.customers !== false;
        document.getElementById('searchBills').checked = preset.entityTypes.bills !== false;
        document.getElementById('searchPayments').checked = preset.entityTypes.payments !== false;
      }
      
      performGlobalSearch();
    }
  } catch(err){
    logError('applyPreset', err);
  }
}

async function deletePreset(presetId){
  if(!confirm('Are you sure you want to delete this preset?')) return;
  
  try{
    const r = await fetchJson(`${API_FILTERS}/presets/${presetId}`, {
      method: 'DELETE',
      headers: authHeader()
    });
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      showSuccess('search_msg', 'Preset deleted');
      loadSavedPresets();
    } else {
      handleApiError(r, 'search_msg', 'Failed to delete preset');
    }
  } catch(err){
    logError('deletePreset', err);
    showError('search_msg', 'Failed to delete preset: ' + err.message);
  }
}

// ----- Step 7: Dashboard Customization Tab -----
async function loadCustomizeTab(){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  const html = `
    <div id="customize-content">
      <h2>‚öôÔ∏è Dashboard Customization</h2>
      <p style="color:#7f8c8d;margin-bottom:20px;">Customize your dashboard layout and widget visibility</p>
      
      <div style="background:var(--bg-secondary);padding:25px;border-radius:12px;margin-bottom:20px;border:2px solid var(--border-color);">
        <h3 style="margin-top:0;color:var(--text-primary);">Layout Settings</h3>
        <div style="margin-bottom:15px;">
          <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Layout Style</label>
          <select id="layoutStyle" style="width:100%;max-width:300px;padding:10px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
            <option value="Grid">Grid Layout</option>
            <option value="List">List Layout</option>
          </select>
        </div>
        <button onclick="saveDashboardLayout()" style="padding:10px 20px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;margin-right:10px;">üíæ Save Layout</button>
        <button onclick="resetDashboardLayout()" style="padding:10px 20px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;font-weight:500;">üîÑ Reset to Default</button>
      </div>
      
      <div>
        <h3 style="color:var(--text-primary);margin-bottom:15px;">Widgets</h3>
        <p style="color:var(--text-secondary);margin-bottom:15px;">Drag to reorder, toggle to show/hide</p>
        <div id="widgetList" class="widget-list">
          <p style="color:var(--text-secondary);text-align:center;padding:20px;">Loading widgets...</p>
        </div>
      </div>
    </div>
  `;
  
  tabContent.innerHTML = html;
  loadDashboardLayout();
}

async function loadDashboardLayout(){
  const widgetList = document.getElementById('widgetList');
  if(!widgetList) return;
  
  try{
    console.log('Loading dashboard layout from:', `${API_BASE}/DashboardCustomization/layout`);
    const r = await fetchJson(`${API_BASE}/DashboardCustomization/layout`, {
      headers: authHeader()
    });
    
    console.log('Dashboard layout response:', r);
    
    const widgets = [
      {id: 'financialOverview', name: 'Financial Overview', visible: true, order: 1},
      {id: 'billsByStatus', name: 'Bills by Status', visible: true, order: 2},
      {id: 'paymentTrends', name: 'Payment Trends', visible: true, order: 3},
      {id: 'paymentModes', name: 'Payment Methods', visible: true, order: 4},
      {id: 'revenueGrowth', name: 'Revenue Growth', visible: true, order: 5},
      {id: 'customerGrowth', name: 'Customer Growth', visible: true, order: 6},
      {id: 'topCustomers', name: 'Top Customers', visible: true, order: 7},
      {id: 'billPayment', name: 'Bill vs Payment', visible: true, order: 8}
    ];
    
    if(r.status === 404){
      // Continue with default widgets
    } else if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const layout = r.apiResponse.body || r.data;
      if(layout && layout.widgets){
        layout.widgets.forEach(lw => {
          const widget = widgets.find(w => w.id === lw.widgetId);
          if(widget){
            widget.visible = lw.visible !== false;
            widget.order = lw.order || widget.order;
          }
        });
      }
    }
    
    widgets.sort((a, b) => a.order - b.order);
    
    widgetList.innerHTML = widgets.map(widget => `
      <div class="widget-item" data-widget-id="${widget.id}" draggable="true">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="cursor:move;font-size:1.2rem;">‚ò∞</span>
          <span style="color:var(--text-primary);">${escapeHtml(widget.name)}</span>
        </div>
        <div class="widget-toggle">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" ${widget.visible ? 'checked' : ''} onchange="toggleWidgetVisibility('${widget.id}', this.checked)" style="width:18px;height:18px;">
            <span style="color:var(--text-secondary);font-size:0.9rem;">Visible</span>
          </label>
        </div>
      </div>
    `).join('');
    
    // Setup drag and drop
    setupWidgetDragAndDrop();
  } catch(err){
    logError('loadDashboardLayout', err);
    // Show default widgets even if API fails
    const widgetList = document.getElementById('widgetList');
    if(widgetList){
      widgetList.innerHTML = `
        <div style="padding:20px;text-align:center;background:var(--bg-secondary);border-radius:8px;border:2px dashed var(--border-color);">
          <p style="color:var(--text-primary);font-weight:600;margin-bottom:10px;">‚ö†Ô∏è API Endpoint Not Implemented</p>
          <p style="color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_BASE}/DashboardCustomization/layout</code> is not available yet.</p>
          <p style="color:var(--text-tertiary);font-size:0.85rem;margin-top:10px;">Check Swagger: <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
    }
  }
}

function setupWidgetDragAndDrop(){
  const widgetItems = document.querySelectorAll('.widget-item');
  let draggedElement = null;
  
  widgetItems.forEach(item => {
    item.addEventListener('dragstart', (e) => {
      draggedElement = item;
      item.classList.add('dragging');
    });
    
    item.addEventListener('dragend', () => {
      item.classList.remove('dragging');
      draggedElement = null;
    });
    
    item.addEventListener('dragover', (e) => {
      e.preventDefault();
      if(draggedElement && draggedElement !== item){
        const allItems = Array.from(document.querySelectorAll('.widget-item'));
        const draggedIndex = allItems.indexOf(draggedElement);
        const targetIndex = allItems.indexOf(item);
        
        if(draggedIndex < targetIndex){
          item.parentNode.insertBefore(draggedElement, item.nextSibling);
        } else {
          item.parentNode.insertBefore(draggedElement, item);
        }
      }
    });
  });
}

async function toggleWidgetVisibility(widgetId, visible){
  try{
    const r = await fetchJson(`${API_BASE}/DashboardCustomization/layout/widget/${widgetId}`, {
      method: 'PUT',
      headers: authHeader(),
      body: JSON.stringify({visible})
    });
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      showSuccess('customize_msg', 'Widget visibility updated');
    }
  } catch(err){
    logError('toggleWidgetVisibility', err);
  }
}

async function saveDashboardLayout(){
  const layoutStyle = document.getElementById('layoutStyle')?.value;
  const widgetItems = document.querySelectorAll('.widget-item');
  
  const widgets = Array.from(widgetItems).map((item, index) => ({
    widgetId: item.dataset.widgetId,
    visible: item.querySelector('input[type="checkbox"]')?.checked !== false,
    order: index + 1
  }));
  
  try{
    const payload = {
      layoutStyle: layoutStyle || 'Grid',
      widgets
    };
    
    const r = await fetchJson(`${API_BASE}/DashboardCustomization/layout`, {
      method: 'PUT',
      headers: authHeader(),
      body: JSON.stringify(payload)
    });
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      showSuccess('customize_msg', 'Dashboard layout saved successfully!');
    } else {
      handleApiError(r, 'customize_msg', 'Failed to save layout');
    }
  } catch(err){
    logError('saveDashboardLayout', err);
    showError('customize_msg', 'Failed to save layout: ' + err.message);
  }
}

async function resetDashboardLayout(){
  if(!confirm('Are you sure you want to reset to default layout?')) return;
  
  try{
    const r = await fetchJson(`${API_BASE}/DashboardCustomization/layout/reset`, {
      method: 'POST',
      headers: authHeader()
    });
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      showSuccess('customize_msg', 'Layout reset to default');
      loadDashboardLayout();
    } else {
      handleApiError(r, 'customize_msg', 'Failed to reset layout');
    }
  } catch(err){
    logError('resetDashboardLayout', err);
    showError('customize_msg', 'Failed to reset layout: ' + err.message);
  }
}

// ----- Step 8: Data Validation Tab -----
async function loadValidationTab(){
  const tabContent = document.getElementById('tab-content');
  if(!tabContent) return;
  
  const html = `
    <div id="validation-content">
      <h2>‚úÖ Data Validation</h2>
      <p style="color:#7f8c8d;margin-bottom:20px;">Validate data quality and check for duplicates</p>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin-bottom:30px;">
        <!-- Duplicate Check -->
        <div style="background:var(--bg-secondary);padding:25px;border-radius:12px;border:2px solid var(--border-color);">
          <h3 style="margin-top:0;color:var(--text-primary);">Duplicate Check</h3>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:15px;">Check for duplicate records</p>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Entity Type</label>
            <select id="duplicateEntityType" style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
              <option value="Customer">Customer</option>
              <option value="Bill">Bill</option>
              <option value="Payment">Payment</option>
            </select>
          </div>
          <button onclick="checkDuplicates()" style="width:100%;padding:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">üîç Check Duplicates</button>
          <div id="duplicateResults" style="margin-top:15px;"></div>
        </div>
        
        <!-- Data Validation -->
        <div style="background:var(--bg-secondary);padding:25px;border-radius:12px;border:2px solid var(--border-color);">
          <h3 style="margin-top:0;color:var(--text-primary);">Data Validation</h3>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:15px;">Validate data format and integrity</p>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-weight:500;">Entity Type</label>
            <select id="validateEntityType" style="width:100%;padding:10px;border:2px solid var(--border-color);border-radius:6px;background:var(--bg-primary);color:var(--text-primary);">
              <option value="Customer">Customer</option>
              <option value="Bill">Bill</option>
              <option value="Payment">Payment</option>
            </select>
          </div>
          <button onclick="validateData()" style="width:100%;padding:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">‚úÖ Validate Data</button>
          <div id="validationResults" style="margin-top:15px;"></div>
        </div>
        
        <!-- Quality Report -->
        <div style="background:var(--bg-secondary);padding:25px;border-radius:12px;border:2px solid var(--border-color);">
          <h3 style="margin-top:0;color:var(--text-primary);">Quality Report</h3>
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:15px;">Get overall data quality score</p>
          <button onclick="getQualityReport()" style="width:100%;padding:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">üìä Generate Report</button>
          <div id="qualityReport" style="margin-top:15px;"></div>
        </div>
      </div>
    </div>
  `;
  
  tabContent.innerHTML = html;
}

async function checkDuplicates(){
  const entityType = document.getElementById('duplicateEntityType')?.value;
  if(!entityType){
    showError('validation_msg', 'Please select entity type');
    return;
  }
  
  const resultsDiv = document.getElementById('duplicateResults');
  if(!resultsDiv) return;
  
  resultsDiv.innerHTML = '<p style="color:var(--text-secondary);">Checking for duplicates...</p>';
  
  try{
    console.log('Checking duplicates from:', `${API_VALIDATION}/check-duplicates`);
    const r = await fetchJson(`${API_VALIDATION}/check-duplicates`, {
      method: 'POST',
      headers: authHeader(),
      body: JSON.stringify({
        entityType: entityType,
        fields: entityType === 'Customer' ? ['phone', 'email'] : entityType === 'Bill' ? ['billNumber'] : ['paymentReference']
      })
    });
    
    console.log('Duplicates response:', r);
    
    if(r.status === 404){
      resultsDiv.innerHTML = `
        <div class="validation-result error">
          <strong style="color:var(--text-primary);">‚ö†Ô∏è API Endpoint Not Implemented</strong>
          <p style="margin:5px 0 0 0;color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_VALIDATION}/check-duplicates</code> is not available yet.</p>
          <p style="margin:5px 0 0 0;color:var(--text-tertiary);font-size:0.85rem;">Check Swagger: <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
      return;
    }
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const duplicates = r.apiResponse.body || r.data || [];
      
      if(duplicates.length === 0){
        resultsDiv.innerHTML = `
          <div class="validation-result success">
            <strong style="color:var(--text-primary);">‚úì No duplicates found</strong>
            <p style="margin:5px 0 0 0;color:var(--text-secondary);">All ${entityType} records are unique</p>
          </div>
        `;
      } else {
        resultsDiv.innerHTML = `
          <div class="validation-result warning">
            <strong style="color:var(--text-primary);">‚ö† Found ${duplicates.length} duplicate(s)</strong>
            <div style="margin-top:10px;max-height:200px;overflow-y:auto;">
              ${duplicates.map(dup => `
                <div style="padding:8px;background:var(--bg-primary);border-radius:4px;margin-bottom:5px;font-size:0.9rem;">
                  ${escapeHtml(JSON.stringify(dup))}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    } else {
      handleApiError(r, 'validation_msg', 'Failed to check duplicates');
    }
  } catch(err){
    logError('checkDuplicates', err);
    if(err.message && err.message.includes('404')){
      resultsDiv.innerHTML = `
        <div class="validation-result error">
          <strong style="color:var(--text-primary);">‚ö†Ô∏è API Endpoint Not Implemented</strong>
          <p style="margin:5px 0 0 0;color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_VALIDATION}/check-duplicates</code> is not available yet.</p>
        </div>
      `;
    } else {
      resultsDiv.innerHTML = '<div class="validation-result error"><strong>Error:</strong> ' + escapeHtml(err.message) + '</div>';
    }
  }
}

async function validateData(){
  const entityType = document.getElementById('validateEntityType')?.value;
  if(!entityType){
    showError('validation_msg', 'Please select entity type');
    return;
  }
  
  const resultsDiv = document.getElementById('validationResults');
  if(!resultsDiv) return;
  
  resultsDiv.innerHTML = '<p style="color:var(--text-secondary);">Validating data...</p>';
  
  try{
    console.log('Validating data from:', `${API_VALIDATION}/validate`);
    const r = await fetchJson(`${API_VALIDATION}/validate`, {
      method: 'POST',
      headers: authHeader(),
      body: JSON.stringify({
        entityType: entityType,
        entityId: null // Validate all entities of this type
      })
    });
    
    console.log('Validation response:', r);
    
    if(r.status === 404){
      resultsDiv.innerHTML = `
        <div class="validation-result error">
          <strong style="color:var(--text-primary);">‚ö†Ô∏è API Endpoint Not Implemented</strong>
          <p style="margin:5px 0 0 0;color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_VALIDATION}/validate</code> is not available yet.</p>
          <p style="margin:5px 0 0 0;color:var(--text-tertiary);font-size:0.85rem;">Check Swagger: <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
      return;
    }
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const validation = r.apiResponse.body || r.data || {};
      const {valid, errors, warnings} = validation;
      
      resultsDiv.innerHTML = `
        <div class="validation-result ${valid ? 'success' : 'error'}">
          <strong style="color:var(--text-primary);">${valid ? '‚úì Validation Passed' : '‚úó Validation Failed'}</strong>
          ${errors && errors.length > 0 ? `
            <div style="margin-top:10px;">
              <strong style="color:#e74c3c;">Errors (${errors.length}):</strong>
              <ul style="margin:5px 0 0 20px;font-size:0.9rem;">
                ${errors.map(e => `<li style="color:#c33;">${escapeHtml(e)}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          ${warnings && warnings.length > 0 ? `
            <div style="margin-top:10px;">
              <strong style="color:#f39c12;">Warnings (${warnings.length}):</strong>
              <ul style="margin:5px 0 0 20px;font-size:0.9rem;">
                ${warnings.map(w => `<li style="color:#856404;">${escapeHtml(w)}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      `;
    } else {
      handleApiError(r, 'validation_msg', 'Failed to validate data');
    }
  } catch(err){
    logError('validateData', err);
    if(err.message && err.message.includes('404')){
      resultsDiv.innerHTML = `
        <div class="validation-result error">
          <strong style="color:var(--text-primary);">‚ö†Ô∏è API Endpoint Not Implemented</strong>
          <p style="margin:5px 0 0 0;color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_VALIDATION}/validate</code> is not available yet.</p>
        </div>
      `;
    } else {
      resultsDiv.innerHTML = '<div class="validation-result error"><strong>Error:</strong> ' + escapeHtml(err.message) + '</div>';
    }
  }
}

async function getQualityReport(){
  const reportDiv = document.getElementById('qualityReport');
  if(!reportDiv) return;
  
  reportDiv.innerHTML = '<p style="color:var(--text-secondary);">Generating quality report...</p>';
  
  try{
    console.log('Getting quality report from:', `${API_VALIDATION}/quality-report`);
    const r = await fetchJson(`${API_VALIDATION}/quality-report`, {
      headers: authHeader()
    });
    
    console.log('Quality report response:', r);
    
    if(r.status === 404){
      reportDiv.innerHTML = `
        <div class="validation-result error">
          <strong style="color:var(--text-primary);">‚ö†Ô∏è API Endpoint Not Implemented</strong>
          <p style="margin:5px 0 0 0;color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_VALIDATION}/quality-report</code> is not available yet.</p>
          <p style="margin:5px 0 0 0;color:var(--text-tertiary);font-size:0.85rem;">Check Swagger: <a href="http://localhost/swagger/index.html" target="_blank" style="color:#3498db;">http://localhost/swagger/index.html</a></p>
        </div>
      `;
      return;
    }
    
    if(r.ok && r.apiResponse && r.apiResponse.status === true){
      const report = r.apiResponse.body || r.data || {};
      const {score, details} = report;
      
      const scoreColor = score >= 80 ? '#27ae60' : score >= 60 ? '#f39c12' : '#e74c3c';
      
      reportDiv.innerHTML = `
        <div class="validation-result ${score >= 80 ? 'success' : score >= 60 ? 'warning' : 'error'}">
          <div style="text-align:center;margin-bottom:15px;">
            <strong style="color:var(--text-primary);font-size:1.2rem;">Data Quality Score</strong>
            <p style="margin:10px 0;font-size:2rem;color:${scoreColor};font-weight:bold;">${score || 0}%</p>
          </div>
          ${details ? `
            <div style="margin-top:15px;">
              ${Object.entries(details).map(([key, value]) => `
                <div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-primary);border-radius:4px;margin-bottom:5px;">
                  <span style="color:var(--text-secondary);">${escapeHtml(key)}:</span>
                  <strong style="color:var(--text-primary);">${escapeHtml(value)}</strong>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
    } else {
      handleApiError(r, 'validation_msg', 'Failed to generate quality report');
    }
  } catch(err){
    logError('getQualityReport', err);
    if(err.message && err.message.includes('404')){
      reportDiv.innerHTML = `
        <div class="validation-result error">
          <strong style="color:var(--text-primary);">‚ö†Ô∏è API Endpoint Not Implemented</strong>
          <p style="margin:5px 0 0 0;color:var(--text-secondary);font-size:0.9rem;">The endpoint <code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${API_VALIDATION}/quality-report</code> is not available yet.</p>
        </div>
      `;
    } else {
      reportDiv.innerHTML = '<div class="validation-result error"><strong>Error:</strong> ' + escapeHtml(err.message) + '</div>';
    }
  }
}

// ----- Initial load -----
loadDashboard();
</script>
</body>
</html>

